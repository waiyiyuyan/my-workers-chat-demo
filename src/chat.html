<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>Cloudflare Chatroom</title>
  <style>
    /* å…¨å±€é‡ç½® & iOSå­—ä½“ + å¾®ä¿¡é£æ ¼åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      background-color: #EDEDED;
      color: #333;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    /* å·¥å…·ç±» */
    .hide { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .flex-1 { flex: 1; }
    .text-center { text-align: center; }
    .text-green { color: #07C160 !important; }
    .bg-white { background-color: #fff; }
    .rounded-full { border-radius: 50%; }
    .clickable {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s ease;
    }
    .clickable:active { opacity: 0.8; }

    /* é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå¾®ä¿¡é£æ ¼ï¼šç™½è‰²èƒŒæ™¯ + åº•éƒ¨é»‘çº¿ï¼‰ */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background-color: #fff; /* å¾®ä¿¡é£æ ¼ç™½è‰²èƒŒæ™¯ */
      color: #000; /* é»‘è‰²æ–‡å­— */
      font-size: 18px;
      line-height: 60px;
      text-align: center;
      padding: 0 15px; /* è°ƒæ•´å†…è¾¹è· */
      z-index: 100;
      border-bottom: 1px solid #E5E5E5; /* åº•éƒ¨é»‘çº¿ */
    }
    
    /* å¯¼èˆªæ æŒ‰é’®ï¼šé»‘è‰²æ–‡å­— */
    .header-btn {
	  position: absolute;
	  top: 0;
	  height: 50px;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  color: #000;
	  font-size: 16px;
	  padding: 0;
	  border: none;
	  background: transparent;
	  /* æ ¸å¿ƒï¼šå›ºå®šæŒ‰é’®ç‚¹å‡»åŒºåŸŸï¼ŒåŒæ—¶åŠ å†…è¾¹è·é¿å…è´´è¾¹ */
	  width: auto; /* å–æ¶ˆå›ºå®šå®½åº¦ï¼Œé€‚é…å†…å®¹ */
	  padding: 0 15px; /* å·¦å³å†…è¾¹è·ï¼Œè¿œç¦»è¾¹ç¼˜ */
	  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}
	
    .header-btn.back-btn {
	  z-index: 101; /* ç¡®ä¿è¿”å›æŒ‰é’®åœ¨æœ€ä¸Šå±‚ */
	}
    .back-btn { left: 15px; }
    .share-btn {
	  right: 26px;
	  width: auto;
	  padding: 0 10px;
	  /* æ–°å¢ä»¥ä¸‹æ ·å¼ï¼Œå’Œå¯¼èˆªæ æ–‡å­—ç»Ÿä¸€ */
	  font-size: 16px; /* å’Œè¿”å›æŒ‰é’®å­—ä½“ä¸€è‡´ */
	  line-height: 44px; /* å’Œå¯¼èˆªæ é«˜åº¦ä¸€è‡´ï¼Œå‚ç›´å±…ä¸­ */
	  font-weight: 500; /* å»æ‰åŠ ç²—ï¼Œå’Œæ ‡é¢˜ç»Ÿä¸€ */
	  color: #000 !important; /* ç¡®ä¿æ˜¯çº¯é»‘ï¼Œå’Œè¿”å›æŒ‰é’®ä¸€è‡´ */
	}
    /* ç§»é™¤è¿æ¥çŠ¶æ€æ˜¾ç¤º */
    .connect-status { display: none !important; }

    /* ç™»å½•é¡µé¢ï¼ˆå¾®ä¿¡ç™»å½•é£æ ¼ï¼‰ */
    .login-page {
      position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  background-color: #EDEDED;
	  padding-top: 0; /* æŠŠä¹‹å‰çš„80pxæ”¹æˆ0 */
	  z-index: 110;
    }
    
    .login-container {
      width: 90%;
      max-width: 400px;
      margin: 0 auto;
	  height: calc(100vh - 120px); /* å æ»¡ç™»å½•é¡µå‰©ä½™é«˜åº¦ */
	  display: flex;
	  flex-direction: column;
	  justify-content: center; /* å‚ç›´å±…ä¸­ */
    }
    
    .input-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .input-underline {
      display: block;
      width: 100%;
      height: 45px;
      padding: 8px 0;
      border: none;
      border-bottom: 1px solid #D9D9D9;
      background-color: transparent;
      font-size: 16px;
      color: #333;
      outline: none;
    }
    
    .input-underline::placeholder {
      color: #999;
      font-size: 15px;
    }
    
    .input-underline:focus {
      border-bottom-color: #77cc00;
    }
    
    .enter-btn {
      display: block;
      width: 100%;
      height: 48px;
      line-height: 48px;
      background-color: #77cc00;
      color: #fff;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      border-radius: 2px;
      margin: 30px 0;
      box-shadow: 0 2px 8px rgba(7, 193, 96, 0.3);
      text-decoration: none;
	  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
    }
    
    .login-footer {
      position: fixed;
	  top: auto; /* è·ç¦»é¡¶éƒ¨70%é«˜åº¦ä½ç½®ï¼Œå¯æ”¹å…·ä½“åƒç´ å¦‚400px */
	  left: 0;
	  right: 0;
	  text-align: center;
	  font-size: 14px;
	  color: #999;
	  bottom: 40px; /* è¦†ç›–åŸæœ‰bottomå€¼ */
    }
    
    .login-footer a {
      color: #77cc00;
      text-decoration: none;
    }

    /* èŠå¤©é¡µé¢ */
	.chat-page {
	  position: fixed;
	  top: 50px;
	  left: 0;
	  right: 0;
	  bottom: 50px; /* ä¸è¾“å…¥æ æœ€å°é«˜åº¦ä¸€è‡´ */
	  background-color: #EDEDED;
	  z-index: 80;
	}
    
    .chatlog {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 10px 15px;
      -webkit-overflow-scrolling: touch;
    }
    
    .chatlog::-webkit-scrollbar {
      width: 0;
    }

    /* æ¶ˆæ¯æ ·å¼ï¼ˆå¾®ä¿¡ç»å…¸æ°”æ³¡ï¼šç§»é™¤å¤´åƒ + æ˜µç§°ä¸Šä¸‹ç»“æ„ï¼‰ */
    .msg {
      display: flex;
      margin-bottom: 12px;
      max-width: 100%;
      flex-direction: column; /* çºµå‘æ’åˆ—æ˜µç§°å’Œæ°”æ³¡ */
    }
    
    .msg-left { align-items: flex-start; margin-right: 20%; }
    .msg-right { align-items: flex-end; margin-left: 20%; }
    
    /* ç§»é™¤å¤´åƒæ ·å¼ */
    .msg-avatar { display: none !important; }
    
    .msg-content {
      max-width: 80%;
    }
    
    /* æ˜µç§°æ ·å¼ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¾ç¤ºæ˜µç§°ï¼ˆä¸Šä¸‹ç»“æ„ï¼‰ */
    .msg-name {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
      padding-left: 2px;
    }
    
    .msg-bubble {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      position: relative;
    }
    
    .msg-left .msg-bubble {
      background-color: #fff;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .msg-right .msg-bubble {
      background-color: #77cc00;
      color: #fff;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .msg-bubble a {
      color: #007AFF;
      text-decoration: underline;
      word-break: break-all;
    }
    
    .msg-right .msg-bubble a { color: #E5F8FF; }
    
    /* éšè—ç³»ç»Ÿæ¶ˆæ¯ï¼ˆè°åŠ å…¥/ç¦»å¼€æˆ¿é—´ï¼‰ */
    .system-msg { display: none !important; }

    /* å›¾ç‰‡æ¶ˆæ¯ï¼ˆç§»é™¤å¤´åƒ + æ˜µç§°ä¸Šä¸‹ç»“æ„ï¼‰ */
    .img-msg {
      display: flex;
      margin-bottom: 12px;
      max-width: 100%;
      flex-direction: column; /* çºµå‘æ’åˆ—æ˜µç§°å’Œå›¾ç‰‡ */
    }
    
    .img-msg-left { align-items: flex-start; margin-right: 20%; }
    .img-msg-right { align-items: flex-end; margin-left: 20%; }
    
    .img-content {
      max-width: 80%;
    }
    
    .img-name {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
      padding-left: 2px;
    }
    
    .img-bubble {
      width: 180px;
      height: 120px;
      border-radius: 8px;
      overflow: hidden;
      background-color: #E5E5E5;
      position: relative;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .img-loading, .img-error {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
    }
    
    .img-error svg {
      width: 40px;
      height: 40px;
      fill: #ccc;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .img-bubble img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* åº•éƒ¨è¾“å…¥æ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰ */
.input-bar {
  position: fixed;
  bottom: 0; /* æ”¹å›0ï¼Œé¿å…1pxé—´éš™ */
  left: 0;
  right: 0;
  height: auto;
  min-height: 50px;
  background-color: #fff;
  border-top: 1px solid #E5E5E5;
  padding: 7px 15px;
  display: flex;
  align-items: flex-end; /* æ‰€æœ‰å­å…ƒç´ åº•éƒ¨å¯¹é½ */
  justify-content: flex-start; /* å·¦å¯¹é½ */
  z-index: 90;
}
    
    
.input-tools {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px; /* ä¸å‘é€æŒ‰é’®/è¾“å…¥æ¡†åŒé«˜ */
  margin-right: 10px;
  flex-shrink: 0;
}
    
	.tool-btn {
	  width: 100%;
	  height: 100%;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  color: #07C160;
	  font-size: 28px;
	  border-radius: 2px;
	  -webkit-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	  background-color: #fff; /* ä¸è¾“å…¥æ¡†èƒŒæ™¯ä¸€è‡´ */
	  
	}
    
    .tool-btn:active {
      background-color: #E5E5E5;
    }
    
.chat-input {
  flex: 1;
  min-height: 36px;
  max-height: 120px;
  padding: 8px 12px;
  background-color: #fff;
  border-radius: 2px;
  border: 1px solid #E5E5E5;
  outline: none;
  font-size: 15px;
  line-height: 22px;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #E5E5E5 #fff;
  display: block;
  box-sizing: border-box;
  /* å…³é”®ï¼šå›ºå®šåº•éƒ¨ï¼Œä»…å‘ä¸Šæ‰©å±• */
  align-self: flex-end;
  vertical-align: bottom;
}

.chat-input br {
  display: block;
}
.chat-input:not(:empty) br {
  display: block;
  content: "";
  margin-top: 22px; /* ä¸è¡Œé«˜ä¸€è‡´ï¼Œæ¨¡æ‹Ÿæ¢è¡Œé—´è· */
}
.chat-input:empty:before {
  content: attr(placeholder);
  color: #999;
  position: absolute;
  top: 8px;
  left: 12px;
  pointer-events: none;
  content: "" !important; /* å½»åº•æ¸…ç©ºæç¤ºæ–‡æœ¬ */
  
}

.chat-input::-webkit-scrollbar {
  width: 4px;
}
    
.chat-input:focus {
	border-width: 1px !important; /* ç¡®ä¿è¾¹æ¡†å®½åº¦ä¸å˜ */
}
	.send-btn {
	  width: 60px;
	  height: 36px; /* ä¸è¾“å…¥æ¡†ç­‰é«˜ */
	  line-height: 36px;
	  text-align: center;
	  background-color: #77cc00;
	  color: #fff;
	  border-radius: 2px;
	  font-size: 15px;
	  font-weight: 500;
	  margin-left: 10px;
	  flex-shrink: 0; /* ä¸å‹ç¼© */
	  align-self: flex-end; /* ä¸è¾“å…¥æ¡†åº•éƒ¨å¯¹é½ */
	  -webkit-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}
    
    .send-btn.disabled {
      background-color: #999;
      pointer-events: none;
      opacity: 0.5;
    }

    /* ç”¨æˆ·åˆ—è¡¨é¡µé¢ */
    .user-list-page {
	  position: fixed;
	  top: 50px; /* å¯¼èˆªæ é«˜åº¦æ˜¯44pxï¼Œè¿™ä¸ªå€¼å¿…é¡»å’Œå¯¼èˆªæ é«˜åº¦ä¸€è‡´ï¼Œç´§è´´å¯¼èˆªæ åº•éƒ¨ */
	  left: 0;
	  right: 0;
	  bottom: 0;
	  background-color: #EDEDED;
	  z-index: 85;
	  /* ç§»é™¤å¯èƒ½å¯¼è‡´é—´è·çš„æ ·å¼ï¼ˆå…³é”®ï¼‰ */
	  margin-top: 0;
	  padding-top: 0;
	}
    
    /* éšè—ç”¨æˆ·åˆ—è¡¨é¡¶éƒ¨çš„æˆ¿é—´ä¿¡æ¯ */
    .user-list-header { display: none !important; }
    
    .user-list {
      list-style: none;
      background-color: #fff;
    }
    
    .user-item {
	  display: flex;
	  align-items: center; /* å‚ç›´å±…ä¸­ */
	  padding: 12px 15px;
	  border-bottom: 1px solid #E5E5E5;
	  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}

    
    .user-item:active {
      background-color: #E5E5E5;
    }
    
    /* ç§»é™¤ç”¨æˆ·åˆ—è¡¨å¤´åƒ */
    .user-avatar {
	  width: 36px;
	  height: 36px;
	  border-radius: 50%;
	  overflow: hidden;
	  position: relative;
	  margin-right: 12px;
	}
	.user-avatar svg {
	  width: 100%;
	  height: 150%; /* æ‹‰ä¼¸é«˜åº¦ */
	  position: absolute;
	  top: -25%; /* å‘ä¸Šåç§»ï¼Œéšè—é¡¶éƒ¨åœ†å½¢ */
	  left: 0;
	  fill: #07C160; /* äººå½¢é¢œè‰² */
	}
	.user-avatar svg path {
	  fill: black; /* æˆ– #000ã€#333ï¼ˆæ·±ç°ï¼‰ç­‰ */
	}
    .user-name {
      font-size: 16px;
      color: #333;
      
    }
    
    /* åº•éƒ¨é€‰é¡¹å¡ï¼ˆå¾®ä¿¡é£æ ¼ï¼šé»‘è‰²æ–‡å­— + é—´éš™åˆ†éš”ï¼‰ */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 50px;
  background-color: #fff;
  border-top: 1px solid #E5E5E5;
  display: flex;
  z-index: 95;
}
    
.tab-item {
  /* æ›¿æ¢åŸæœ‰çš„ flex: 1; ä¸ºä»¥ä¸‹ä¸¤è¡Œ */
  flex: 0 0 50%; /* å›ºå®š50%å®½åº¦ï¼Œä¸æ‹‰ä¼¸/å‹ç¼© */
  max-width: 50%; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æº¢å‡º */
  
  /* ä»¥ä¸‹åŸæœ‰æ ·å¼å…¨éƒ¨ä¿ç•™ */
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center; /* æ–‡å­—æ°´å¹³å±…ä¸­ */
  font-size: 16px;
  color: #000 !important; /* ç»Ÿä¸€çº¯é»‘ */
  font-weight: 500;
  position: relative;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.1s ease;
  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.tab-item:active {
  opacity: 0.8;
  background-color: #f5f5f5;
  border-radius: 4px;
}
.decorative-tab::after {
  content: "";                /* ç”Ÿæˆä¼ªå…ƒç´  */
  position: absolute;         /* ç»å¯¹å®šä½ */
  right: 0;                   /* å¡åœ¨ç”¨æˆ·é€‰é¡¹å¡æœ€å³ä¾§ï¼ˆä¸¤é€‰é¡¹å¡ä¸­é—´ï¼‰ */
  top: 0;                     /* é¡¶éƒ¨å¯¹é½ */
  height: 100%;               /* è´¯ç©¿æ•´ä¸ªé«˜åº¦ */
  width: 2px;                 /* ç«–çº¿å®½åº¦ */
  background-color: #E5E5E5;  /* åˆ†éš”çº¿é¢œè‰²ï¼ˆå’Œé¡¶éƒ¨è¾¹æ¡†ä¸€è‡´ï¼‰ */
}
.decorative-tab:active {
  opacity: 0.8;
  background-color: #f5f5f5;
  border-radius: 4px;
}
.tab-divider { display: none !important; }


    /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 480px) {
	  .tab-item {
		font-size: 14px;	
	  }
	  /* ç§»åŠ¨ç«¯å›¾ç‰‡æŒ‰é’®é€‚é… */
	   .input-tools {
			width: 55px; /* æ”¹ä¸ºç§»åŠ¨ç«¯å‘é€æŒ‰é’®åŒæ¬¾å®½åº¦ï¼ˆåŸ55pxï¼Œæ— éœ€æ”¹ï¼Œç¡®è®¤å³å¯ï¼‰ */
			height: 34px; /* ä¿æŒå’Œç§»åŠ¨ç«¯å‘é€æŒ‰é’®åŒæ¬¾é«˜åº¦ */
		  }
		  /* ç§»åŠ¨ç«¯å›¾ç‰‡æŒ‰é’®ï¼šåŒæ­¥æ”¾å¤§å›¾æ ‡ */
		  .tool-btn {
			font-size: 26px; /* ç§»åŠ¨ç«¯å›¾æ ‡ç¨å°ä¸€ç‚¹ï¼Œé€‚é…55pxÃ—34pxå®¹å™¨ */
		  }

	  .send-btn { 
		width: 55px; 
		height: 34px; 
		line-height: 34px; 
		font-size: 14px; 
	  }
    }

  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªï¼šå¾®ä¿¡é£æ ¼ + ä»…æ˜¾ç¤ºæ ‡é¢˜/è¿”å›/åˆ†äº« -->
  <div class="header">
    <div class="header-btn back-btn clickable hide">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 14.5L7.5 10L12 5.5" stroke="#000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
    <div class="header-btn share-btn clickable hide">åˆ†äº«èŠå¤©å®¤</div>
    <span class="connect-status hide">æœªè¿æ¥</span>
  </div>

  <!-- ç™»å½•é¡µé¢ -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
		<div class="login-logo" style="text-align: center; margin-bottom: 30px;">
		<!-- ç²˜è´´ä¼˜åŒ–åçš„ SVG Logo ä»£ç  -->
		<svg width="196" height="40" viewBox="0 0 196 40" fill="none" xmlns="http://www.w3.org/2000/svg">
		  <text x="70" y="28" 
				font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
				font-size="24" 
				font-weight="600" 
				text-anchor="middle">
			<tspan fill="#77cc00">CF</tspan>
			<tspan fill="#333333" y="28" dx="5">Chat</tspan>
		  </text>
		</svg>
	  </div>
      <div class="input-item">
        <input type="text" id="nameInput" class="input-underline" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" autocomplete="off">
      </div>
	  
	  <a href="javascript:void(0)" class="enter-btn clickable" id="enterBtn">è¿›å…¥æˆ¿é—´</a>
    </div>
    <div class="login-footer">
      åŸºäº Cloudflare Workers æ„å»º<br>
      <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">äº†è§£æ›´å¤š</a>
    </div>
  </div>

  <!-- èŠå¤©é¡µé¢ -->
  <div class="chat-page hide" id="chatPage">
    <div class="chatlog" id="chatlog"></div>
    <div class="input-bar">
      <div class="input-tools">
        <label for="imageUpload" class="tool-btn clickable">ğŸ“·</label>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
      </div>
      <div id="chatInput" class="chat-input" contenteditable="true"></div>
      <div class="send-btn clickable" id="sendBtn">å‘é€</div>
    </div>
  </div>

  <!-- ç”¨æˆ·åˆ—è¡¨é¡µé¢ -->
  <div class="user-list-page hide" id="userListPage">
    <div class="user-list-header" id="roomStatus">å½“å‰æˆ¿é—´ï¼šæš‚æ— ç”¨æˆ·</div>
    <ul class="user-list" id="userList"></ul>
    <div class="tab-bar">
      <div class="tab-item decorative-tab" id="tabUser">
        ç”¨æˆ·
      </div>
      <div class="tab-item clickable" id="tabChat">
        èŠå¤©
      </div>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒé…ç½®
    const CONFIG = {
      MAX_RECONNECT: 3,
      RECONNECT_INTERVAL: 3000,
      HEARTBEAT_INTERVAL: 10000,
      IMGBB_API_KEY: "151fe87bf32e4e7837d1d4174d36b164",
      MAX_IMG_SIZE: 10 * 1024 * 1024 // 10MB
    };

    // å…¨å±€çŠ¶æ€
    const state = {
	  ws: null,
	  username: "",
	  roomname: "",
	  onlineUsers: [],
	  isReconnecting: false,
	  reconnectCount: 0,
	  heartbeatTimer: null,
	  reconnectTimer: null,
	  isAtBottom: true,
	  renderedMessages: new Map(), // 1. Set â†’ Mapï¼ˆå­˜å‚¨{æ¶ˆæ¯ID: å‘é€è€…}ï¼‰
	  sentImageIds: new Set(),
	  clientId: Math.random().toString(36).slice(2, 15) + Date.now(), // 2. æ–°å¢å®¢æˆ·ç«¯å”¯ä¸€IDï¼ˆåŠ æ—¶é—´æˆ³æ›´å”¯ä¸€ï¼‰
	  messageQueue: [], // æ–°å¢ï¼šæ¶ˆæ¯å‘é€é˜Ÿåˆ—
	  isSending: false, // æ–°å¢ï¼šæ˜¯å¦æ­£åœ¨å‘é€
	  sendThrottleTimer: null // æ–°å¢ï¼šèŠ‚æµå®šæ—¶å™¨
	};

    // DOM å…ƒç´ 
    const els = {
      loginPage: document.getElementById('loginPage'),
      chatPage: document.getElementById('chatPage'),
      userListPage: document.getElementById('userListPage'),
      nameInput: document.getElementById('nameInput'),
      // roomInput: document.getElementById('roomInput'),
      enterBtn: document.getElementById('enterBtn'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      chatlog: document.getElementById('chatlog'),
      imageUpload: document.getElementById('imageUpload'),
      userList: document.getElementById('userList'),
      roomStatus: document.getElementById('roomStatus'),
      roomTitle: document.getElementById('room-title'),
      connectStatus: document.querySelector('.connect-status'),
      backBtn: document.querySelector('.back-btn'),
      shareBtn: document.querySelector('.share-btn'),
      tabUser: document.getElementById('tabUser'),
      tabChat: document.getElementById('tabChat'),
      tabItems: document.querySelectorAll('.tab-item')
    };

    // ========== å·¥å…·å‡½æ•° ==========
    /**
     * æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬ï¼ˆå¤„ç†é“¾æ¥ï¼‰
     */
    function formatMessage(text) {
      if (!text) return '';
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text
        .replace(/\n/g, '<br>')
        .replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }
	function getUniqueMsgId(msg) {
  // å…œåº•ç©ºå¯¹è±¡
	  const safeMsg = msg || {};
	  // æ‰€æœ‰å­—æ®µå¼ºåˆ¶å…œåº•
	  const name = safeMsg.name || "æœªçŸ¥ç”¨æˆ·";
	  const timestamp = safeMsg.timestamp || Date.now();
	  const content = safeMsg.message || "";
	  const contentHash = content ? btoa(unescape(encodeURIComponent(content.substring(0, 20)))) : "empty";
	  
	  return `${name}_${timestamp}_${contentHash}`;
	}
		
	function adjustHeight() {
	  els.chatInput.style.height = 'auto';
	  const newHeight = Math.min(els.chatInput.scrollHeight, 120);
	  els.chatInput.style.height = newHeight + 'px';
	  
	  if (els.chatInput.scrollHeight > els.chatInput.clientHeight) {
		els.chatInput.scrollTop = els.chatInput.scrollHeight;
	  }
	}
    /**
     * æ˜¾ç¤º/éšè—å…ƒç´ 
     */
    function toggleElement(el, show) {
      el.classList[show ? 'remove' : 'add']('hide');
    }

    /**
     * åˆ‡æ¢é€‰é¡¹å¡
     */
    function activateTab(tab) {
      els.tabItems.forEach(item => item.classList.remove('active'));
      tab.classList.add('active');
    }

    /**
     * è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
     */
    /**
 * è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦ï¼ˆç²¾å‡†ç‰ˆï¼‰
 * è§£å†³ï¼šè¾“å…¥å­—ç¬¦ç¬é—´å¢é«˜ã€æ¸…ç©ºä¸æ¢å¤ã€ç©º/å•è¡Œä¸æ»šåŠ¨
 */


    // ========== æ¶ˆæ¯æ¸²æŸ“ ==========
    /**
     * æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå·²éšè—ï¼Œç©ºå®ç°ï¼‰
     */
    function addSystemMessage(text) {
      // ç©ºå®ç°ï¼šéšè—è°åŠ å…¥/ç¦»å¼€æˆ¿é—´çš„æç¤º
    }

    /**
     * æ·»åŠ æ–‡å­—æ¶ˆæ¯ï¼ˆç§»é™¤å¤´åƒ + æ˜¾ç¤ºæ˜µç§° + ä¿®å¤é‡å¤å‘é€ï¼‰
     */
    function addTextMessage(name, content, isSelf) {
      if (!content || content.trim() === '') return;
	  /*
	  const msgData = { name, message: content, timestamp: Date.now() };
	  const msgId = getUniqueMsgId(msgData);
      if (state.renderedMessages.has(msgId)) return;
      state.renderedMessages.set(msgId);
		*/
      const msgDiv = document.createElement('div');
      msgDiv.className = `msg ${isSelf ? 'msg-right' : 'msg-left'}`;
      
      // æ¶ˆæ¯å†…å®¹
      const contentDiv = document.createElement('div');
      contentDiv.className = 'msg-content';
      
      // æ˜µç§°ï¼ˆæ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¾ç¤ºï¼‰
	  /*
      const nameSpan = document.createElement('div');
      nameSpan.className = 'msg-name';
      nameSpan.textContent = name;
      contentDiv.appendChild(nameSpan);
      */
      // æ¶ˆæ¯æ°”æ³¡
      const bubble = document.createElement('div');
      bubble.className = 'msg-bubble';
      bubble.innerHTML = formatMessage(content);
      contentDiv.appendChild(bubble);
      
      // ç»„è£…ï¼ˆæ— å¤´åƒï¼‰
      msgDiv.appendChild(contentDiv);
      
      els.chatlog.appendChild(msgDiv);
      scrollToBottom();
    }

    /**
     * æ·»åŠ å›¾ç‰‡æ¶ˆæ¯ï¼ˆç§»é™¤å¤´åƒ + æ˜¾ç¤ºæ˜µç§°ï¼‰
     */
    function addImageMessage(name, url, isSelf, imgId = '') {
      const msgDiv = document.createElement('div');
      msgDiv.className = `img-msg ${isSelf ? 'img-msg-right' : 'img-msg-left'}`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'img-content';
      
      // æ˜µç§°
	  /*
      const nameSpan = document.createElement('div');
      nameSpan.className = 'img-name';
      nameSpan.textContent = name;
      contentDiv.appendChild(nameSpan);
      */
      // å›¾ç‰‡å®¹å™¨
      const imgBubble = document.createElement('div');
      imgBubble.className = 'img-bubble';
      imgBubble.dataset.id = imgId;
      
      if (url) {
        // åŠ è½½å›¾ç‰‡
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          imgBubble.innerHTML = `<img src="${url}" onclick="window.open('${url}', '_blank')">`;
        };
        img.onerror = () => {
          imgBubble.innerHTML = `
            <div class="img-error">
              <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><path d="M12 10l-2 2 2 2 2-2-2-2zm0-6v2h2V4h-2zm0 12v2h2v-2h-2z"/></svg>
              <span>å›¾ç‰‡åŠ è½½å¤±è´¥</span>
            </div>
          `;
        };
        img.src = url;
      } else {
        // åŠ è½½ä¸­
        imgBubble.innerHTML = '<div class="img-loading">å›¾ç‰‡ä¸Šä¼ ä¸­...</div>';
      }
      
      contentDiv.appendChild(imgBubble);
      msgDiv.appendChild(contentDiv);
      els.chatlog.appendChild(msgDiv);
      scrollToBottom();
    }

    /**
     * æ»šåŠ¨åˆ°åº•éƒ¨
     */
    function scrollToBottom() {
      if (state.isAtBottom) {
        els.chatlog.scrollTop = els.chatlog.scrollHeight;
      }
    }

    // ========== ç”¨æˆ·åˆ—è¡¨ ==========
    /**
     * æ›´æ–°ç”¨æˆ·åˆ—è¡¨
     */
function updateUserList() {
  els.userList.innerHTML = '';
  
  // æ— åœ¨çº¿ç”¨æˆ·æ—¶çš„æ¸²æŸ“
  if (state.onlineUsers.length === 0) {
    const emptyItem = document.createElement('li');
    emptyItem.className = 'user-item';
    // æ›¿æ¢ä¸ºä½ çš„é»‘è‰²äººå½¢SVG
    emptyItem.innerHTML = `
      <div class="user-avatar">
        <svg width="512px" height="512px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
          <title>ionicons-v5-j</title>
          <path d="M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z"/>
          <path d="M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z" fill="black"/>
        </svg>
      </div>
      <div class="user-name">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
    `;
    els.userList.appendChild(emptyItem);
    return;
  }
  
  // æœ‰åœ¨çº¿ç”¨æˆ·æ—¶çš„æ¸²æŸ“
  state.onlineUsers.forEach(user => {
    const item = document.createElement('li');
    item.className = 'user-item';
    // æ›¿æ¢ä¸ºä½ çš„é»‘è‰²äººå½¢SVG
    item.innerHTML = `
      <div class="user-avatar">
        <svg width="512px" height="512px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
          <title>ionicons-v5-j</title>
          <path d="M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z"/>
          <path d="M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z" fill="black"/>
        </svg>
      </div>
      <div class="user-name">${user}</div>
    `;
    els.userList.appendChild(item);
  });
}

    // ========== å›¾ç‰‡ä¸Šä¼  ==========
    /**
     * ä¸Šä¼ å›¾ç‰‡åˆ°ImgBB
     */
    async function uploadImage(file) {
      if (!file.type.startsWith('image/')) {
        throw new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
      }
      
      if (file.size > CONFIG.MAX_IMG_SIZE) {
        throw new Error(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡${CONFIG.MAX_IMG_SIZE/1024/1024}MB`);
      }
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('expiration', '86400'); // 24å°æ—¶è¿‡æœŸ
      
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, {
        method: 'POST',
        body: formData,
        timeout: 30000
      });
      
      if (!response.ok) {
        throw new Error(`ä¸Šä¼ å¤±è´¥ï¼š${response.status}`);
      }
      
      const data = await response.json();
      if (data.success && data.data?.url) {
        return data.data.url;
      }
      
      throw new Error(data.error?.message || 'ä¸Šä¼ å¤±è´¥');
    }

    // ========== WebSocket å¤„ç† ==========
    /**
     * å»ºç«‹WebSocketè¿æ¥
     */
    function connectWS() {
      // æ¸…ç†æ—§è¿æ¥
      if (state.ws) {
        try { state.ws.close(); } catch (e) {}
        state.ws = null;
      }
      
      // æ„å»ºWS URL
      const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = `${protocol}${location.host}/api/room/${state.roomname}/websocket`;
      
      try {
        const ws = new WebSocket(wsUrl);
        state.ws = ws;
        
        // è¿æ¥æˆåŠŸ
        ws.onopen = () => {
		  state.isReconnecting = false;
		  state.reconnectCount = 0;
		  
		  // å‘é€åŠ å…¥æ¶ˆæ¯
		  ws.send(JSON.stringify({
			type: 'join',
			name: state.username
		  }));
		  
		  // ä¸»åŠ¨è¯·æ±‚ç”¨æˆ·åˆ—è¡¨ï¼ˆå…³é”®è¡¥å……ï¼‰
		  setTimeout(() => {
			ws.send(JSON.stringify({ type: 'getUsers' }));
		  }, 500);
		  
		  // å¯åŠ¨å¿ƒè·³
		  startHeartbeat();
		  
		  // è¯·æ±‚å†å²æ¶ˆæ¯
		  setTimeout(() => {
			ws.send(JSON.stringify({ type: 'getHistory' }));
		  }, 1000);
		  
		  processMessageQueue();
		};
        
        // æ¥æ”¶æ¶ˆæ¯
        ws.onmessage = (e) => {
          resetHeartbeat();
          handleMessage(e.data);
        };
        
        // è¿æ¥å…³é—­
        ws.onclose = (e) => {
          stopHeartbeat();
          
          // éœ€è¦é‡è¿
          if (![1001, 1005].includes(e.code) && !state.isReconnecting) {
            state.isReconnecting = true;
            state.reconnectCount++;
            
            if (state.reconnectCount > CONFIG.MAX_RECONNECT) {
              state.isReconnecting = false;
              return;
            }
            
            state.reconnectTimer = setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
          }
        };
        
        // è¿æ¥é”™è¯¯
        ws.onerror = (e) => {
          stopHeartbeat();
          if (!state.isReconnecting) {
            setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
          }
        };
        
      } catch (e) {
        if (!state.isReconnecting) {
          setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
        }
      }
    }

    /**
     * å¤„ç†WebSocketæ¶ˆæ¯ï¼ˆä¿®å¤é‡å¤æ¶ˆæ¯ + éšè—ç³»ç»Ÿæç¤ºï¼‰
     */
    function handleMessage(rawData) {
	  try {
		const data = JSON.parse(rawData);
		console.log('æ”¶åˆ°æœåŠ¡ç«¯æ¶ˆæ¯:', data);

		// 1. æŒ‰ç±»å‹åˆ†æµï¼šåªå¤„ç†èŠå¤©/å†å²æ¶ˆæ¯ï¼Œå¿½ç•¥ç³»ç»Ÿ/å¿ƒè·³æ¶ˆæ¯
		switch(data.type) {
		  case 'heartbeat':
		  case 'system': // ç³»ç»Ÿæ¶ˆæ¯ï¼ˆjoined/quit/onlineUsersï¼‰åªæ›´æ–°ç”¨æˆ·åˆ—è¡¨ï¼Œä¸æ¸²æŸ“
			if (data.onlineUsers) {
			  state.onlineUsers = Array.isArray(data.onlineUsers) ? data.onlineUsers.filter(u => !!u) : [];
			  updateUserList();
			}
			return;
		  case 'error': // é”™è¯¯æ¶ˆæ¯ç›´æ¥å¿½ç•¥
			console.error('æœåŠ¡ç«¯é”™è¯¯:', data.error);
			return;
		  case 'history': // å†å²æ¶ˆæ¯å•ç‹¬å¤„ç†
			if (data.history && Array.isArray(data.history)) {
			  data.history.forEach(msg => {
				// æœ€ç»ˆå…œåº•ï¼šæ‰€æœ‰å­—æ®µå¼ºåˆ¶éç©º
				const safeMsg = {
				  name: msg.name || "æœªçŸ¥ç”¨æˆ·",
				  message: msg.message || "",
				  timestamp: msg.timestamp || Date.now(),
				  // isImage: !!msg.isImage,
				  isImage: !!msg.isImage || /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(msg.message),
				  clientId: msg.clientId || "",
				  messageId: msg.messageId || ""
				};

				// è·³è¿‡ç©ºæ¶ˆæ¯
				// if (!safeMsg.message.trim()) return;
				if (!safeMsg.message.trim() || !msg.type) return;

				const msgId = getUniqueMsgId(safeMsg);
				if (!msgId || state.renderedMessages.has(msgId)) return;

				state.renderedMessages.set(msgId, safeMsg.clientId);
				const isSelf = safeMsg.name === state.username;
				
				if (safeMsg.isImage) {
				  addImageMessage(safeMsg.name, safeMsg.message, isSelf);
				} else {
				  addTextMessage(safeMsg.name, safeMsg.message, isSelf);
				}
			  });
			}
			return;
		  case 'chat': // å®æ—¶èŠå¤©æ¶ˆæ¯
			break;
		  default: // æœªçŸ¥ç±»å‹ç›´æ¥å¿½ç•¥
			return;
		}

		// 2. å¤„ç†å®æ—¶èŠå¤©æ¶ˆæ¯ï¼ˆå·²æ ‡è®°ä¸ºchatç±»å‹ï¼‰
		// æœ€ç»ˆå…œåº•ï¼šæ‰€æœ‰å­—æ®µéç©º
		const safeData = {
		  name: data.name || "æœªçŸ¥ç”¨æˆ·",
		  message: data.message || "",
		  timestamp: data.timestamp || Date.now(),
		  isImage: !!data.isImage,
		  clientId: data.clientId || "",
		  messageId: data.messageId || ""
		};

		// è·³è¿‡ç©ºæ¶ˆæ¯
		if (!safeData.message.trim()) return;

		const msgId = getUniqueMsgId(safeData);
		if (!msgId || state.renderedMessages.has(msgId) || safeData.clientId === state.clientId) return;

		state.renderedMessages.set(msgId, safeData.clientId);
		const isSelf = safeData.name === state.username;
		
		if (safeData.isImage) {
		  addImageMessage(safeData.name, safeData.message, isSelf);
		} else {
		  addTextMessage(safeData.name, safeData.message, isSelf);
		}

	  } catch (e) {
		console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e, rawData);
	  }
	}

    /**
     * å¯åŠ¨å¿ƒè·³
     */
    function startHeartbeat() {
      stopHeartbeat();
      state.heartbeatTimer = setInterval(() => {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) {
          state.ws.send(JSON.stringify({ type: 'heartbeat', time: Date.now() }));
        }
      }, CONFIG.HEARTBEAT_INTERVAL);
    }

    /**
     * åœæ­¢å¿ƒè·³
     */
    function stopHeartbeat() {
      if (state.heartbeatTimer) {
        clearInterval(state.heartbeatTimer);
        state.heartbeatTimer = null;
      }
    }

    /**
     * é‡ç½®å¿ƒè·³
     */
    function resetHeartbeat() {
      stopHeartbeat();
      startHeartbeat();
    }

    // ========== äº‹ä»¶å¤„ç† ==========
    /**
     * å‘é€æ¶ˆæ¯ï¼ˆä¿®å¤é‡å¤å‘é€bugï¼‰
     */
	// 1. å‘é€æ¶ˆæ¯æ—¶è·å– div å†…å®¹
	function sendMessage() {
	  const content = els.chatInput.innerText.trim();
	  if (!content || !state.ws || state.ws.readyState !== WebSocket.OPEN) return;
	  // èŠ‚æµï¼š500mså†…ç¦æ­¢é‡å¤å‘é€
	  if (state.sendThrottleTimer) return;
	  state.sendThrottleTimer = setTimeout(() => {
		state.sendThrottleTimer = null;
	  }, 500);
		// ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯IDï¼ˆé¿å…æœåŠ¡ç«¯æ¼æ”¶ï¼‰
	  const msgUniqueId = `${state.clientId}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
	  // 1. ç”Ÿæˆæ¶ˆæ¯ä½“ï¼ˆæºå¸¦å®¢æˆ·ç«¯IDï¼‰
	  const msgData = {
		message: content,
		name: state.username,
		timestamp: Date.now(),
		clientId: state.clientId // æ ‡è®°æ˜¯å½“å‰å®¢æˆ·ç«¯å‘é€çš„
	  };
	  // 2. ç”Ÿæˆå”¯ä¸€IDå¹¶æ ‡è®°ä¸ºå·²æ¸²æŸ“ï¼ˆæœ¬åœ°å…ˆæ ‡è®°ï¼Œé¿å…æœåŠ¡ç«¯è¿”å›åé‡å¤ï¼‰
	  const msgId = getUniqueMsgId(msgData);
	  state.renderedMessages.set(msgId, state.clientId);
		// åŠ å…¥å‘é€é˜Ÿåˆ—
	  state.messageQueue.push(msgData);
	  // 3. å…ˆæœ¬åœ°æ¸²æŸ“ï¼ˆç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ°ï¼‰
	  addTextMessage(state.username, content, true);
	 
	  // 4. å‘é€åˆ°æœåŠ¡ç«¯
	  // state.ws.send(JSON.stringify(msgData));
	  // å…³é”®ä¿®å¤ï¼šè§¦å‘é˜Ÿåˆ—å‘é€ï¼ˆä¹‹å‰ç¼ºå¤±è¿™è¡Œï¼‰
		processMessageQueue();
	  // 5. æ¸…ç©ºè¾“å…¥æ¡†
	  els.chatInput.innerText = '';
	  adjustHeight(); // é‡ç½®è¾“å…¥æ¡†é«˜åº¦
	}


	function processMessageQueue() {
	  if (state.isSending || state.messageQueue.length === 0) return;

	  state.isSending = true;
	  const currentMsg = state.messageQueue.shift();

	  try {
	    console.log('å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯:', currentMsg);
		state.ws.send(JSON.stringify(currentMsg));

		// æ£€æŸ¥å‘é€çŠ¶æ€
		const checkSendStatus = () => {
		  if (state.ws.bufferedAmount === 0) {
			state.isSending = false;
			processMessageQueue();
		  } else {
			setTimeout(checkSendStatus, 50);
		  }
		};
		checkSendStatus();

	  } catch (e) {
		console.error('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œç¨åé‡è¯•:', e);
		state.messageQueue.unshift(currentMsg);
		state.isSending = false;
		setTimeout(processMessageQueue, 2000);
	  }
	}

    /**
     * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
     */
   async function handleImageUpload(e) {
	  const file = e.target.files[0];
	  if (!file) return;
	  
	  // ç”Ÿæˆå›¾ç‰‡ID
	  const imgId = `img_${Date.now()}`;
	  state.sentImageIds.add(imgId);
	  
	  // æ˜¾ç¤ºä¸Šä¼ ä¸­ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
	  addImageMessage(state.username, '', true, imgId);
	  
	  try {
		// ä¸Šä¼ å›¾ç‰‡ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
		const imgUrl = await uploadImage(file);
		
		// ========== æ”¹åŠ¨éƒ¨åˆ†å¼€å§‹ ==========
		// åŸï¼šç›´æ¥é€šè¿‡ ws.send å‘é€
		// æ–°ï¼šå°è£…æ¶ˆæ¯ä½“ â†’ åŠ å…¥é˜Ÿåˆ— â†’ è§¦å‘é˜Ÿåˆ—å‘é€ï¼ˆå’Œæ–‡å­—æ¶ˆæ¯é€»è¾‘ç»Ÿä¸€ï¼‰
		if (state.ws && state.ws.readyState === WebSocket.OPEN) {
		  // å°è£…å›¾ç‰‡æ¶ˆæ¯ä½“ï¼ˆè¡¥å…… clientId/messageIdï¼Œå’Œæ–‡å­—æ¶ˆæ¯æ ¼å¼å¯¹é½ï¼‰
		  const imgMsgData = {
			messageId: `${state.clientId}_${Date.now()}_img_${imgId}`, // å…¨å±€å”¯ä¸€ID
			message: imgUrl,
			name: state.username,
			isImage: true,
			msgId: imgId,
			timestamp: Date.now(),
			clientId: state.clientId // æ ‡è®°å‘é€æ–¹ï¼Œé¿å…è‡ªå·±é‡å¤æ¸²æŸ“
		  };
		  // åŠ å…¥å‘é€é˜Ÿåˆ—
		  state.messageQueue.push(imgMsgData);
		  // è§¦å‘é˜Ÿåˆ—å¤„ç†ï¼ˆæ ¸å¿ƒï¼šå’Œæ–‡å­—æ¶ˆæ¯ä¸€æ ·èµ°é˜Ÿåˆ—ï¼‰
		  processMessageQueue();
		}
		// ========== æ”¹åŠ¨éƒ¨åˆ†ç»“æŸ ==========
		
		// æ›´æ–°å›¾ç‰‡æ˜¾ç¤ºï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
		const imgBubble = document.querySelector(`.img-bubble[data-id="${imgId}"]`);
		if (imgBubble) {
		  const img = new Image();
		  img.onload = () => {
			imgBubble.innerHTML = `<img src="${imgUrl}" onclick="window.open('${imgUrl}', '_blank')">`;
		  };
		  img.src = imgUrl;
		}
		
	  } catch (e) {
		// æ˜¾ç¤ºé”™è¯¯ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
		const imgBubble = document.querySelector(`.img-bubble[data-id="${imgId}"]`);
		if (imgBubble) {
		  imgBubble.innerHTML = `
			<div class="img-error">
			  <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/><path d="M12 10l-2 2 2 2 2-2-2-2zm0-6v2h2V4h-2zm0 12v2h2v-2h-2z"/></svg>
			  <span>${e.message}</span>
			</div>
		  `;
		}
		console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', e);
	  } finally {
		// æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
		els.imageUpload.value = '';
	  }
	}

    /**
     * è¿›å…¥ç§äººæˆ¿é—´
     */
	 async function enterRoom() {
	  const username = els.nameInput.value.trim();
	  
	  // ä»…æ ¡éªŒæ˜µç§°
	  if (!username) {
		els.nameInput.focus();
		return;
	  }
	  
	  let targetRoomId = '';
	  if (location.hash) {
		targetRoomId = location.hash.slice(1).trim(); // å»æ‰ # å·
		// æ ¡éªŒæ˜¯å¦ä¸º 64 ä½ç§äººæˆ¿é—´ ID
		if (targetRoomId.length === 64 && /^[a-f0-9]+$/i.test(targetRoomId)) {
		  // ç›´æ¥åŠ å…¥å·²æœ‰æˆ¿é—´ï¼Œä¸åˆ›å»ºæ–°æˆ¿é—´
		  joinExistingRoom(username, targetRoomId);
		  return; // ç»ˆæ­¢åç»­åˆ›å»ºé€»è¾‘
		}
	  }

	  // è°ƒç”¨åç«¯æ¥å£ç”Ÿæˆç§äººæˆ¿é—´ID
	  try {
		// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
		els.enterBtn.textContent = "åŠ è½½ä¸­...";
		els.enterBtn.style.pointerEvents = "none";
		
		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 30000); // 10ç§’è¶…æ—¶
		// è°ƒç”¨/api/room POSTæ¥å£
		/*
		const response = await fetch(`https://${location.host}/api/room`, {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json"
		  },
		  timeout: 10000
		});
		*/
		const response = await fetch(`${location.protocol}//${location.host}/api/room`, {
		  method: "POST",
		  signal: controller.signal, // ç»‘å®šè¶…æ—¶æ§åˆ¶å™¨
		});
		clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
		
		if (!response.ok) {
		  throw new Error(`åˆ›å»ºå¤±è´¥ï¼š${response.status}`);
		}

		// è·å–64ä½ç§äººæˆ¿é—´ID
		const privateRoomId = await response.text();
		if (!privateRoomId || privateRoomId.length !== 64) {
		  throw new Error("ç§äººæˆ¿é—´IDç”Ÿæˆå¤±è´¥");
		}
		// åŠ å…¥æ–°åˆ›å»ºçš„æˆ¿é—´
		joinExistingRoom(username, privateRoomId);
		// æ¸…ç©ºå†å²è®°å½•
		state.renderedMessages.clear();
		state.sentImageIds.clear();
		
		// æ›´æ–°çŠ¶æ€ï¼ˆä½¿ç”¨ç”Ÿæˆçš„ç§äººIDï¼‰
		state.username = username;
		state.roomname = privateRoomId;

		// æ›´æ–°UI
		toggleElement(els.loginPage, false);
		toggleElement(els.userListPage, true);
		toggleElement(els.backBtn, true);
		toggleElement(els.shareBtn, true);


		// æ›´æ–°URLï¼ˆå†™å…¥ç§äººIDï¼‰
		location.hash = privateRoomId;

		// è¿æ¥WebSocket
		connectWS();
		els.chatInput.blur();

	  } catch (e) {
		alert(`è¿›å…¥æˆ¿é—´å¤±è´¥ï¼š${e.message}`);
		console.error("ç§äººæˆ¿é—´åˆ›å»ºå¤±è´¥ï¼š", e);
		// æ¢å¤æŒ‰é’®çŠ¶æ€
		els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
		els.enterBtn.style.pointerEvents = "auto";
	  }
	}
	
	// åŠ å…¥å·²æœ‰æˆ¿é—´ï¼ˆæ— è®ºæ˜¯åˆ›å»ºçš„è¿˜æ˜¯åˆ†äº«çš„ï¼‰
	function joinExistingRoom(username, roomId) {
	  // æ¸…ç©ºå†å²è®°å½•
	  state.renderedMessages.clear();
	  state.sentImageIds.clear();
	  
	  // æ›´æ–°å…¨å±€çŠ¶æ€
	  state.username = username;
	  state.roomname = roomId;

	  // æ›´æ–°UIï¼šç›´æ¥è¿›å…¥èŠå¤©é¡µï¼ˆè·³è¿‡ç”¨æˆ·åˆ—è¡¨ï¼‰
	  toggleElement(els.loginPage, false);
	  toggleElement(els.userListPage, false); // éšè—ç”¨æˆ·åˆ—è¡¨
	  toggleElement(els.chatPage, true);      // æ˜¾ç¤ºèŠå¤©é¡µ
	  toggleElement(els.backBtn, true);
	  toggleElement(els.shareBtn, true);


	  // æ›´æ–°URL hashï¼ˆåˆ·æ–°é¡µé¢ä¹Ÿèƒ½ä¿ç•™æˆ¿é—´ï¼‰
	  location.hash = roomId;

	  // è¿æ¥WebSocket
	  connectWS();
	  els.chatInput.blur();

	  // æ¢å¤æŒ‰é’®çŠ¶æ€
	  els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
	  els.enterBtn.style.pointerEvents = "auto";
	}
	 /*
    function enterRoom() {
	  const username = els.nameInput.value.trim();
	  const roomname = els.roomInput.value.trim().replace(/[^a-zA-Z0-9_-]/g, '').toLowerCase();
	  
	  if (!username) {
		els.nameInput.focus();
		return;
	  }
	  
	  if (!roomname) {
		els.roomInput.focus();
		return;
	  }
	  // æ–°å¢ï¼šæ¸…ç©ºå†å²æ¸²æŸ“è®°å½•ï¼ˆå…³é”®ï¼ï¼‰
	  state.renderedMessages.clear();
	  state.sentImageIds.clear();
	  // æ›´æ–°çŠ¶æ€
	  state.username = username;
	  state.roomname = roomname;
	  
	  // æ›´æ–°UIï¼šæ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨ + å¯¼èˆªæ æŒ‰é’®
	  toggleElement(els.loginPage, false);
	  toggleElement(els.userListPage, true);
	  toggleElement(els.backBtn, true);
	  toggleElement(els.shareBtn, true);
	  
	  // æ›´æ–°URL
	  location.hash = roomname;
	  
	  // è¿æ¥WebSocketï¼ˆè¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨è·å–ç”¨æˆ·åˆ—è¡¨ï¼‰
	  connectWS();
	  els.chatInput.blur(); // å¼ºåˆ¶è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹
	}
	*/
    /**
     * è¿”å›æŒ‰é’®é€»è¾‘ï¼šèŠå¤©é¡µâ†’ç”¨æˆ·åˆ—è¡¨â†’ç™»å½•é¡µ
     */
    // æ›¿æ¢åŸ goBack å‡½æ•°
	function goBack() {
	  // 1. èŠå¤©é¡µ â†’ ç”¨æˆ·åˆ—è¡¨é¡µ
	  if (!els.chatPage.classList.contains('hide')) {
		toggleElement(els.chatPage, false);
		toggleElement(els.userListPage, true);
		activateTab(els.tabUser);
		return; // å…³é”®ï¼šè¿”å›ï¼Œä¸æ‰§è¡Œåç»­é€»è¾‘
	  }
	  
	  // 2. ç”¨æˆ·åˆ—è¡¨é¡µ â†’ ç™»å½•é¡µ
	  if (!els.userListPage.classList.contains('hide')) {
		// å…³é—­è¿æ¥
		if (state.ws) {
		  try {
			state.ws.send(JSON.stringify({ type: 'quit', name: state.username }));
			state.ws.close();
		  } catch (e) {}
		  state.ws = null;
		}
		
		// æ¸…ç†å®šæ—¶å™¨
		stopHeartbeat();
		if (state.reconnectTimer) clearTimeout(state.reconnectTimer);
		
		// é‡ç½®çŠ¶æ€
		state.username = '';
		state.roomname = '';
		state.onlineUsers = [];
		state.renderedMessages.clear();
		state.sentImageIds.clear();
		state.clientId = Math.random().toString(36).slice(2, 15) + Date.now();
		
		// æ¢å¤æŒ‰é’®çŠ¶æ€ï¼ˆä¿®å¤ã€Œåˆ›å»ºä¸­ã€ä¸é‡ç½®ï¼‰
		els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
		els.enterBtn.style.pointerEvents = "auto";
		
		// æ›´æ–°UI
		toggleElement(els.userListPage, false);
		toggleElement(els.loginPage, true);
		toggleElement(els.backBtn, false);
		toggleElement(els.shareBtn, false);
		els.chatlog.innerHTML = '';
		els.chatInput.innerText = ''; // ä¿®å¤ï¼šç”¨innerTextè€Œévalue
		els.nameInput.focus();
	  }
	}

    // ========== åˆå§‹åŒ– ==========
    function init() {
      // ä»URLæ¢å¤æˆ¿é—´å
	  /*
      if (location.hash) {
        els.roomInput.value = location.hash.slice(1);
      } */
      
      // ç™»å½•æŒ‰é’®
      els.enterBtn.addEventListener('click', enterRoom);
      
      // è¿”å›æŒ‰é’®
      els.backBtn.addEventListener('click', goBack);
      
      // åˆ†äº«æŒ‰é’®
	  els.shareBtn.addEventListener('click', async () => {
		  const roomUrl = `${location.origin}${location.pathname}#${state.roomname}`;
		  const shareTitle = 'Cloudflare ç§äººèŠå¤©å®¤';
		  const shareText = 'é‚€è¯·ä½ åŠ å…¥æˆ‘çš„ç§äººèŠå¤©å®¤ï¼Œç‚¹å‡»é“¾æ¥å³å¯è¿›å…¥';

		  try {
			await navigator.share({
			  title: shareTitle,
			  text: shareText,
			  url: roomUrl
			});
			console.log('åˆ†äº«æˆåŠŸ');
		  } catch (err) {
			// å…³é”®ï¼šåªå¤„ç† "ä¸æ”¯æŒ API" çš„é”™è¯¯ï¼Œå¿½ç•¥ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ
			// AbortError æ˜¯ç”¨æˆ·å…³é—­åˆ†äº«é¢æ¿è§¦å‘çš„é”™è¯¯
			if (err.name !== 'AbortError') {
			  console.log('Web Share API ä¸æ”¯æŒï¼Œé™çº§ä¸ºå¤åˆ¶é“¾æ¥', err);
			  try {
				await navigator.clipboard.writeText(roomUrl);
				alert('ç§äººæˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œä½ å¯ä»¥æ‰‹åŠ¨åˆ†äº«ï½');
			  } catch (clipboardErr) {
				prompt('å¤åˆ¶ç§äººæˆ¿é—´é“¾æ¥ï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰', roomUrl);
			  }
			} else {
			  // ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆåˆ†äº«ï¼Œä»€ä¹ˆéƒ½ä¸åš
			  console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ†äº«');
			}
		  }
		});

      // å‘é€æ¶ˆæ¯
      els.sendBtn.addEventListener('click', sendMessage);
      
// æ›¿æ¢åŸå›è½¦äº‹ä»¶ç›‘å¬ï¼ˆç®€åŒ–ç‰ˆï¼šæ— è®ºæ˜¯å¦æœ‰æ–‡å­—ï¼Œå›è½¦ç›´æ¥æ¢è¡Œï¼‰
//-----------------------------
function isEmptyContent() {
  const content = els.chatInput.innerHTML.trim();
  return content === '' || content === '<br>';
}

els.chatInput.addEventListener('focus', () => {
  if (isEmptyContent()) {
    els.chatInput.innerHTML = '';
  }
  
  const sel = window.getSelection();
  const range = document.createRange();
  range.selectNodeContents(els.chatInput);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
});

els.chatInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.ctrlKey) {
    e.preventDefault();

    if (isEmptyContent()) {
      els.chatInput.innerHTML = '';
    }

    const sel = window.getSelection();
    if (!sel.rangeCount) return;

    const range = sel.getRangeAt(0);

    const br1 = document.createElement('br');
    const br2 = document.createElement('br');

    range.insertNode(br1);
    range.setStartAfter(br1);
    range.insertNode(br2);
    range.setStartAfter(br2);
    range.collapse(true);

    sel.removeAllRanges();
    sel.addRange(range);

    requestAnimationFrame(adjustHeight);
  } else if (e.key === 'Enter' && e.ctrlKey) {
    e.preventDefault();
    sendMessage();
  }
});



els.chatInput.addEventListener('input', (e) => {
  if (e.inputType === 'insertParagraph' || e.inputType === 'insertLineBreak') {
    e.preventDefault();
    return;
  }
  adjustHeight();
});

els.chatInput.addEventListener('blur', () => {
  if (isEmptyContent()) {
    els.chatInput.innerHTML = '';
  }
});
      
      // å›¾ç‰‡ä¸Šä¼ 
      els.imageUpload.addEventListener('change', handleImageUpload);
	  

      
      // é€‰é¡¹å¡åˆ‡æ¢ï¼šç”¨æˆ·â†’èŠå¤©
      
      els.tabChat.addEventListener('click', () => {
        activateTab(els.tabChat);
        toggleElement(els.userListPage, false);
        toggleElement(els.chatPage, true);
        els.chatInput.blur(); // å¼ºåˆ¶å¤±ç„¦
        scrollToBottom();
      });
      
      // æ»šåŠ¨ç›‘å¬
      els.chatlog.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = els.chatlog;
        state.isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
      });
      
      // æ˜µç§°/æˆ¿é—´åè¾“å…¥é™åˆ¶
      els.nameInput.addEventListener('input', (e) => {
        if (e.target.value.length > 32) e.target.value = e.target.value.slice(0, 32);
      });
      /*
      els.roomInput.addEventListener('input', (e) => {
        if (e.target.value.length > 32) e.target.value = e.target.value.slice(0, 32);
      }); */
      
      // å›è½¦ç™»å½•
	  /*
      els.nameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') els.roomInput.focus();
      }); */
      /*
      els.roomInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') enterRoom();
      }); */

      // èšç„¦æ˜µç§°è¾“å…¥æ¡†
      els.nameInput.focus();
    }

    // å¯åŠ¨åº”ç”¨
    window.addEventListener('load', init);
    
    // é¡µé¢å…³é—­æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (state.ws) {
        try {
          state.ws.send(JSON.stringify({ type: 'quit', name: state.username }));
          state.ws.close();
        } catch (e) {}
      }
      stopHeartbeat();
    });
  </script>
</body>
</html>