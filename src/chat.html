<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <style type="text/css">
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  background-color: #d9d5d9;
	  color: #333;
	  min-height: 100vh;
	  margin: 0;
	  padding: 0;
	}

    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: linear-gradient(to bottom, #555555 0%, #333333 100%);
      color: #ffffff;
      font-size: 18px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 100;
      position: relative; 
      text-align: center;
      line-height: 44px;
    }

	#back-btn, #copy-link {
	  color: #ffffff;
	}
	
	#back-btn {
      position: absolute !important; 
      left: 16px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      width: 60px; 
      height: 30px; 
      line-height: 30px;
      text-align: center;
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      display: none;
      z-index: 999 !important;
      background: linear-gradient(135deg, #777777 0%, #555555 100%);
      border: 1.5px solid #666666;
      border-radius: 4px;
      box-shadow: inset 0 0 1px rgba(255,255,255,0.2), 0 1px 3px rgba(0, 0, 0, 0.2);
      padding-left: 8px;
      box-sizing: border-box;
      overflow: hidden;
    }

    #back-btn::before {
      content: "";
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-right: 8px solid #ffffff;
      border-radius: 2px;
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
    }

    #back-btn:active {
      background: linear-gradient(135deg, #666666 0%, #444444 100%);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      border-color: #555555;
      opacity: 1;
    }
	
	#connect-status {
	  margin-right: 5px;
	  font-size: 14px;
	  color: #fff;
	  line-height: 44px;
	}
    
    #copy-link {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 80px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      color: white;
      background: transparent;
      border-radius: 15px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      z-index: 101;
      border: none !important;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }
    
    #copy-link:active {
      background: rgba(255,255,255,0.1);
    }

    #login-form {
	  position: fixed;
	  z-index: 99;
	  top: 0;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  background-color: #d9d5d9;
	  padding-top: 80px;
	}
    
    .form-input {
	  display: block;
	  width: 40%;
	  height: 45px;
	  margin: 25px auto;
	  padding: 0 15px;
	  font-size: 16px;
	  border: 1px solid #ddd;
	  border-radius: 8px;
	  transition: border-color 0.2s ease;
	  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
	}
	
	.form-input:focus {
	  border-color: #333333;
	  outline: none;
	  box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.2);
	}
    
    #login-form p {
	  text-align: center;
	  color: #515151;
	  font-size: 14px;
	  margin-top: 30px;
	  line-height: 1.5;
	}

	#login-form p a {
	  color: #3c3c3c;
	  text-decoration: none;
	  font-weight: 500;
	}
    
    #enter-room {
	  display: block;
	  width: 40%;
	  height: 48px;
	  line-height: 48px;
	  margin: 15px auto;
	  background: linear-gradient(135deg, #777777 0%, #555555 100%);
	  color: #ffffff;
	  border: 1.5px solid #666666; 
	  border-radius: 8px;
	  font-size: 17px;
	  font-weight: 500;
	  cursor: pointer;
	  box-shadow: 
		inset 0 0 1px rgba(255,255,255,0.2),
		0 1px 3px rgba(0, 0, 0, 0.2),
		1px 0 3px rgba(0, 0, 0, 0.15),
		-1px 0 3px rgba(0, 0, 0, 0.15),
		0 -1px 3px rgba(0, 0, 0, 0.1);
	}
    
    #enter-room:active {
	  background: linear-gradient(135deg, #666666 0%, #444444 100%);
	  box-shadow: 
		inset 0 1px 3px rgba(0, 0, 0, 0.3),
		inset 1px 0 3px rgba(0, 0, 0, 0.2),
		inset -1px 0 3px rgba(0, 0, 0, 0.2),
		inset 0 -1px 3px rgba(0, 0, 0, 0.1);
	  border-color: #555555;
	}

    #chatroom {
	  position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  padding-top: 44px;
	  padding-bottom: 48px;
	  display: none;
	  box-sizing: border-box;
	}
    
    #chatlog {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 15px 10px;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    
    #chatlog::-webkit-scrollbar {
      width: 0;
    }

    .msg {
	  display: flex;
	  margin-bottom: 15px;
	  max-width: 100%;
	  position: relative;
	}
    
    .msg.left {
	  justify-content: flex-start;
	}
    
    .msg.right {
	  justify-content: flex-end;
	}
	
	.msg-content {
	  max-width: 75%;
	}
    
    .msg .bubble {
	  padding: 8px 12px;
	  border-radius: 8px;
	  font-size: 15px;
	  line-height: 1.5;
	  word-wrap: break-word;
	  position: relative;
	}
	
	.msg .bubble a {
	  color: #0066cc;
	  text-decoration: underline;
	  word-break: break-all;
	}
	
	.msg .bubble a:hover {
	  color: #0047ab;
	  text-decoration: none;
	}
	
	.msg.right .bubble a {
	  color: #003399;
	}
	
	.msg.right .bubble a:hover {
	  color: #002266;
	}
	
	.msg.left .bubble {
	  background: linear-gradient(to bottom, #e8e8e8 10%, #d0d0d0 100%);
	  color: #000;
	  border-bottom-left-radius: 2px;
	  box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3), 
              0 2px 4px rgba(0, 0, 0, 0.2), 
              -1px 1px 4px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: visible;
	}
	
	.msg.right .bubble {
	  background: linear-gradient(to bottom, #a8d930 10%, #799f26 100%);
	  color: #000;
	  border-bottom-right-radius: 2px;
	  box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3), 
             0 2px 4px rgba(0, 0, 0, 0.2), 
             -1px 1px 4px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: visible;
	}
    
    .msg .username {
	  display: block;
	  font-size: 12px;
	  color: #666;
	  margin-bottom: 5px;
	  padding-left: 5px;
	  padding-right: 5px;
	}
    
    .system-msg {
      text-align: center;
      margin: 10px 0;
    }
    
    .system-msg span {
      display: inline-block;
      padding: 5px 12px;
	  background-color: #f2f3f2;
      color: #666;
      font-size: 12px;
      border-radius: 12px;
    }

    #input-area {
	  position: fixed;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  height: 48px;
	  background: linear-gradient(to bottom, #555555 0%, #333333 100%);
	  padding: 4px 15px;
	  display: flex;
	  align-items: center;
	  border-top: 1px solid #222222;
	  box-shadow: 0 -1px 5px rgba(0,0,0,0.3);
	}
    
    #chat-input {
	  flex: 1;
	  height: 38px; 
	  max-height: 38px;
	  padding: 2px 15px; 
	  border: 1px solid #333333;
	  border-radius: 8px;
	  font-size: 15px;
	  outline: none;
	  resize: none;
	  background-color: #ffffff;
	  color: #333333;
	  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15),
				  inset 0 0 1px rgba(0, 0, 0, 0.05);
	  overflow-y: auto;
	  display: flex;
	  align-items: center;
	  justify-content: flex-start;
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  line-height: 34px; 
	}

	#chat-input::placeholder {
	  color: #999999;
	  display: flex;
	  align-items: center;
	  height: 100%;
	  line-height: 34px;
	}
	
	#chat-input:focus {
	  border-color: #222222;
	  box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.3);
	}
	
	#chat-input::-webkit-scrollbar {
	  width: 0;
	  height: 0;
	}
	
	#chat-input::-webkit-scrollbar-thumb {
	  display: none;
	}
    
    #send-btn {
	  width: 65px;
	  height: 38px; 
	  line-height: 38px; 
	  text-align: center;
	  background: linear-gradient(135deg, #777777 0%, #555555 100%);
	  color: #ffffff;
	  border: 1.5px solid #666666;
	  border-radius: 8px;
	  font-size: 15px;
	  font-weight: 500;
	  cursor: pointer;
	  margin-left: 10px;
	  box-shadow: 
		0 1px 3px rgba(0, 0, 0, 0.2),
		1px 0 3px rgba(0, 0, 0, 0.15),
		-1px 0 3px rgba(0, 0, 0, 0.15),
		0 -1px 3px rgba(0, 0, 0, 0.1);
	  box-shadow: 
		inset 0 0 1px rgba(255,255,255,0.2),
		0 1px 3px rgba(0, 0, 0, 0.2),
		1px 0 3px rgba(0, 0, 0, 0.15),
		-1px 0 3px rgba(0, 0, 0, 0.15),
		0 -1px 3px rgba(0, 0, 0, 0.1);
	}
	
	#send-btn:active {
	  background: linear-gradient(135deg, #666666 0%, #444444 100%);
	  box-shadow: 
		inset 0 1px 3px rgba(0, 0, 0, 0.3),
		inset 1px 0 3px rgba(0, 0, 0, 0.2),
		inset -1px 0 3px rgba(0, 0, 0, 0.2),
		inset 0 -1px 3px rgba(0, 0, 0, 0.1);
	  border-color: #555555;
	}
    
    @media(max-width: 480px) {
      .form-input {
        width: 75%;
      }
      #enter-room {
        width: 75%;
      }
      .msg-content {
        max-width: 80%;
      }
      #copy-link {
        width: 70px;
        font-size: 13px;
      }
    }
	
	#tab-user-list.active, #tab-chat.active {
	  background: #777;
	  color: #fff;
	  font-weight: 500;
	}
  </style>
</head>
<body>
  <div id="header">
    <a id="back-btn" href="javascript:void(0)">返回</a>
	<span id="connect-status" style="display: none;">已连接</span>
    <span id="room-title">cloudflare chatroom</span>
    <button id="copy-link">分享聊天室</button>
  </div>

  <div id="login-form">
    <input id="name-input" class="form-input" placeholder="请输入你的昵称" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <input id="room-name" class="form-input" placeholder="请输入房间名称" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button id="enter-room" type="button">进入房间</button>
    <p>本聊天室基于 Cloudflare Workers Durable Objects 构建<br>
      <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">了解更多</a>
    </p>
  </div>

  <div id="chatroom">
    <div id="chatlog"></div>
    <div id="input-area">
      <textarea id="chat-input" placeholder="请输入消息..." 
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <button id="send-btn" type="button">发送</button>
    </div>
  </div>

  <!-- 用户列表页面 -->
 <div id="user-list-page" style="display: none;">
  <!-- 底部定位的选项卡 -->
  <div style="position: fixed; bottom: 48px; left: 0; right: 0; height: 40px; display: flex; background: #333; z-index: 100; border-top: 1px solid #222;">
    <button id="tab-user-list" style="flex: 1; height: 100%; border: none; background: #555; color: #fff; font-size: 16px;">当前用户</button>
    <button id="tab-chat" style="flex: 1; height: 100%; border: none; background: #444; color: #eee; font-size: 16px;">聊天</button>
  </div>

  <!-- 适配底部选项卡的用户列表 -->
  <div style="padding-top: 44px; padding-bottom: 88px; min-height: 100vh; background: #d9d5d9;">
    <div id="online-users" style="padding: 15px; font-size: 16px; color: #333;">
      <p style="margin-bottom: 10px; font-weight: 500;">当前房间用户：</p>
      <ul id="users-list" style="list-style: none; padding: 0; margin: 0;">
        <!-- 动态渲染用户列表 -->
      </ul>
    </div>
  </div>
</div>

  <script type="text/javascript">
    let currentWebSocket = null;
    let username;
    let userListPage, tabUserList, tabChat, usersList;
    let roomname;
    let isAtBottom = true;
    let lastSeenTimestamp = 0;
    let wroteWelcomeMessages = false;
    let onlineUsers = [];

    // DOM 选择器
    const loginForm = document.querySelector("#login-form");
    const nameInput = document.querySelector("#name-input");
    const roomNameInput = document.querySelector("#room-name");
    const enterRoomButton = document.querySelector("#enter-room");
    const chatroom = document.querySelector("#chatroom");
    const chatlog = document.querySelector("#chatlog");
    const chatInput = document.querySelector("#chat-input");
    const sendBtn = document.querySelector("#send-btn");
    const backBtn = document.querySelector("#back-btn");
    const roomTitle = document.querySelector("#room-title");
    const copyLinkBtn = document.querySelector("#copy-link");
    const connectStatus = document.querySelector("#connect-status");
    
    let hostname = window.location.host;

    // 链接转换
    function replaceUrlWithLink(text) {
      text = text.replace(/\n/g, "<br>");
      const protocolUrlRegex = /((https?:\/\/|ftps?:\/\/)[^\s]+)/gi;
      const domainUrlRegex = /(^|\s)([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}([\/\?\&=\%#-\w]*)(?=\s|$)/gi;
      const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi;
      const telRegex = /(tel:[\d-]+|[\d-]{7,15})/gi;

      let processedText = text.replace(protocolUrlRegex, (url) => {
        return `<a href="${url}" target="_blank" style="color: #0066cc; text-decoration: underline;">${url}</a>`;
      });

      processedText = processedText.replace(domainUrlRegex, (match, prefix, domain, path) => {
        const fullUrl = `https://${domain}${path || ''}`;
        return `${prefix}<a href="${fullUrl}" target="_blank" style="color: #0066cc; text-decoration: underline;">${domain}${path || ''}</a>`;
      });

      processedText = processedText.replace(emailRegex, (email) => {
        return `<a href="mailto:${email}" style="color: #0066cc; text-decoration: underline;">${email}</a>`;
      });

      processedText = processedText.replace(telRegex, (tel) => {
        const telHref = tel.startsWith('tel:') ? tel : `tel:${tel}`;
        return `<a href="${telHref}" style="color: #0066cc; text-decoration: underline;">${tel}</a>`;
      });

      return processedText;
    }

    // 渲染用户列表
    function renderUserList() {
      if (!usersList) return;
      
      usersList.innerHTML = "";
      onlineUsers.forEach(user => {
        const li = document.createElement("li");
        li.style.padding = "8px 0";
        li.style.borderBottom = "1px solid #ccc";
        li.textContent = user;
        usersList.appendChild(li);
      });
      
      if (onlineUsers.length === 0) {
        usersList.innerHTML = "<li style='padding: 8px 0; color: #666;'>当前暂无在线用户</li>";
      }
    }

    // 初始化登录表单
    function initLoginForm() {
      roomTitle.textContent = "cloudflare chatroom";
      backBtn.style.display = "none";
      copyLinkBtn.style.display = "none";

      // 从URL哈希加载房间名
      if (window.location.hash) {
        const hashRoomName = window.location.hash.slice(1);
        if (hashRoomName) {
          roomNameInput.value = hashRoomName;
        }
      }

      // 进入房间按钮点击
      enterRoomButton.addEventListener("click", () => {
        username = nameInput.value.trim();
        roomname = roomNameInput.value.trim();
        
        if (username.length === 0) {
          alert("请输入昵称");
          return;
        }
        if (roomname.length === 0) {
          alert("请输入房间名称");
          return;
        }
        
        startChat();
      });

      // 昵称输入框长度限制
      nameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      // 房间名输入框长度限制
      roomNameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      // 昵称输入框回车事件
      nameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const roomVal = roomNameInput.value.trim();
          if (roomVal) {
            enterRoomButton.click();
          } else {
            roomNameInput.focus();
          }
        }
      });

      // 房间名输入框回车事件
      roomNameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          enterRoomButton.click();
        }
      });

      // 返回按钮点击事件
      backBtn.addEventListener("click", () => {
	  // 1. 判断当前是否显示聊天页
	  if (chatroom.style.display === "block") {
		// 聊天页 → 切到用户列表页（不退出、不关闭连接）
		chatroom.style.display = "none";
		userListPage.style.display = "block";
		// 选中「当前用户」选项卡
		tabUserList.classList.add("active");
		tabChat.classList.remove("active");
	  } else {
		// 2. 用户列表页 → 切到登录页（退出、关闭连接、重置数据）
		if (currentWebSocket) {
		  currentWebSocket.onclose = null;
		  currentWebSocket.onerror = null;
		  currentWebSocket.close();
		  currentWebSocket = null;
		}
		
		connectStatus.style.display = "none";
		roomTitle.textContent = "cloudflare chatroom";
		userListPage.style.display = "none";
		backBtn.style.display = "none";
		copyLinkBtn.style.display = "none";
		loginForm.style.display = "block";
		chatlog.innerHTML = "";
		wroteWelcomeMessages = false;
		lastSeenTimestamp = 0;
		username = "";
		roomname = "";
		
		nameInput.value = "";
		if (window.location.hash) {
		  roomNameInput.value = window.location.hash.slice(1);
		} else {
		  roomNameInput.value = "";
		}
		
		nameInput.focus();
	  }
	});

      // 聊天输入框键盘事件
      chatInput.addEventListener("keydown", event => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault(); 
          const start = chatInput.selectionStart;
          const end = chatInput.selectionEnd;
          chatInput.value = chatInput.value.substring(0, start) + "\n" + chatInput.value.substring(end);
          chatInput.selectionStart = chatInput.selectionEnd = start + 1;
        } else if (event.key === "Enter" && event.shiftKey) {
          event.preventDefault();
          sendMessage();
        } else if (event.keyCode == 38) {
          chatlog.scrollBy(0, -50);
        } else if (event.keyCode == 40) {
          chatlog.scrollBy(0, 50);
        } else if (event.keyCode == 33) {
          chatlog.scrollBy(0, -chatlog.clientHeight + 50);
        } else if (event.keyCode == 34) {
          chatlog.scrollBy(0, chatlog.clientHeight - 50);
        }
      });

      // 发送按钮点击事件
      sendBtn.addEventListener("click", () => {
        sendMessage();
      });

      // 聊天记录滚动事件
      chatlog.addEventListener("scroll", event => {
        isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 10;
      });

      // 复制链接按钮事件
      copyLinkBtn.addEventListener("click", () => {
        const currentUrl = window.location.href;
        navigator.clipboard.writeText(currentUrl).then(() => {
          alert("房间链接已复制到剪贴板！");
        }).catch(() => {
          window.prompt("复制失败，请手动复制以下链接：", currentUrl);
        });
      });

      // 选项卡切换事件
      if (tabUserList && tabChat && userListPage && chatroom) {
        tabUserList.addEventListener("click", () => {
          tabUserList.classList.add("active");
          tabChat.classList.remove("active");
          userListPage.style.display = "block";
          chatroom.style.display = "none";
        });

        tabChat.addEventListener("click", () => {
          tabChat.classList.add("active");
          tabUserList.classList.remove("active");
          userListPage.style.display = "none";
          chatroom.style.display = "block";
          chatlog.scrollBy(0, 1e8);
        });
      }

      nameInput.focus();
    }

    // 进入聊天室
    function startChat() {
      loginForm.style.display = "none";
      if (userListPage) {
        userListPage.style.display = "block"; 
      }
      chatroom.style.display = "none";
      backBtn.style.display = "block";
      copyLinkBtn.style.display = "block";

      // 格式化房间名
      roomname = roomname
        .replace(/[^a-zA-Z0-9_-]/g, "")
        .replace(/_/g, "-")
        .toLowerCase()
        .substring(0, 32);
      
      console.log("前端格式化后房间名:", roomname);
      roomTitle.textContent = `#${roomname}`;

      document.location.hash = "#" + roomname;
      chatInput.focus();
      join();
    }

    // 发送消息
    function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) {
        alert("请输入消息内容！");
        return;
      }
      if (!currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
        alert("连接已断开，请重新进入房间！");
        return;
      }
      
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      
      console.log("发送消息:", message);
      
      currentWebSocket.send(JSON.stringify({
        message: message
      }));
      
      chatInput.value = "";
      chatlog.scrollBy(0, 1e8);
      isAtBottom = true;

      setTimeout(() => {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
      }, 100);
    }

    // 连接WebSocket
    function join() { 
      if (currentWebSocket) {
        try {
          currentWebSocket.close();
        } catch (e) {}
        currentWebSocket = null;
      }

      chatlog.innerHTML = "";
      isAtBottom = true;
      
      const wssProtocol = document.location.protocol === "https:" ? "wss://" : "ws://";
      const wsUrl = `${wssProtocol}${hostname}/api/room/${roomname}/websocket`;
      console.log("尝试连接 WebSocket:", wsUrl);
      
      let ws;
      try {
        ws = new WebSocket(wsUrl);
        currentWebSocket = ws;
        
        ws.onopen = () => {
          console.log("WebSocket 连接已打开");
          connectStatus.style.display = "inline";
          const initMsg = JSON.stringify({ name: username });
          console.log("发送初始化消息:", initMsg);
          ws.send(initMsg);
        };
        
        ws.onmessage = (event) => {
          try {
            console.log("收到消息:", event.data);
            const data = JSON.parse(event.data);
            
            if (data.error) {
              addChatMessage(null, "* Error: " + data.error, true);
              return;
            }
            
            if (data.joined) {
              // addChatMessage(null, ` ${data.joined} 加入了聊天室`, true);
              if (!onlineUsers.includes(data.joined)) {
                onlineUsers.push(data.joined);
                renderUserList();
              }
              return;
            }
            
            if (data.quit) {
              // addChatMessage(null, ` ${data.quit} 离开了聊天室`, true);
              onlineUsers = onlineUsers.filter(u => u !== data.quit);
              renderUserList();
              return;
            }
            
            if (data.users) {
              onlineUsers = data.users;
              renderUserList();
              return;
            }
            
            if (data.ready) {
              wroteWelcomeMessages = true;
              return;
            }
            
            if (data.message && data.timestamp) {
              if (data.timestamp > lastSeenTimestamp) {
                const isSelf = data.name === username;
                addChatMessage(
                  isSelf ? "我" : data.name,
                  data.message,
                  false,
                  isSelf
                );
                lastSeenTimestamp = data.timestamp;
              }
              return;
            }
            
            console.log("忽略非核心消息:", data);
            
          } catch (e) {
            console.error("解析消息失败:", e, "原始数据:", event.data);
            addChatMessage(null, `❌ 消息解析失败: ${e.message}`, true);
          }
        };
        
        ws.onclose = (event) => {
          console.log("WebSocket 连接关闭:", event.code, event.reason);
          connectStatus.style.display = "none";
          currentWebSocket = null;
          
          if (event.code !== 1000) {
            addChatMessage(null, `⚠️ 连接已断开（${event.code}），正在重连...`, true);
            setTimeout(() => join(), 3000);
          }
        };
        
        ws.onerror = (error) => {
          console.error("WebSocket 错误:", error);
          connectStatus.style.display = "none";
          addChatMessage(null, "⚠️ 连接出错，正在重连...", true);
        };
        
      } catch (e) {
        console.error("创建 WebSocket 失败:", e);
        addChatMessage(null, `❌ 创建连接失败: ${e.message}`, true);
        setTimeout(() => join(), 3000);
        return;
      }
    }

    // 添加消息到聊天窗口
    function addChatMessage(name, text, isSystem = false, isSelf = false) {
      console.log("添加消息:", { name, text, isSystem, isSelf });
      
      const msgDiv = document.createElement("div");
      msgDiv.className = isSystem ? "system-msg" : `msg ${isSelf ? "right" : "left"}`;

      if (isSystem) {
        const span = document.createElement("span");
        span.textContent = text;
        msgDiv.appendChild(span);
      } else {
        const contentDiv = document.createElement("div");
        contentDiv.className = "msg-content";

        if (!isSelf && name) {
          const nameSpan = document.createElement("span");
          nameSpan.className = "username";
          nameSpan.textContent = name;
          contentDiv.appendChild(nameSpan);
        }

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "bubble";
        bubbleDiv.innerHTML = replaceUrlWithLink(text);
        contentDiv.appendChild(bubbleDiv);
        
        msgDiv.appendChild(contentDiv);
      }

      chatlog.appendChild(msgDiv);
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    }

    // 页面加载初始化
    window.addEventListener("load", () => {
      console.log("页面加载完成，初始化登录表单");
      userListPage = document.querySelector("#user-list-page");
      tabUserList = document.querySelector("#tab-user-list");
      tabChat = document.querySelector("#tab-chat");
      usersList = document.querySelector("#users-list");
      initLoginForm();
    });
	
    // 页面关闭时清理连接
    window.addEventListener("beforeunload", () => {
      if (currentWebSocket) {
        currentWebSocket.close(1000, "页面关闭");
      }
    });
  </script>
</body>
</html>