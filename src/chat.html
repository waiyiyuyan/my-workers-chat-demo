<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <style type="text/css">
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  background-color: #d9d5d9;
	  color: #333;
	  min-height: 100vh;
	  margin: 0;
	  padding: 0;
	}

    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: linear-gradient(to bottom, #555555 0%, #333333 100%);
      color: #ffffff;
      font-size: 18px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 100;
      position: relative; 
      text-align: center;
      line-height: 44px;
    }

	#back-btn, #copy-link {
	  color: #ffffff;
	}
	
	#back-btn {
      position: absolute !important; 
      left: 16px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      width: 60px; 
      height: 30px; 
      line-height: 30px;
      text-align: center;
      color: #ffffff;
      text-decoration: none;
      font-size: 14px;
      display: none;
      z-index: 999 !important;
      background: linear-gradient(135deg, #777777 0%, #555555 100%);
      border: 1.5px solid #666666;
      border-radius: 4px;
      box-shadow: inset 0 0 1px rgba(255,255,255,0.2), 0 1px 3px rgba(0, 0, 0, 0.2);
      padding-left: 8px;
      box-sizing: border-box;
      overflow: hidden;
    }

    #back-btn::before {
      content: "";
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
      border-right: 8px solid #ffffff;
      border-radius: 2px;
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.2));
    }

    #back-btn:active {
      background: linear-gradient(135deg, #666666 0%, #444444 100%);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      border-color: #555555;
      opacity: 1;
    }
	
	#connect-status {
	  margin-right: 5px;
	  font-size: 14px;
	  color: #fff;
	  line-height: 44px;
	}
    
    #copy-link {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 80px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      color: white;
      background: transparent;
      border-radius: 15px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      z-index: 101;
      border: none !important;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }
    
    #copy-link:active {
      background: rgba(255,255,255,0.1);
    }

    #login-form {
	  position: fixed;
	  z-index: 99;
	  top: 0;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  background-color: #d9d5d9;
	  padding-top: 80px;
	}
    
    .form-input {
	  display: block;
	  width: 100%; /* æ”¹ä¸º100%ï¼Œç»§æ‰¿å®¹å™¨å®½åº¦ */
	  height: 45px;
	  margin: 25px 0; /* ä»…ä¸Šä¸‹é—´è·ï¼Œæ— å·¦å³auto */
	  padding: 0 15px;
	  font-size: 16px;
	  border: 1px solid #ddd;
	  border-radius: 8px;
	  transition: border-color 0.2s ease;
	  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
	}
	
	.form-input:focus {
	  border-color: #333333;
	  outline: none;
	  box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.2);
	}
    
    #login-form p {
	  /* æ ¸å¿ƒï¼šå›ºå®šå®šä½åˆ°é¡µé¢åº•éƒ¨ */
	  position: fixed;
	  bottom: 20px; /* è·ç¦»é¡µé¢åº•éƒ¨20pxï¼Œå¯æŒ‰éœ€è°ƒæ•´ */
	  left: 0;
	  right: 0;
	  /* åŸæœ‰æ ·å¼ä¿ç•™ */
	  text-align: center;
	  color: #515151;
	  font-size: 14px;
	  line-height: 1.5;
	  /* ç§»é™¤åŸæœ‰margin-topï¼Œé¿å…å®šä½å†²çª */
	  margin: 0;
	  /* å¯é€‰ï¼šå¢åŠ z-indexç¡®ä¿ä¸è¢«é®æŒ¡ */
	  z-index: 100;
	}

	#login-form p a {
	  color: #3c3c3c;
	  text-decoration: none;
	  font-weight: 500;
	}
    
    #enter-room {
	  display: block;
	  width: 100px;
	  height: 48px;
	  line-height: 48px;
	  margin: 15px 0 15px auto; /* å…³é”®2ï¼šmargin-left: auto å®ç°å³å¯¹é½ */
	  background: linear-gradient(to bottom, #a8d930 10%, #799f26 100%);
	  color: #000;
	  border: 1.5px solid #6b8f20; /* è¾¹æ¡†åŒ¹é…ç»¿è‰²ç³»ï¼Œå¯é€‰ */
	  border-radius: 8px;
	  font-size: 16px;
	  font-weight: 500;
	  cursor: pointer;
	  box-shadow: 
		inset 0 0 1px rgba(255,255,255,0.2),
		0 1px 3px rgba(0, 0, 0, 0.2),
		1px 0 3px rgba(0, 0, 0, 0.15),
		-1px 0 3px rgba(0, 0, 0, 0.15),
		0 -1px 3px rgba(0, 0, 0, 0.1);
	}
    
    #enter-room:active {
	  background: linear-gradient(to bottom, #9bc828 10%, #6d8f20 100%); /* ç¨æ·±çš„ç»¿è‰² */
	  box-shadow: 
		inset 0 1px 3px rgba(0, 0, 0, 0.3),
		inset 1px 0 3px rgba(0, 0, 0, 0.2),
		inset -1px 0 3px rgba(0, 0, 0, 0.2),
		inset 0 -1px 3px rgba(0, 0, 0, 0.1);
	  border-color: #5d7f1a; /* æŒ‰ä¸‹æ€è¾¹æ¡†ç¨æ·± */
	}

    #chatroom {
	  position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  padding-top: 44px;
	  padding-bottom: 48px;
	  display: none;
	  box-sizing: border-box;
	}
    
    #chatlog {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 15px 10px;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    
    #chatlog::-webkit-scrollbar {
      width: 0;
    }

    .msg {
	  display: flex;
	  margin-bottom: 15px;
	  max-width: 100%;
	  position: relative;
	}
    
    .msg.left {
	  justify-content: flex-start;
	}
    
    .msg.right {
	  justify-content: flex-end;
	}
	
	.msg-content {
	  max-width: 75%;
	}
    
    .msg .bubble {
	  padding: 8px 12px;
	  border-radius: 8px;
	  font-size: 15px;
	  line-height: 1.5;
	  word-wrap: break-word;
	  position: relative;
	}
	
	.msg .bubble a {
	  color: #0066cc;
	  text-decoration: underline;
	  word-break: break-all;
	}
	
	.msg .bubble a:hover {
	  color: #0047ab;
	  text-decoration: none;
	}
	
	.msg.right .bubble a {
	  color: #003399;
	}
	
	.msg.right .bubble a:hover {
	  color: #002266;
	}
	
	.msg.left .bubble {
	  background: linear-gradient(to bottom, #e8e8e8 10%, #d0d0d0 100%);
	  color: #000;
	  border-bottom-left-radius: 2px;
	  box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3), 
              0 2px 4px rgba(0, 0, 0, 0.2), 
              -1px 1px 4px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: visible;
	}
	
	.msg.right .bubble {
	  background: linear-gradient(to bottom, #a8d930 10%, #799f26 100%);
	  color: #000;
	  border-bottom-right-radius: 2px;
	  box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3), 
             0 2px 4px rgba(0, 0, 0, 0.2), 
             -1px 1px 4px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: visible;
	}
    
    .msg .username {
	  display: block;
	  font-size: 12px;
	  color: #666;
	  margin-bottom: 5px;
	  padding-left: 5px;
	  padding-right: 5px;
	}
    
    .system-msg {
      text-align: center;
      margin: 10px 0;
    }
    
    .system-msg span {
      display: inline-block;
      padding: 5px 12px;
	  background-color: #f2f3f2;
      color: #666;
      font-size: 12px;
      border-radius: 12px;
    }

    #input-area {
	  position: fixed;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  height: auto;
	  min-height: 48px; /* ä¿ç•™æœ€å°é«˜åº¦ï¼Œä¿è¯é»˜è®¤çŠ¶æ€å’ŒåŸæ¥ä¸€è‡´ */
	  background: linear-gradient(to bottom, #555555 0%, #333333 100%);
	  padding: 4px 15px;
	  display: flex;
	  align-items: center;
	  border-top: 1px solid #222222;
	  box-shadow: 0 -1px 5px rgba(0,0,0,0.3);
	}
    
    #chat-input {
	  flex: 1;
	  height: auto;
	  min-height: 38px; 
	  max-height: 120px; 
	  
	  /* å…³é”®ä¿®å¤ï¼šç»Ÿä¸€è¡Œé«˜+å†…è¾¹è·+å‚ç›´å¯¹é½ */
	  padding: 8px 15px; 
	  line-height: 22px; /* åŸ34pxæ”¹ä¸º22pxï¼Œé…åˆpaddingå®ç°å‚ç›´å±…ä¸­ */
	  display: flex; /* æ–°å¢ï¼šè®©å†…éƒ¨æ–‡å­—å‚ç›´å±…ä¸­ */
	  align-items: center; /* æ–°å¢ï¼šå…‰æ ‡/æ–‡å­—å‚ç›´å±…ä¸­ */
	  
	  border: 1px solid #333333;
	  border-radius: 8px;
	  font-size: 15px;
	  outline: none;
	  resize: none;
	  background-color: #ffffff;
	  color: #333333;
	  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15),
				  inset 0 0 1px rgba(0, 0, 0, 0.05);
	  overflow-y: auto;
	  
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  white-space: pre-wrap; 
	}

	#chat-input::placeholder {
	  color: #999999;
	  line-height: 22px; /* å’Œè¾“å…¥æ¡†è¡Œé«˜ä¸€è‡´ */
	  vertical-align: middle; /* å ä½ç¬¦æ–‡å­—å‚ç›´å±…ä¸­ */
	}
	
	#chat-input:focus {
	  border-color: #222222;
	  box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.3);
	}
	
	#chat-input::-webkit-scrollbar {
	  width: 4px;
	  height: 0;
	}
	
	#chat-input::-webkit-scrollbar-thumb {
	  background-color: rgba(0,0,0,0.2); /* æ»šåŠ¨æ¡æ»‘å—æ ·å¼ */
	  border-radius: 2px;
	}
    
    #send-btn {
	  width: 65px;
	  height: 38px; 
	  line-height: 38px; 
	  text-align: center;
	  background: linear-gradient(135deg, #777777 0%, #555555 100%);
	  color: #ffffff;
	  border: 1.5px solid #666666;
	  border-radius: 8px;
	  font-size: 15px;
	  font-weight: 500;
	  cursor: pointer;
	  margin-left: 10px;
	  align-self: flex-end; /* å…³é”®ï¼šæŒ‰é’®åº•éƒ¨å¯¹é½ï¼Œè¾“å…¥æ¡†å¢é«˜æ—¶æŒ‰é’®ä¸è·‘å */
	  box-shadow: 
		inset 0 0 1px rgba(255,255,255,0.2),
		0 1px 3px rgba(0, 0, 0, 0.2),
		1px 0 3px rgba(0, 0, 0, 0.15),
		-1px 0 3px rgba(0, 0, 0, 0.15),
		0 -1px 3px rgba(0, 0, 0, 0.1);
	}
	
	#send-btn:active {
	  background: linear-gradient(135deg, #666666 0%, #444444 100%);
	  box-shadow: 
		inset 0 1px 3px rgba(0, 0, 0, 0.3),
		inset 1px 0 3px rgba(0, 0, 0, 0.2),
		inset -1px 0 3px rgba(0, 0, 0, 0.2),
		inset 0 -1px 3px rgba(0, 0, 0, 0.1);
	  border-color: #555555;
	}
    
    @media(max-width: 480px) {
	  /* æ–°å¢ï¼šæ§åˆ¶ç™»å½•è¡¨å•å®¹å™¨å®½åº¦ï¼Œè®©è¾“å…¥æ¡†+æŒ‰é’®æ•´ä½“å±…ä¸­ */
	  #login-form > div {
		width: 75% !important; /* åŒ¹é…ç§»åŠ¨ç«¯è¾“å…¥æ¡†åŸ75%å®½åº¦ */
		margin: 0 auto !important; /* æ•´ä½“å±…ä¸­ */
	  }
	  #login-form p {
		bottom: 15px;
		font-size: 14px; /* ç§»åŠ¨ç«¯å­—ä½“ç¨å° */
		padding: 0 10px; /* å·¦å³ç•™ç™½ï¼Œé¿å…æ–‡å­—è´´è¾¹ */
	  }
	  
	  .form-input {
		width: 100%; /* ç»§æ‰¿å®¹å™¨å®½åº¦ï¼Œä¸å†å•ç‹¬è®¾75% */
		margin: 25px 0; /* ä»…ä¸Šä¸‹é—´è·ï¼Œæ— å·¦å³auto */
	  }
	  
	  #enter-room {
		width: 100px !important; /* å›ºå®šç¼©çŸ­å®½åº¦ï¼ˆå¯æ”¹140/150pxï¼‰ï¼Œæ›¿ä»£åŸ100% */
		margin: 15px 0 15px auto !important; /* margin-left:autoå®ç°å³å¯¹é½ï¼Œæ›¿ä»£åŸ15px 0 */
		font-size: 16px; /* é€‚é…ç§»åŠ¨ç«¯å­—ä½“ */
	  }
	  
	  .msg-content {
		max-width: 80%;
	  }
	  
	  #copy-link {
		width: 70px;
		font-size: 13px;
	  }
	}
	
	#tab-user-list.active, #tab-chat.active {
	  background: #777;
	  color: #fff;
	  font-weight: 500;
	}
	
	.msg .bubble img {
	  max-width: 100%; /* é™åˆ¶å›¾ç‰‡ä¸è¶…è¿‡æ°”æ³¡å®½åº¦ */
	  height: auto;    /* ä¿æŒå®½é«˜æ¯” */
	}
  </style>
</head>
<body>
  <div id="header">
    <a id="back-btn" href="javascript:void(0)">è¿”å›</a>
	<span id="connect-status" style="display: none;">å·²è¿æ¥</span>
    <span id="room-title">cloudflare chatroom</span>
    <button id="copy-link">åˆ†äº«èŠå¤©å®¤</button>
  </div>

  <div id="login-form">
  <!-- å®¹å™¨æ–°å¢classï¼Œæ–¹ä¾¿ç²¾å‡†æ§åˆ¶æ ·å¼ -->
  <div class="login-container" style="width: 40%; margin: 0 auto;">
    <input id="name-input" class="form-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <input id="room-name" class="form-input" placeholder="è¯·è¾“å…¥æˆ¿é—´åç§°" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button id="enter-room" type="button">è¿›å…¥æˆ¿é—´</button>
  </div>
  <p>åŸºäº Cloudflare Workers Durable Objects æ„å»º<br>
    <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">äº†è§£æ›´å¤š</a>
  </p>
  </div>

  <div id="chatroom">
    <div id="chatlog"></div>
    <div id="input-area">
	<!-- å›¾ç‰‡åŒº -->
	  <label for="image-upload" style="
		cursor: pointer;
		margin-left: 8px;
		margin-right: 12px; /* æ–°å¢ï¼šå…³é”®ï¼æŒ‰é’®å‘å·¦æŒªçš„æ ¸å¿ƒ */
		width: 38px;
		height: 38px;
		border-radius: 8px;
		background: linear-gradient(135deg, #777777 0%, #555555 100%);
		display: inline-flex;
		align-items: center;
		justify-content: center;
		border: 1.5px solid #666666;
		box-shadow: 0 1px 3px rgba(0,0,0,0.2);
		vertical-align: bottom;
		padding: 0;
	  ">
		<!-- 2. æ”¾å¤§ SVG å›¾æ ‡å°ºå¯¸ï¼ˆä» 20x20 æ”¹ä¸º 28x28ï¼Œå æ»¡ 38x38 æŒ‰é’®çš„å¤§éƒ¨åˆ†ï¼‰ -->
	  <svg width="36" height="36" viewBox="0 0 24 24" fill="#ffffff">
		<path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
		<path d="M14 10c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" opacity=".3"/>
	  </svg>
	  </label>
	  <input type="file" id="image-upload" accept="image/*" style="display: none;">
	<!-- å›¾ç‰‡åŒº -->
      <textarea id="chat-input" placeholder="è¯·è¾“å…¥æ¶ˆæ¯..." 
         autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <button id="send-btn" type="button">å‘é€</button>
    </div>
  </div>

<!-- ç”¨æˆ·åˆ—è¡¨é¡µé¢ -->
<div id="user-list-page" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto;">
  <!-- å†…å®¹åŒºï¼ˆé€‚é…é¡¶éƒ¨å¯¼èˆªæ  + åº•éƒ¨é€‰é¡¹å¡ï¼‰ -->
  <div style="padding-top: 44px; padding-bottom: 40px; background: #d9d5d9; min-height: 100%;">
    <div id="online-users" style="padding: 15px; font-size: 16px; color: #333;">
      <p id="room-status-title" style="margin-bottom: 10px; font-weight: 500;">å½“å‰æˆ¿é—´ç”¨æˆ·ï¼š</p>
      <ul id="users-list" style="list-style: none; padding: 0; margin: 0;">
        <!-- åŠ¨æ€æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ -->
      </ul>
    </div>
  </div>

  <!-- é€‰é¡¹å¡ç»å¯¹å®šä½åœ¨çˆ¶å®¹å™¨åº•éƒ¨ -->
  <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 40px; display: flex; background: #333; z-index: 100; border-top: 1px solid #222;">
    <button id="tab-user-list" style="flex: 1; height: 100%; border: none; background: #555; color: #fff; font-size: 16px;">ç”¨æˆ·</button>
    <button id="tab-chat" style="flex: 1; height: 100%; border: none; background: #444; color: #eee; font-size: 16px;">èŠå¤©</button>
  </div>
</div>

  <script type="text/javascript">
	
    let currentWebSocket = null;
    let username;
    let userListPage, tabUserList, tabChat, usersList;
    let roomname;
    let isAtBottom = true;
    let lastSeenTimestamp = 0;
    let wroteWelcomeMessages = false;
    let onlineUsers = [];
	let userFirstJoinTime = {}; 

    // DOM é€‰æ‹©å™¨
    const loginForm = document.querySelector("#login-form");
    const nameInput = document.querySelector("#name-input");
    const roomNameInput = document.querySelector("#room-name");
    const enterRoomButton = document.querySelector("#enter-room");
    const chatroom = document.querySelector("#chatroom");
    const chatlog = document.querySelector("#chatlog");
    const chatInput = document.querySelector("#chat-input");
    const sendBtn = document.querySelector("#send-btn");
    const backBtn = document.querySelector("#back-btn");
    const roomTitle = document.querySelector("#room-title");
    const copyLinkBtn = document.querySelector("#copy-link");
    const connectStatus = document.querySelector("#connect-status");
	// å›¾ç‰‡åŒº
	const imageUpload = document.querySelector("#image-upload"); // æ–°å¢ï¼šå›¾ç‰‡ä¸Šä¼ input
	let pendingImageUrl = ""; // æ–°å¢ï¼šæš‚å­˜å¾…å‘é€çš„å›¾ç‰‡URL
    // å›¾ç‰‡åŒº
    let hostname = window.location.host;
	
	// è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦ï¼ˆä¿®å¤åˆ é™¤ä¸ç¼©é«˜é—®é¢˜ï¼‰
	// è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦ï¼ˆä¿®å¤åˆ é™¤ä¸ç¼©é«˜+ç©ºè¾“å…¥æ¡†å¢é«˜bugï¼‰
	function adjustInputHeight() {
	  // æ–°å¢ï¼šå¦‚æœè¾“å…¥æ¡†å†…å®¹ä¸ºç©ºï¼Œç›´æ¥å¼ºåˆ¶è®¾ä¸ºæœ€å°é«˜åº¦
	  if (chatInput.value.trim() === "") {
		chatInput.style.height = `${parseInt(getComputedStyle(chatInput).minHeight)}px`;
		return; // è·³è¿‡åç»­è®¡ç®—
	  }

	  // éç©ºæ—¶æ‰§è¡ŒåŸæœ‰é€»è¾‘
	  chatInput.style.height = `${parseInt(getComputedStyle(chatInput).minHeight)}px`;
	  setTimeout(() => {
		const contentHeight = chatInput.scrollHeight;
		const maxH = parseInt(getComputedStyle(chatInput).maxHeight);
		const minH = parseInt(getComputedStyle(chatInput).minHeight);
		const finalHeight = Math.min(Math.max(contentHeight, minH), maxH);
		chatInput.style.height = `${finalHeight}px`;
	  }, 0);
	}
	
	// å›¾ç‰‡åŒº
	async function uploadToImageBed(file) {
		//return "https://picsum.photos/200/200";
	
	  // Imgur åŒ¿åä¸Šä¼ APIï¼ˆæ— éœ€æ³¨å†Œï¼Œæ”¯æŒè·¨åŸŸï¼‰
	  const uploadUrl = "https://img.cetsteam.com/upload/ftp";
	  
	  if (!file.type.startsWith("image/")) {
		throw new Error("ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶ä¸Šä¼ ï¼");
	  }
	  // æ¥å£æ— æ˜ç¡®å¤§å°é™åˆ¶ï¼Œå¯æ ¹æ®éœ€è¦æ·»åŠ ï¼ˆæ¯”å¦‚ 10MBï¼‰
	  if (file.size > 10 * 1024 * 1024) {
		throw new Error("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MBï¼");
	  }
	  // Imgur å…¬å…±åŒ¿åClient IDï¼ˆå¯ç›´æ¥ä½¿ç”¨ï¼‰
	  // const clientId = "Client-ID 8c9787969c5859c";
	  
	  const formData = new FormData();
	  formData.append("file", file);
	  
	  try {
		const response = await fetch(uploadUrl, {
		  method: "POST",
		  headers: {
			// æ¥å£å…è®¸è·¨åŸŸï¼Œæ— éœ€é¢å¤–é‰´æƒå¤´ï¼Œæµè§ˆå™¨è‡ªåŠ¨å¤„ç† Content-Type
			"Accept": "application/json",
			// ä¸è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œå¦åˆ™ä¼šä¸¢å¤± boundary åˆ†éš”ç¬¦
		  },
		  body: formData
		});

		if (!response.ok) {
		  throw new Error(`ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
		}

		const result = await response.json();
		// æ ¡éªŒæ¥å£è¿”å›çš„æˆåŠŸçŠ¶æ€
		if (result.code === 200 && result.url) {
		  // è¿”å›åŸå›¾ URLï¼ˆä¹Ÿå¯ä»¥é€‰ thumbnail_url ç¼©ç•¥å›¾ï¼‰
		  return result.url;
		} else {
		  throw new Error(result.message || "å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œæ¥å£è¿”å›å¼‚å¸¸");
		}
	  } catch (err) {
		console.error("cetsteam å›¾åºŠä¸Šä¼ å¤±è´¥:", err);
		throw new Error(`ä¸Šä¼ å¤±è´¥ï¼š${err.message}`);
	  }
	  
	}

	// æ–°å¢ï¼šç›‘å¬å›¾ç‰‡é€‰æ‹©äº‹ä»¶
	if (imageUpload) {
	  imageUpload.addEventListener("change", async (e) => {
		const file = e.target.files[0];
		if (!file) return;
		
		// æ ¡éªŒå›¾ç‰‡ç±»å‹å’Œå¤§å°
		if (!file.type.startsWith("image/")) {
		  alert("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆJPG/PNG/GIFç­‰ï¼‰ï¼");
		  return;
		}
		

		try {
		  // ä¸Šä¼ å›¾ç‰‡åˆ°å›¾åºŠï¼Œè·å–URL
		  pendingImageUrl = await uploadToImageBed(file);
		  if (chatInput) chatInput.placeholder = "å·²é€‰å›¾ç‰‡ï¼Œç‚¹å‡»å‘é€";
		  // alert("å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼Œå¯ç‚¹å‡»å‘é€ï¼");
		  imageUpload.value = "";
		} catch (err) {
		  alert(err.message);
		  pendingImageUrl = "";
		  imageUpload.value = ""; // æ–°å¢ï¼šæ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
		}
	  });
	  }

	// å›¾ç‰‡åŒº

    // é“¾æ¥è½¬æ¢
    function replaceUrlWithLink(text) {
	  
      text = text.replace(/\n/g, "<br>");
	  // å›¾ç‰‡åŒº
	  
	  // const imgUrlRegex = /(https?:\/\/picsum\.photos\/\d+\/\d+)|(https?:\/\/.*\.(png|jpg|jpeg|gif|bmp|webp|svg)(\?.*)?)/gi;
	  const imgDomains = ['picsum.photos', 'placehold.co', 'placekitten.com']; // å¸¸è§æ— åç¼€å›¾ç‰‡åŸŸå
	  const imgExtensions = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg']; // å›¾ç‰‡åç¼€
      const urlRegex = /https?:\/\/[^\s]+/gi; // åŒ¹é…æ‰€æœ‰HTTP/HTTPSé“¾æ¥
	  
	  let processedText = text.replace(urlRegex, (url) => {
		// åˆ¤æ–­æ˜¯å¦æ˜¯å›¾ç‰‡URLï¼šè¦ä¹ˆåŒ…å«å›¾ç‰‡åŸŸåï¼Œè¦ä¹ˆåç¼€æ˜¯å›¾ç‰‡æ ¼å¼
		const isImgDomain = imgDomains.some(domain => url.includes(domain));
		const isImgExt = imgExtensions.some(ext => url.toLowerCase().endsWith(`.${ext}`) || url.toLowerCase().includes(`.${ext}?`));

		if (isImgDomain || isImgExt) {
		  // æ˜¯å›¾ç‰‡URLï¼Œè½¬æˆimgæ ‡ç­¾
		  return `<img src="${url}" style="max-width: 200px; max-height: 200px; border-radius: 4px; cursor: pointer;" onclick="previewImg('${url}')">`;
		} else {
		  // æ™®é€šURLï¼Œè½¬æˆaæ ‡ç­¾
		  return `<a href="${url}" target="_blank" style="color: #0066cc; text-decoration: underline;">${url}</a>`;
		}
	  });
	  // å›¾ç‰‡åŒº
      // const protocolUrlRegex = /((https?:\/\/|ftps?:\/\/)[^\s]+)/gi; // å›¾ç‰‡åŒº
      const domainUrlRegex = /(^|\s)([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}([\/\?\&=\%#-\w]*)(?=\s|$)/gi;
      const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/gi;
      const telRegex = /(tel:[\d-]+|[\d-]{7,15})/gi;
	 /*
      processedText = text.replace(protocolUrlRegex, (url) => {
        return `<a href="${url}" target="_blank" style="color: #0066cc; text-decoration: underline;">${url}</a>`;
      });
		*/
      processedText = processedText.replace(domainUrlRegex, (match, prefix, domain, path) => {
        const fullUrl = `https://${domain}${path || ''}`;
        return `${prefix}<a href="${fullUrl}" target="_blank" style="color: #0066cc; text-decoration: underline;">${domain}${path || ''}</a>`;
      });

      processedText = processedText.replace(emailRegex, (email) => {
        return `<a href="mailto:${email}" style="color: #0066cc; text-decoration: underline;">${email}</a>`;
      });

      processedText = processedText.replace(telRegex, (tel) => {
        const telHref = tel.startsWith('tel:') ? tel : `tel:${tel}`;
        return `<a href="${telHref}" style="color: #0066cc; text-decoration: underline;">${tel}</a>`;
      });
	  /*
	  processedText = processedText.replace(new RegExp(`${imgMarker}(\\d+)${imgMarker}`, 'gi'), (_, index) => {
		const imgUrl = imgUrls[parseInt(index)];
		return `<img src="${imgUrl}" style="max-width: 200px; max-height: 200px; border-radius: 4px; cursor: pointer;" onclick="previewImg('${imgUrl}')">`;
	  });
	  */
      return processedText;
    }
	
	// å›¾ç‰‡åŒº
	window.previewImg = function(url) {
	  const modal = document.createElement("div");
	  modal.style = `
		position: fixed;
		top: 0; left: 0; right: 0; bottom: 0;
		background: rgba(0,0,0,0.8);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 9999;
		padding: 20px;
	  `;
	  modal.innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
	  modal.onclick = () => modal.remove();
	  modal.querySelector("img").onclick = (e) => e.stopPropagation();
	  document.body.appendChild(modal);
	};
	// å›¾ç‰‡åŒº
    // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
    function renderUserList() {
	  if (!usersList) return;
	  usersList.innerHTML = "";
	  onlineUsers.forEach(user => {
	  const li = document.createElement("li");
	  li.style.cssText = `
	  padding: 8px 20px; /* å…³é”®1ï¼šå·¦å³åŠ å†…è¾¹è·ï¼Œå†…å®¹å‘ä¸­é—´æ”¶ */
      border-bottom: 1px solid #ccc;
      display: flex;          /* å¼¹æ€§å¸ƒå±€ */
      justify-content: space-between; /* å…³é”®2ï¼šç”¨aroundæ›¿ä»£space-betweenï¼Œå‡å°‘ä¸¤ç«¯ç•™ç™½ */
      align-items: center;    /* å‚ç›´å±…ä¸­ */
    `;
		
		// ğŸ‘‡ æ ¸å¿ƒé€»è¾‘ï¼šä»…åœ¨ã€Œé¦–æ¬¡æ˜¾ç¤ºè¯¥ç”¨æˆ·ã€æ—¶è®°å½•æ—¶é—´ï¼ˆå›ºå®šå€¼ï¼Œæ°¸ä¸æ”¹ï¼‰
		if (!userFirstJoinTime[user]) {
		  const joinTime = new Date(); // è¯¥ç”¨æˆ·é¦–æ¬¡å‡ºç°çš„æ—¶é—´=ä»–çš„åŠ å…¥æ—¶é—´
		  userFirstJoinTime[user] = `${joinTime.getFullYear()}-${String(joinTime.getMonth()+1).padStart(2, '0')}-${String(joinTime.getDate()).padStart(2, '0')} ${String(joinTime.getHours()).padStart(2, '0')}:${String(joinTime.getMinutes()).padStart(2, '0')}:${String(joinTime.getSeconds()).padStart(2, '0')}`;
		}
		
		// ğŸ‘‡ æ˜¾ç¤ºå›ºå®šæ—¶é—´ï¼ˆä¸€æ—¦è®°å½•ï¼Œæ°¸è¿œæ˜¯ä»–è‡ªå·±çš„åŠ å…¥æ—¶é—´ï¼‰
		li.innerHTML = `
		  <span style="color: #333;">${user}</span>  <!-- ç”¨æˆ·åï¼šä¸»è‰²ï¼ˆå’ŒåŸåˆ—è¡¨æ–‡å­—ä¸€è‡´ï¼‰ -->
		  <span style="color: #333; margin-left: 8px;">(${userFirstJoinTime[user]})</span> <!-- æ—¶é—´ï¼šåŒè‰²+å³å¯¹é½ -->
		`;
		usersList.appendChild(li);
	  });
	  
	  if (onlineUsers.length === 0) {
		usersList.innerHTML = "<li style='padding: 8px 0; color: #666;'>å½“å‰æš‚æ— åœ¨çº¿ç”¨æˆ·</li>";
	  }
	}

    // åˆå§‹åŒ–ç™»å½•è¡¨å•
    function initLoginForm() {
      roomTitle.textContent = "cloudflare chatroom";
      backBtn.style.display = "none";
      copyLinkBtn.style.display = "none";

      // ä»URLå“ˆå¸ŒåŠ è½½æˆ¿é—´å
      if (window.location.hash) {
        const hashRoomName = window.location.hash.slice(1);
        if (hashRoomName) {
          roomNameInput.value = hashRoomName;
        }
      }

      // è¿›å…¥æˆ¿é—´æŒ‰é’®ç‚¹å‡»
      enterRoomButton.addEventListener("click", () => {
        username = nameInput.value.trim();
        roomname = roomNameInput.value.trim();
        
        if (username.length === 0) {
          alert("è¯·è¾“å…¥æ˜µç§°");
          return;
        }
        if (roomname.length === 0) {
          alert("è¯·è¾“å…¥æˆ¿é—´åç§°");
          return;
        }
        
        startChat();
      });

      // æ˜µç§°è¾“å…¥æ¡†é•¿åº¦é™åˆ¶
      nameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      // æˆ¿é—´åè¾“å…¥æ¡†é•¿åº¦é™åˆ¶
      roomNameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      // æ˜µç§°è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      nameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const roomVal = roomNameInput.value.trim();
          if (roomVal) {
            enterRoomButton.click();
          } else {
            roomNameInput.focus();
          }
        }
      });

      // æˆ¿é—´åè¾“å…¥æ¡†å›è½¦äº‹ä»¶
      roomNameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          enterRoomButton.click();
        }
      });

      // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      backBtn.addEventListener("click", () => {
	  // 1. åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¾ç¤ºèŠå¤©é¡µ
	  if (chatroom.style.display === "block") {
		// èŠå¤©é¡µ â†’ åˆ‡åˆ°ç”¨æˆ·åˆ—è¡¨é¡µï¼ˆä¸é€€å‡ºã€ä¸å…³é—­è¿æ¥ï¼‰
		chatroom.style.display = "none";
		userListPage.style.display = "block";
		// é€‰ä¸­ã€Œå½“å‰ç”¨æˆ·ã€é€‰é¡¹å¡
		tabUserList.classList.add("active");
		tabChat.classList.remove("active");
	  } else {
		// 2. ç”¨æˆ·åˆ—è¡¨é¡µ â†’ åˆ‡åˆ°ç™»å½•é¡µï¼ˆé€€å‡ºã€å…³é—­è¿æ¥ã€é‡ç½®æ•°æ®ï¼‰
		if (currentWebSocket) {
			try {
			  currentWebSocket.send(JSON.stringify({ 
			  type: "quit", 
			  username: username // å‘Šè¯‰æœåŠ¡ç«¯è¦åˆ é™¤çš„æ˜¯å½“å‰ç”¨æˆ·
			}));
			} catch (e) {
				console.log("é€€å‡ºæ—¶é€šçŸ¥æœåŠ¡ç«¯å¤±è´¥:", e);
			}
			// ---
			delete userFirstJoinTime[username]; 
			onlineUsers = onlineUsers.filter(u => u !== username);
			renderUserList();
			// ---
			currentWebSocket.onclose = null;
			currentWebSocket.onerror = null;
			currentWebSocket.close();
			currentWebSocket = null;
		}
		
		if (username && onlineUsers.length > 0) {
		  onlineUsers = onlineUsers.filter(u => u !== username); // è¿‡æ»¤æ‰è‡ªå·±
		  renderUserList(); // åŒæ­¥æ›´æ–°DOMåˆ—è¡¨
		}
			
		connectStatus.style.display = "none";
		// roomTitle.textContent = "cloudflare chatroom";
		userListPage.style.display = "none";
		backBtn.style.display = "none";
		copyLinkBtn.style.display = "none";
		loginForm.style.display = "block";
		chatlog.innerHTML = "";
		wroteWelcomeMessages = false;
		lastSeenTimestamp = 0;
		username = "";
		roomname = "";
		
		const roomStatusTitle = document.querySelector("#room-status-title");
		if (roomStatusTitle) {
		  roomStatusTitle.textContent = "";
		}
		
		// const roomTitle = document.querySelector("#room-title");
		if (roomTitle) {
		  roomTitle.style.display = "block"; // æ¢å¤æ˜¾ç¤º
		  roomTitle.textContent = "cloudflare chatroom"; // é‡ç½®æ–‡å­—
		}
		
		nameInput.value = "";
		if (window.location.hash) {
		  roomNameInput.value = window.location.hash.slice(1);
		} else {
		  roomNameInput.value = "";
		}
		adjustInputHeight();
		nameInput.focus();
	  }
	});

      // èŠå¤©è¾“å…¥æ¡†é”®ç›˜äº‹ä»¶
      chatInput.addEventListener("keydown", event => {
	  // ä»…ä¿ç•™ï¼šEnterï¼ˆæ— è®ºæ˜¯å¦åŠ shiftï¼‰éƒ½åªæ¢è¡Œï¼Œä¸å‘é€
		  if (event.key === "Enter") {
			event.preventDefault(); 
			const start = chatInput.selectionStart;
			const end = chatInput.selectionEnd;
			chatInput.value = chatInput.value.substring(0, start) + "\n" + chatInput.value.substring(end);
			chatInput.selectionStart = chatInput.selectionEnd = start + 1;
			adjustInputHeight(); // å…³é”®ï¼šå›è½¦åç«‹å³è°ƒæ•´é«˜åº¦
		  } 
		  // ä¿ç•™ä¸Šä¸‹ç¿»é¡µç­‰å¿«æ·é”®ï¼ˆå¯é€‰ï¼Œä¸å½±å“æ ¸å¿ƒé€»è¾‘ï¼‰
		  else if (event.keyCode == 38) {
			chatlog.scrollBy(0, -50);
		  } else if (event.keyCode == 40) {
			chatlog.scrollBy(0, 50);
		  } else if (event.keyCode == 33) {
			chatlog.scrollBy(0, -chatlog.clientHeight + 50);
		  } else if (event.keyCode == 34) {
			chatlog.scrollBy(0, chatlog.clientHeight - 50);
		  }
		});
		
		// ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç›‘å¬è¾“å…¥æ¡†å†…å®¹å˜åŒ–ï¼ˆä»…å¤„ç†åˆ é™¤/æ¢è¡Œï¼Œä¸å¤„ç†æ™®é€šå­—ç¬¦ï¼‰
		chatInput.addEventListener("input", (e) => {
		  const lineCount = (chatInput.value.match(/\n/g) || []).length;
		  // è¡¥å……å…¼å®¹ï¼šè¦†ç›–æ›´å¤šåˆ é™¤/é€€æ ¼çš„inputTypeåœºæ™¯
		  const isDelete = ["deleteContentBackward", "deleteContentForward", "backspace", "delete"].includes(e.inputType);
		  const isLineChange = lineCount !== chatInput.dataset.lastLineCount;
		  
		  if (isDelete || isLineChange) {
			adjustInputHeight();
		  }
		  chatInput.dataset.lastLineCount = lineCount;
		});
		
		chatInput.addEventListener("blur", adjustInputHeight);
	// å†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´é«˜åº¦
	 // chatInput.addEventListener("input", adjustInputHeight);
	  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–é«˜åº¦
	  // adjustInputHeight();
	  
      // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      sendBtn.addEventListener("click", () => {
        sendMessage();
      });

      // èŠå¤©è®°å½•æ»šåŠ¨äº‹ä»¶
      chatlog.addEventListener("scroll", event => {
        isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 10;
      });

      // å¤åˆ¶é“¾æ¥æŒ‰é’®äº‹ä»¶
      copyLinkBtn.addEventListener("click", () => {
        const currentUrl = window.location.href;
        navigator.clipboard.writeText(currentUrl).then(() => {
          alert("æˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        }).catch(() => {
          window.prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š", currentUrl);
        });
      });

      // é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
      if (tabUserList && tabChat && userListPage && chatroom) {
        tabUserList.addEventListener("click", () => {
          tabUserList.classList.add("active");
          tabChat.classList.remove("active");
          userListPage.style.display = "block";
          chatroom.style.display = "none";
        });

        tabChat.addEventListener("click", () => {
          tabChat.classList.add("active");
          tabUserList.classList.remove("active");
          userListPage.style.display = "none";
          chatroom.style.display = "block";
          chatlog.scrollBy(0, 1e8);
		  // chatInput.focus();
		  // chatInput.selectionStart = chatInput.selectionEnd = 0;
        });
      }
	  chatInput.dataset.lastLineCount = (chatInput.value.match(/\n/g) || []).length;
      nameInput.focus();
    }

    // è¿›å…¥èŠå¤©å®¤
    function startChat() {
      loginForm.style.display = "none";
      if (userListPage) {
        userListPage.style.display = "block"; 
		tabUserList.classList.add("active");
		tabChat.classList.remove("active");
      }
      chatroom.style.display = "none";
      backBtn.style.display = "block";
      copyLinkBtn.style.display = "block";
	  
	  adjustInputHeight();
	  

      // æ ¼å¼åŒ–æˆ¿é—´å
      roomname = roomname
        .replace(/[^a-zA-Z0-9_-]/g, "")
        .replace(/_/g, "-")
        .toLowerCase()
        .substring(0, 32);
      
      console.log("å‰ç«¯æ ¼å¼åŒ–åæˆ¿é—´å:", roomname);
	  if (roomTitle) {
		roomTitle.style.display = "none";
	  }
	  
	  const roomStatusTitle = document.querySelector("#room-status-title");
	  if (roomStatusTitle) {
		// æŠŠã€Œå·²è¿æ¥ æˆ¿é—´åã€åŠ åˆ°æ ‡é¢˜å‰é¢
		// roomStatusTitle.textContent = `å·²è¿æ¥ ${roomname} å½“å‰æˆ¿é—´ç”¨æˆ·ï¼š`;
		roomStatusTitle.textContent = ""; // æ¸…ç©ºæ‰€æœ‰æ–‡å­—
	  }

      document.location.hash = "#" + roomname;
      chatInput.focus();
      join();
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
      const message = chatInput.value.trim();
	  // å›¾ç‰‡åŒº
	  if (pendingImageUrl) {
		if (!currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
		  alert("è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°è¿›å…¥æˆ¿é—´ï¼");
		  return;
		}
		sendBtn.disabled = true;
		sendBtn.style.opacity = "0.6";
		
		// å‘é€å›¾ç‰‡URLï¼ˆå½“ä½œæ™®é€šæ–‡å­—æ¶ˆæ¯ï¼‰
		currentWebSocket.send(JSON.stringify({
		  message: pendingImageUrl, // å›¾ç‰‡URLä½œä¸ºæ¶ˆæ¯å†…å®¹
		  name: username
		}));
		// å›¾ç‰‡åŒº
		chatInput.value = ""; // æ–°å¢ï¼šæ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
		adjustInputHeight(); // æ–°å¢ï¼šé‡ç½®è¾“å…¥æ¡†é«˜åº¦ï¼ˆå¯é€‰ï¼‰
		// å›¾ç‰‡åŒº
		pendingImageUrl = "";
		chatInput.placeholder = "è¯·è¾“å…¥æ¶ˆæ¯...";
		sendBtn.disabled = false;
		sendBtn.style.opacity = "1";
		chatlog.scrollBy(0, 1e8);
		isAtBottom = true;
		return; // å‘é€å›¾ç‰‡åç›´æ¥è¿”å›ï¼Œä¸å¤„ç†æ–‡å­—
	  }
	  // å›¾ç‰‡åŒº
      if (!message || message === "undefined" || message === "null") {
		alert("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼");
		return;
	  }
      if (!currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
        alert("è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°è¿›å…¥æˆ¿é—´ï¼");
        return;
      }
      
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      
      console.log("å‘é€æ¶ˆæ¯:", message);
      
      currentWebSocket.send(JSON.stringify({
        message: message,
		name: username // ğŸ‘‡ æ–°å¢
      }));
      
      chatInput.value = "";
	  adjustInputHeight(); // å…³é”®ï¼šå‘é€åé‡ç½®é«˜åº¦ä¸ºé»˜è®¤
      chatlog.scrollBy(0, 1e8);
      isAtBottom = true;

      setTimeout(() => {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
      }, 100);
    }

    // è¿æ¥WebSocket
    function join() { 
      if (currentWebSocket) {
        try {
          currentWebSocket.close();
        } catch (e) {}
        currentWebSocket = null;
      }

      chatlog.innerHTML = "";
      isAtBottom = true;
	  
	  delete userFirstJoinTime[username]; 
	  renderUserList();
      
      const wssProtocol = document.location.protocol === "https:" ? "wss://" : "ws://";
      const wsUrl = `${wssProtocol}${hostname}/api/room/${roomname}/websocket`;
      console.log("å°è¯•è¿æ¥ WebSocket:", wsUrl);
      
      let ws;
      try {
        ws = new WebSocket(wsUrl);
        currentWebSocket = ws;
        
        ws.onopen = () => {
          console.log("WebSocket è¿æ¥å·²æ‰“å¼€");
          // connectStatus.style.display = "inline";
          const initMsg = JSON.stringify({ name: username });
          console.log("å‘é€åˆå§‹åŒ–æ¶ˆæ¯:", initMsg);
          ws.send(initMsg);
        };
        
        ws.onmessage = (event) => {
          try {
            console.log("æ”¶åˆ°æ¶ˆæ¯:", event.data);
            const data = JSON.parse(event.data);
            
            if (data.error) {
              addChatMessage(null, "* Error: " + data.error, true);
              return;
            }
            
            if (data.joined) {
              // addChatMessage(null, ` ${data.joined} åŠ å…¥äº†èŠå¤©å®¤`, true);
              if (!onlineUsers.includes(data.joined)) {
                onlineUsers.push(data.joined);
                renderUserList();
              }
              return;
            }
            
            if (data.quit) {
              // addChatMessage(null, ` ${data.quit} ç¦»å¼€äº†èŠå¤©å®¤`, true);
              onlineUsers = onlineUsers.filter(u => u !== data.quit);
              renderUserList();
              return;
            }
            
            if (data.users) {
              onlineUsers = data.users;
              renderUserList();
              return;
            }
            
            if (data.ready) {
              wroteWelcomeMessages = true;
              return;
            }
            
            if (data.message && data.timestamp && typeof data.message === "string" && data.message.trim()) {
			  if (data.timestamp > lastSeenTimestamp) {
				const userName = data.name ? data.name : "æœªçŸ¥ç”¨æˆ·"; // å…œåº•name
				const isSelf = userName === username;
				addChatMessage(
				  isSelf ? "æˆ‘" : userName,
				  data.message.trim(),
				  false,
				  isSelf
				);
				lastSeenTimestamp = data.timestamp;
			  }
			  return;
			}
						
            console.log("å¿½ç•¥éæ ¸å¿ƒæ¶ˆæ¯:", data);
            
          } catch (e) {
            console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e, "åŸå§‹æ•°æ®:", event.data);
            addChatMessage(null, `âŒ æ¶ˆæ¯è§£æå¤±è´¥: ${e.message}`, true);
          }
        };
        
        ws.onclose = (event) => {
          console.log("WebSocket è¿æ¥å…³é—­:", event.code, event.reason);
          connectStatus.style.display = "none";
          currentWebSocket = null;
          
          if (event.code !== 1000) {
            addChatMessage(null, `âš ï¸ è¿æ¥å·²æ–­å¼€ï¼ˆ${event.code}ï¼‰ï¼Œæ­£åœ¨é‡è¿...`, true);
            setTimeout(() => join(), 3000);
          }
        };
        
        ws.onerror = (error) => {
          console.error("WebSocket é”™è¯¯:", error);
          connectStatus.style.display = "none";
          addChatMessage(null, "âš ï¸ è¿æ¥å‡ºé”™ï¼Œæ­£åœ¨é‡è¿...", true);
        };
        
      } catch (e) {
        console.error("åˆ›å»º WebSocket å¤±è´¥:", e);
        addChatMessage(null, `âŒ åˆ›å»ºè¿æ¥å¤±è´¥: ${e.message}`, true);
        setTimeout(() => join(), 3000);
        return;
      }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
    function addChatMessage(name, text, isSystem = false, isSelf = false) {
		// ğŸ‘‡ æ–°å¢è¿‡æ»¤ä»£ç ã€æ”¾åœ¨è¿™ä¸€è¡Œï¼Œå‡½æ•°å¼€å¤´ç¬¬ä¸€è¡Œã€‘
	  if (text === undefined || text === null || text.trim() === "") {
		console.log("å¿½ç•¥ç©º/undefinedæ¶ˆæ¯");
		return;
	  }
	  if (typeof text === "string" && text.toLowerCase() === "undefined") {
		console.log("å¿½ç•¥'undefined'å­—ç¬¦ä¸²æ¶ˆæ¯");
		return;
	  }
	  // ğŸ‘† æ–°å¢ç»“æŸ
      console.log("æ·»åŠ æ¶ˆæ¯:", { name, text, isSystem, isSelf });
      
      const msgDiv = document.createElement("div");
      msgDiv.className = isSystem ? "system-msg" : `msg ${isSelf ? "right" : "left"}`;

      if (isSystem) {
        const span = document.createElement("span");
        span.textContent = text;
        msgDiv.appendChild(span);
      } else {
        const contentDiv = document.createElement("div");
        contentDiv.className = "msg-content";

        if (!isSelf && name) {
          const nameSpan = document.createElement("span");
          nameSpan.className = "username";
          nameSpan.textContent = name;
          contentDiv.appendChild(nameSpan);
        }

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "bubble";
        bubbleDiv.innerHTML = replaceUrlWithLink(text);
        contentDiv.appendChild(bubbleDiv);
        
        msgDiv.appendChild(contentDiv);
      }

      chatlog.appendChild(msgDiv);
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    }

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    window.addEventListener("load", () => {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç™»å½•è¡¨å•");
      userListPage = document.querySelector("#user-list-page");
      tabUserList = document.querySelector("#tab-user-list");
      tabChat = document.querySelector("#tab-chat");
      usersList = document.querySelector("#users-list");
      initLoginForm();
	  adjustInputHeight();
    });
	
    // é¡µé¢å…³é—­æ—¶æ¸…ç†è¿æ¥
    window.addEventListener("beforeunload", () => {
	  if (currentWebSocket) {
		// ğŸ‘‡ æ–°å¢try-catchå‘é€é€€å‡ºæ¶ˆæ¯
		try {
		  currentWebSocket.send(JSON.stringify({ type: "quit", username: username }));
		} catch (e) {}
		currentWebSocket.close(1000, "é¡µé¢å…³é—­");
	  }
	});
  </script>
</body>
</html>