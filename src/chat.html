<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <script>
    // ä¿®å¤ï¼šå¢åŠ è·³è½¬åˆ¤æ–­ï¼Œé¿å…æ— é™å¾ªç¯
    if (location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
      location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
    }
  </script>
  
  <style type="text/css">
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  background-color: silver;
	  color: #333;
	  min-height: 100vh;
	  margin: 0;
	  padding: 0;
	}

    #header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      
	  background: linear-gradient(to bottom, #63696a 5%, #363d3f 100%);
      color: #ffffff;
      font-size: 18px;
      font-weight: 500;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.1), /* å†…å‘å…‰æ¨¡æ‹Ÿç£¨ç ‚ */
              0 1px 3px rgba(0,0,0,0.5); /* è½»å¾®å¤–é˜´å½± */
      z-index: 100;
      text-align: center;
      line-height: 44px;
	  transform: translateZ(0); /* å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œé˜²æ­¢å®šä½åç§» */
	  -webkit-transform: translateZ(0);
	  will-change: position; /* å‘Šè¯‰æµè§ˆå™¨ä¼˜åŒ–å®šä½ */
    }

	#back-btn, #copy-link {
	  color: #ffffff;
	}
	
	#back-btn {
	  position: absolute !important; 
	  left: 20px !important;
	  top: 50% !important;
	  transform: translateY(-50%) !important;
	  color: #ffffff;
	  text-decoration: none;
	  font-size: 14px;
	  display: none;
	  z-index: 999 !important;
	  /* ç§»é™¤æ‰€æœ‰èƒŒæ™¯ã€è¾¹æ¡†ã€é˜´å½±ã€åœ†è§’ã€clip-path ç­‰æ ·å¼ */
	  background: none !important;
	  border: none !important;
	  box-shadow: none !important;
	  clip-path: none !important;
	  width: auto !important;
	  height: auto !important;
	  line-height: 1em !important;
	  padding: 0 !important;
	  /* æ–°å¢ï¼šç®­å¤´å’Œæ–‡å­—å±…ä¸­ */
	  align-items: center !important;
	}

	/* æ–°å¢ï¼šè¿”å›ç®­å¤´æ ·å¼ */
	#back-btn::before {
	  content: "";
	  display: inline-block !important;
	  width: 8px;
	  height: 8px;
	  margin-right: 2px !important;
	  border: 2px solid #ffffff;
	  border-top: none;
	  border-right: none;
	  border-radius: 2px 0 0 2px;
	  /* ä¿®å¤ï¼šåˆå¹¶transformï¼Œä¼˜å…ˆç”¨è¿™ä¸ªå€¼ï¼Œä¸”åªå†™ä¸€ä¸ªtransform */
	  transform: rotate(45deg) translateY(-18px) !important; 
	  -webkit-transform: rotate(45deg) translateY(-1px) !important;
	  vertical-align: middle !important;
	  position: relative !important; /* æ–°å¢ï¼šç¡®ä¿åç§»ç”Ÿæ•ˆ */
	  top: -1px !important; /* å¤‡ç”¨ï¼šé¢å¤–å‘ä¸Šåç§»1pxï¼ŒåŒä¿é™© */
	}
	
	#back-btn::after {
	  display: none !important;
	}
	
	#back-btn:active {
	  background: none !important;
	  box-shadow: none !important;
	  border: none !important;
	  opacity: 0.8; /* ä»…ä¿ç•™ç‚¹å‡»æ—¶çš„é€æ˜åº¦å˜åŒ–ï¼Œå¯é€‰ */
	}
		
	#connect-status {
	  margin-right: 5px;
	  font-size: 14px;
	  color: #fff;
	  line-height: 44px;
	}
    
    #copy-link {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 80px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      color: white;
      background: transparent;
      border-radius: 15px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      z-index: 101;
      border: none !important;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }
    
    #copy-link:active {
      background: rgba(255,255,255,0.1);
    }

    #login-form {
	  position: fixed;
	  z-index: 99;
	  top: 0;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  background-color: silver;
	  padding-top: 80px;
	}
    
    .form-input {
	  display: block;
	  width: 100%; /* æ”¹ä¸º100%ï¼Œç»§æ‰¿å®¹å™¨å®½åº¦ */
	  height: 45px;
	  margin: 25px 0; /* ä»…ä¸Šä¸‹é—´è·ï¼Œæ— å·¦å³auto */
	  padding: 0 15px;
	  font-size: 16px;
	  border: 1px solid #ddd;
	  border-radius: 8px;
	  transition: border-color 0.2s ease;
	  box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
	}
	
	.form-input:focus {
	  border-color: #333333;
	  outline: none;
	  box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.2);
	}
    
    #login-form p {
	  /* æ ¸å¿ƒï¼šå›ºå®šå®šä½åˆ°é¡µé¢åº•éƒ¨ */
	  position: fixed;
	  bottom: 20px; /* è·ç¦»é¡µé¢åº•éƒ¨20pxï¼Œå¯æŒ‰éœ€è°ƒæ•´ */
	  left: 0;
	  right: 0;
	  /* åŸæœ‰æ ·å¼ä¿ç•™ */
	  text-align: center;
	  color: #515151;
	  font-size: 14px;
	  line-height: 1.5;
	  /* ç§»é™¤åŸæœ‰margin-topï¼Œé¿å…å®šä½å†²çª */
	  margin: 0;
	  /* å¯é€‰ï¼šå¢åŠ z-indexç¡®ä¿ä¸è¢«é®æŒ¡ */
	  z-index: 100;
	}

	#login-form p a {
	  color: #3c3c3c;
	  text-decoration: none;
	  font-weight: 500;
	}
    
    #enter-room {
	  display: block;
	  width: 100px;
	  height: 48px;
	  line-height: 48px;
	  margin: 15px 0 15px auto; /* å…³é”®2ï¼šmargin-left: auto å®ç°å³å¯¹é½ */
	  background: linear-gradient(to bottom, #9ecf35 10%, #8eba30 100%);
	  color: #000;
	  border: 1.5px solid #6b8f20; /* è¾¹æ¡†åŒ¹é…ç»¿è‰²ç³»ï¼Œå¯é€‰ */
	  border-radius: 8px;
	  font-size: 16px;
	  font-weight: 500;
	  cursor: pointer;
	  box-shadow: 
		inset 0 1px 2px rgba(255, 255, 255, 0.5),
		1px 1px 1px rgba(0, 0, 0, 0.2), 
		0 1px 2px rgba(0, 0, 0, 0.2), 
		-1px 1px 1px rgba(0, 0, 0, 0.15);
	}
    
    #enter-room:active {
      background: linear-gradient(to bottom, #9bc828 10%, #6d8f20 100%); /* ç¨æ·±çš„ç»¿è‰² */
      box-shadow: 
		inset 0 1px 3px rgba(0, 0, 0, 0.3),
		inset 1px 0 3px rgba(0, 0, 0, 0.2),
		inset -1px 0 3px rgba(0, 0, 0, 0.2),
		inset 0 -1px 3px rgba(0, 0, 0, 0.1);
	  border-color: #5d7f1a; /* æŒ‰ä¸‹æ€è¾¹æ¡†ç¨æ·± */
	}

    #chatroom {
	  position: fixed;
	  top: 44px; /* ç›´æ¥å®šä½åˆ°å¯¼èˆªæ ä¸‹æ–¹ï¼Œæ›¿ä»£ padding-top */
	  left: 0;
	  right: 0;
	  bottom: 0;
	  padding-bottom: 48px; /* ä»…ä¿ç•™åº•éƒ¨å†…è¾¹è· */
	  display: none;
	  box-sizing: border-box;
	}
    
    #chatlog {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 15px 10px;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    
    #chatlog::-webkit-scrollbar {
      width: 0;
    }

    .msg {
	  display: flex;
	  margin-bottom: 15px;
	  max-width: 100%;
	  position: relative;
	}
    
    .msg.left {
	  justify-content: flex-start;
	}
    
    .msg.right {
	  justify-content: flex-end;
	}
	
	.msg-content {
	  max-width: 75%;
	}
    
    .msg .bubble {
	  padding: 8px 12px;
	  border-radius: 6px;
	  font-size: 15px;
	  line-height: 1.5;
	  word-wrap: break-word;
	  position: relative;
	  overflow: hidden;
	  position: relative;
	}
	
	.msg .bubble a {
	  color: #0066cc;
	  text-decoration: underline;
	  word-break: break-all;
	}
	
	.msg .bubble a:hover {
	  color: #0047ab;
	  text-decoration: none;
	}
	
	.msg.right .bubble a {
	  color: #003399;
	}
	
	.msg.right .bubble a:hover {
	  color: #002266;
	}
	
	.msg.left .bubble {
	  background: linear-gradient(to bottom, #efefef 10%, #d7d7d7 100%);
	  color: #000;
	  border-bottom-left-radius: 2px;
	  box-shadow: 
		inset 0 1px 2px rgba(255, 255, 255, 0.5), /* æ–°å¢ï¼šé¡¶éƒ¨ç™½è‰²å†…é˜´å½±ï¼ˆå…‰æ³½æ ¸å¿ƒï¼‰ */
		1px 1px 1px rgba(0, 0, 0, 0.2), 
        0 1px 2px rgba(0, 0, 0, 0.2), 
        -1px 1px 1px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: hidden;
	}
	
	.msg.right .bubble {
	  background: linear-gradient(to bottom, #9ecf35 10%, #8eba30 100%);
	  color: #000;
	  border-bottom-right-radius: 2px;
	  box-shadow: 
		inset 0 1px 2px rgba(255, 255, 255, 0.5), /* æ–°å¢ï¼šé¡¶éƒ¨ç™½è‰²å†…é˜´å½±ï¼ˆå…‰æ³½æ ¸å¿ƒï¼‰ */
		1px 1px 1px rgba(0, 0, 0, 0.2), 
		0 1px 2px rgba(0, 0, 0, 0.2), 
		-1px 1px 1px rgba(0, 0, 0, 0.15);
	  position: relative;
	  overflow: hidden; /* å¿…é¡»ä¿ç•™ï¼šè®©å†…é˜´å½±ä¸æº¢å‡ºæ°”æ³¡ */
	}
    
    .msg .username {
	  display: block;
	  font-size: 12px;
	  color: #666;
	  margin-bottom: 5px;
	  padding-left: 5px;
	  padding-right: 5px;
	}
    
    .system-msg {
      text-align: center;
      margin: 10px 0;
    }
    
    .system-msg span {
      display: inline-block;
      padding: 5px 12px;
	  background-color: #f2f3f2;
      color: #666;
      font-size: 12px;
      border-radius: 12px;
    }

    #input-area {
	  position: fixed;
	  bottom: 0;
	  left: 0;
	  right: 0;
	  height: auto;
	  min-height: 48px; /* ä¿ç•™æœ€å°é«˜åº¦ï¼Œä¿è¯é»˜è®¤çŠ¶æ€å’ŒåŸæ¥ä¸€è‡´ */
	  background: linear-gradient(to bottom, #63696a 5%, #363d3f 100%);
	  padding: 4px 15px;
	  display: flex;
	  align-items: center;
	  border-top: 1px solid #222222;
	  box-shadow: inset 0 1px 1px rgba(255,255,255,0.05), /* å†…å‘å…‰ */
              0 -1px 3px rgba(0,0,0,0.3); /* è½»å¾®å¤–é˜´å½± */
	}
    
    #chat-input {
	  flex: 1;
	  height: auto;
	  min-height: 38px; 
	  max-height: 120px; 
	  /* å…³é”®ä¿®å¤ï¼šç»Ÿä¸€è¡Œé«˜+å†…è¾¹è·+å‚ç›´å¯¹é½ */
	  padding: 8px 15px; 
	  line-height: 22px; /* åŸ34pxæ”¹ä¸º22pxï¼Œé…åˆpaddingå®ç°å‚ç›´å±…ä¸­ */
	  display: flex; /* æ–°å¢ï¼šè®©å†…éƒ¨æ–‡å­—å‚ç›´å±…ä¸­ */
	  align-items: center; /* æ–°å¢ï¼šå…‰æ ‡/æ–‡å­—å‚ç›´å±…ä¸­ */
	  border: 1px solid #333333;
	  border-radius: 8px;
	  font-size: 15px;
	  outline: none;
	  resize: none;
	  background-color: #ffffff;
	  color: #333333;
	  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15),
				  inset 0 0 1px rgba(0, 0, 0, 0.05);
	  overflow-y: auto;
	  font-family: "Ubuntu", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
	  white-space: pre-wrap; 
	}

	#chat-input::placeholder {
	  color: #999999;
	  line-height: 22px; /* å’Œè¾“å…¥æ¡†è¡Œé«˜ä¸€è‡´ */
	  vertical-align: middle; /* å ä½ç¬¦æ–‡å­—å‚ç›´å±…ä¸­ */
	}
	
	#chat-input:focus {
	  border-color: #222222;
	  box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.3);
	}
	
	#chat-input::-webkit-scrollbar {
	  width: 4px;
	  height: 0;
	}
	
	#chat-input::-webkit-scrollbar-thumb {
	  background-color: rgba(0,0,0,0.2); /* æ»šåŠ¨æ¡æ»‘å—æ ·å¼ */
	  border-radius: 2px;
	}
    
	#send-btn {
	  width: auto;
	  padding: 0 10px;
	  height: 38px; 
	  line-height: 38px; 
	  text-align: center;
	  /* ä¿ç•™ä½ åŸæœ‰æ¸å˜è‰²ï¼Œä¸ä¿®æ”¹ */
	  background: linear-gradient(to bottom, #919496 0%, #393e41 100%);
	  color: #ffffff; /* ä¿ç•™åŸæœ‰ç™½è‰²æ–‡å­—ï¼ˆå¦‚éœ€æµ…ç°å¯æ”¹ #f0f0f0ï¼‰ */
	  border: none !important;
	  border-radius: 2px; /* å°åœ†è§’ï¼Œè´´åˆå›¾ä¸­æ–¹å—æ„Ÿ */
	  font-size: 15px;
	  font-weight: 400; /* å–æ¶ˆåŠ ç²—ï¼ŒåŒ¹é…å›¾ä¸­æ–‡å­—ç²—ç»† */
	  cursor: pointer;
	  margin-left: 10px;
	  align-self: flex-end;
	  /* å½»åº•å»æ‰æ‰€æœ‰é˜´å½± */
	  box-shadow: none !important;
	}

	#send-btn:active {
	  /* ä¿ç•™åŸæœ‰æŒ‰ä¸‹æ€æ¸å˜è‰²ï¼Œå»æ‰é˜´å½± */
	  background: linear-gradient(to bottom, #aeaeae 10%, #161616 60%);
	  box-shadow: none !important; /* æŒ‰ä¸‹æ€ä¹Ÿæ— é˜´å½± */
	}
    
    @media(max-width: 480px) {

	  /* æ–°å¢ï¼šæ§åˆ¶ç™»å½•è¡¨å•å®¹å™¨å®½åº¦ï¼Œè®©è¾“å…¥æ¡†+æŒ‰é’®æ•´ä½“å±…ä¸­ */
	  #login-form > div {
		width: 75% !important; /* åŒ¹é…ç§»åŠ¨ç«¯è¾“å…¥æ¡†åŸ75%å®½åº¦ */
		margin: 0 auto !important; /* æ•´ä½“å±…ä¸­ */
	  }
	  #login-form p {
		bottom: 15px;
		font-size: 14px; /* ç§»åŠ¨ç«¯å­—ä½“ç¨å° */
		padding: 0 10px; /* å·¦å³ç•™ç™½ï¼Œé¿å…æ–‡å­—è´´è¾¹ */
	  }
	  
	  .form-input {
		width: 100%; /* ç»§æ‰¿å®¹å™¨å®½åº¦ï¼Œä¸å†å•ç‹¬è®¾75% */
		margin: 25px 0; /* ä»…ä¸Šä¸‹é—´è·ï¼Œæ— å·¦å³auto */
	  }
	  
	  #enter-room {
		width: 100px !important; /* å›ºå®šç¼©çŸ­å®½åº¦ï¼ˆå¯æ”¹140/150pxï¼‰ï¼Œæ›¿ä»£åŸ100% */
		margin: 15px 0 15px auto !important; /* margin-left:autoå®ç°å³å¯¹é½ï¼Œæ›¿ä»£åŸ15px 0 */
		font-size: 16px; /* é€‚é…ç§»åŠ¨ç«¯å­—ä½“ */
	  }
	  
	  .msg-content {
		max-width: 80%;
	  }
	  
	  #copy-link {
		width: 70px;
		font-size: 13px;
	  }
	  /* ğŸ‘‡ æ–°å¢è¿™éƒ¨åˆ† */ 
	  [for="image-upload"] {
	  margin-left: 0px !important;
	  margin-right: 8px !important;
	  width: auto !important;
	  height: 34px !important;
	  padding: 0 8px !important;
	  touch-action: none;
	  -webkit-touch-callout: none;
	  -webkit-tap-highlight-color: transparent;
	  cursor: pointer;
	}
	[for="image-upload"] svg {
	  width: 20px !important;
	  height: 20px !important;
	}
	  
	  /* ç”¨æˆ·åˆ—è¡¨å¤´åƒé€‚é…ç§»åŠ¨ç«¯ */
	  .user-avatar {
		width: 18px !important;
		height: 20px !important;
	  }
	  
	  #image-upload {
		-webkit-appearance: none;
		appearance: none;
	  }
	  
	  /* ç§»åŠ¨ç«¯å›¾ç‰‡å®¹å™¨å°ºå¯¸ */
	  .img-content {
		width: 160px !important;
		height: 100px !important;
	  }
	  .msg-img .msg-content {
		max-width: 80%; /* å’Œæ–‡å­—æ¶ˆæ¯ä¿æŒä¸€è‡´ */
	  }
	}
	
	label[for="image-upload"]:active {
	  background: linear-gradient(to bottom, #aeaeae 10%, #161616 60%);
	  box-shadow: none !important;
	  opacity: 1;
	}
	
	/* æ–°å¢ï¼šç”¨æˆ·å¤´åƒæ ·å¼ */
	.user-avatar {
	  width: 22px;
	  height: 24px;
	  margin-right: 8px;
	  flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
	}
	
	/* ========== ç”¨æˆ·åˆ—è¡¨é€‰é¡¹å¡å®Œæ•´æ ·å¼ï¼ˆåŒ¹é…æ·±è‰²ç£¨ç ‚é£æ ¼ï¼‰ ========== */
	#user-list-page {
	  background-color: silver; /* åŒ¹é…é¡µé¢èƒŒæ™¯ */
	}
	/* é€‰é¡¹å¡å®¹å™¨ï¼ˆåº•éƒ¨å›ºå®šæ ï¼‰ */
	#user-list-page > div:last-child {
	  position: absolute; 
	  bottom: 0; 
	  left: 0; 
	  right: 0; 
	  height: 40px; 
	  display: flex; 
	  background: linear-gradient(to bottom, #63696a 5%, #363d3f 100%); /* å’Œå¯¼èˆªæ /è¾“å…¥æ¡†åŒæ¸å˜ */
	  z-index: 100; 
	  border-top: 1px solid #222; /* æ·±è‰²è¾¹æ¡†ï¼ŒåŒ¹é…è¾“å…¥æ¡† */
	  box-shadow: inset 0 1px 1px rgba(255,255,255,0.05), /* å†…å‘å…‰ç£¨ç ‚ */
				  0 -1px 3px rgba(0,0,0,0.3); /* è½»å¾®å¤–é˜´å½± */
	}
	/* é€‰é¡¹å¡æŒ‰é’®åŸºç¡€æ ·å¼ï¼ˆç”¨æˆ·/èŠå¤©ï¼‰ */
	#tab-user-list, #tab-chat {
	  flex: 1; 
	  height: 100%; 
	  border: none; 
	  background: linear-gradient(to bottom, #919496 0%, #393e41 100%); /* å’Œè¿”å›æŒ‰é’®åŒæ¸å˜ */
	  color: #ffffff; /* ç™½è‰²æ–‡å­—ï¼ŒåŒ¹é…å¯¼èˆªæ  */
	  font-size: 16px;
	  font-weight: 400;
	  box-shadow: inset 0 1px 1px rgba(255,255,255,0.05), /* å†…å‘å…‰ */
				  0 1px 2px rgba(0,0,0,0.3); /* å¤–é˜´å½± */
	  transition: all 0.2s ease; /* åˆ‡æ¢åŠ¨ç”» */
	}
	/* é€‰é¡¹å¡æŒ‰é’®ç‚¹å‡»æ€ */
	#tab-user-list:active, #tab-chat:active {
	  background: linear-gradient(135deg, #666666 0%, #444444 100%);
	  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
	  border-color: #555555;
	  opacity: 1;
	}
	/* é€‰é¡¹å¡æ¿€æ´»æ€ï¼ˆå½“å‰é€‰ä¸­ï¼‰ */
	#tab-user-list.active, #tab-chat.active {
	  background: linear-gradient(to bottom, #777 10%, #555 100%); /* æ¿€æ´»æ€ç¨äº® */
	  color: #fff; 
	  font-weight: 500;
	  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3); /* å†…é˜´å½±çªå‡ºæ¿€æ´» */
	}
/* åˆ—è¡¨å®¹å™¨æ ·å¼ */
#users-list {
  list-style: none; 
  padding: 0; 
  margin: 0;
  width: 100%;
}

/* é€šç”¨åˆ—è¡¨é¡¹æ ·å¼ï¼ˆä¿ç•™æ‰€æœ‰åŸæœ‰æ ·å¼å‚æ•°ï¼‰ */
#users-list li {
  padding: 12px 20px;
  border-bottom: 1px solid #e0e0e0; /* ä¿ç•™åŸåˆ†å‰²çº¿ */
  display: flex;
  align-items: center;
  justify-content: space-between; /* ä¿ç•™åŸå¸ƒå±€ */
  /* åŒ¹é…å›¾ç‰‡çš„æµ…ç°æ¸å˜ï¼ˆæ›´æŸ”å’Œçš„ä¸Šä¸‹æ¸å˜ï¼‰ */
  background: linear-gradient(to bottom, #f5f5f5 0%, #e9e9e9 100%) !important;
  border-radius: 2px; /* ä¿ç•™åŸåœ†è§’ï¼ˆå›¾ç‰‡ä¹Ÿæ˜¯å°åœ†è§’ï¼‰ */
  margin-bottom: 2px; /* ä¿ç•™åŸé—´è· */
  /* åŒ¹é…å›¾ç‰‡çš„æç®€é˜´å½±ï¼ˆä»…ç»†è¾¹æ¡†+å¾®å¼±å†…å‘å…‰ï¼‰ */
   box-shadow: 
    inset 0 1px 2px rgba(255, 255, 255, 0.5), /* æ°”æ³¡é¡¶éƒ¨ç™½è‰²å†…é˜´å½±ï¼ˆå…‰æ³½æ ¸å¿ƒï¼‰ */
    1px 1px 1px rgba(0, 0, 0, 0.2), 
    0 1px 2px rgba(0, 0, 0, 0.2), 
    -1px 1px 1px rgba(0, 0, 0, 0.15); /* æ°”æ³¡å¤šå±‚å¤–é˜´å½± */
  transition: none !important; /* ç§»é™¤è¿‡æ¸¡ï¼ˆä»…å±•ç¤ºï¼‰ */
  position: relative;
}

/* ç©ºåˆ—è¡¨é¡¹æ ·å¼ï¼ˆåŒæ­¥åŒ¹é…å›¾ç‰‡ï¼‰ */
#users-list li.empty-item {
  padding: 8px 20px; 
  color: #666; 
  display: flex; 
  align-items: center;
  border-bottom: none;
  border-radius: 0;
  margin-bottom: 0;
  /* ç©ºåˆ—è¡¨é¡¹åŒæ­¥å›¾ç‰‡æ¸å˜ */
  background: linear-gradient(to bottom, #f5f5f5 0%, #e9e9e9 100%) !important;
  box-shadow: 
    inset 0 1px 2px rgba(255, 255, 255, 0.5),
    1px 1px 1px rgba(0, 0, 0, 0.1), 
    0 1px 2px rgba(0, 0, 0, 0.1);
}

/* å¤´åƒæ ·å¼ï¼ˆå¼ºåˆ¶ä¿ç•™ï¼Œä»…ç»Ÿä¸€å°ºå¯¸ï¼Œä¸åˆ é™¤ï¼‰ */
.user-avatar {
  width: 22px !important;
  height: 24px !important;
  flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
  margin-right: 8px; /* å¤´åƒå’Œæ–‡å­—é—´è·ï¼ˆåŸé»˜è®¤é—´è·ï¼‰ */
}

/* ç©ºåˆ—è¡¨é¡¹çš„å¤´åƒé¢œè‰²ï¼ˆåŒ¹é…åŸæœ‰#666ï¼‰ */
#users-list li.empty-item .user-avatar {
  fill: #666 !important;
}

/* æ­£å¸¸åˆ—è¡¨é¡¹çš„å¤´åƒé¢œè‰²ï¼ˆåŒ¹é…åŸæœ‰#333333ï¼‰ */
#users-list li:not(.empty-item) .user-avatar {
  fill: #333333 !important;
}

/* åˆ—è¡¨é¡¹æ–‡å­—é¢œè‰²ï¼ˆä¿ç•™åŸæœ‰#333ï¼‰ */
#users-list li span {
  color: #333;
}

	/* ========== å›¾ç‰‡æ¶ˆæ¯æ ·å¼ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰ ========== */
	/* å›¾ç‰‡æ¶ˆæ¯å®¹å™¨ï¼ˆæ— æ°”æ³¡ï¼‰ */
	.msg-img {
	  display: flex;
	  margin-bottom: 15px;
	  max-width: 100%;
	  position: relative;
	}
	.msg-img.left {
	  justify-content: flex-start;
	}
	.msg-img.right {
	  justify-content: flex-end;
	}
	/* å›¾ç‰‡å®¹å™¨ï¼ˆå›ºå®šå°ºå¯¸ï¼‰ */
	.img-content {
	  width: 180px;
	  height: 120px;
	  border-radius: 6px;
	  overflow: hidden;
	  position: relative;
	  background: #f0f0f0;
	}
	/* å›¾ç‰‡åŠ è½½ä¸­å ä½ */
	.img-loading {
	  width: 100%;
	  height: 100%;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  color: #999;
	  font-size: 14px;
	}
	/* å›¾ç‰‡åŠ è½½å¤±è´¥å ä½ */
	.img-error {
	  width: 100%;
	  height: 100%;
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: center;
	  color: #666;
	  font-size: 12px;
	}
	.img-error svg {
	  width: 40px;
	  height: 40px;
	  fill: #ccc;
	  margin-bottom: 8px;
	}
	.msg-img .msg-content {
	  max-width: 75%; /* å’Œæ–‡å­—æ¶ˆæ¯çš„.msg-contentä¸€è‡´ */
	}
	/* çœŸå®å›¾ç‰‡æ ·å¼ï¼ˆç­‰æ¯”è£å‰ªï¼‰ */
	.msg-img img {
	  width: 100%;
	  height: 100%;
	  object-fit: cover;
	  object-position: center;
	  display: block;
	  cursor: pointer;
	}
	
	/* å›¾ç‰‡æ¶ˆæ¯ç”¨æˆ·å */
	.img-username {
	  display: block;
	  font-size: 12px;
	  color: #666;
	  margin-bottom: 5px;
	  padding-left: 5px;
	  padding-right: 5px;
	}
  </style>
</head>
<body>
  <div id="header">
    <a id="back-btn" href="javascript:void(0)">è¿”å›</a>
	<span id="connect-status" style="display: none;">å·²è¿æ¥</span>
    <span id="room-title">cloudflare chatroom</span>
    <button id="copy-link">åˆ†äº«èŠå¤©å®¤</button>
  </div>

  <div id="login-form">
  <!-- å®¹å™¨æ–°å¢classï¼Œæ–¹ä¾¿ç²¾å‡†æ§åˆ¶æ ·å¼ -->
  <div class="login-container" style="width: 40%; margin: 0 auto;">
    <input id="name-input" class="form-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <input id="room-name" class="form-input" placeholder="è¯·è¾“å…¥æˆ¿é—´åç§°" 
           autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button id="enter-room" type="button">è¿›å…¥æˆ¿é—´</button>
  </div>
  <p>åŸºäº Cloudflare Workers Durable Objects æ„å»º<br>
    <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">äº†è§£æ›´å¤š</a>
  </p>
  </div>

  <div id="chatroom">
    <div id="chatlog"></div>
    <div id="input-area">
	<!-- å›¾ç‰‡åŒº -->
	  <label for="image-upload" style="
	  cursor: pointer;
	  margin-left: 0px;
	  margin-right: 10px;
	  width: auto;
	  padding: 0 10px;
	  height: 38px; 
	  line-height: 38px; 
	  text-align: center;
	  background: linear-gradient(to bottom, #919496 0%, #393e41 100%);
	  color: #ffffff;
	  border: none !important;
	  border-radius: 2px;
	  font-size: 15px;
	  font-weight: 400;
	  display: inline-flex;
	  align-items: center;
	  justify-content: center;
	  box-shadow: none !important;
	  vertical-align: bottom;
	  touch-action: manipulation;
	  ">
		<!-- 2. æ”¾å¤§ SVG å›¾æ ‡å°ºå¯¸ï¼ˆä» 20x20 æ”¹ä¸º 28x28ï¼Œå æ»¡ 38x38 æŒ‰é’®çš„å¤§éƒ¨åˆ†ï¼‰ -->
	  <svg width="36" height="36" viewBox="0 0 24 24" fill="#ffffff">
		<path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
		<path d="M14 10c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" opacity=".3"/>
	  </svg>
	  </label>
	  
	  <input type="file" id="image-upload" 
       accept="image/jpeg,image/png,image/gif,image/webp" 
       multiple="false" 
       style="display: none;">
	<!-- å›¾ç‰‡åŒº -->
      <textarea id="chat-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <button id="send-btn" type="button">å‘é€</button>
    </div>
  </div>

<!-- ç”¨æˆ·åˆ—è¡¨é¡µé¢ -->
<div id="user-list-page" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto;">
  <!-- å†…å®¹åŒºï¼ˆé€‚é…é¡¶éƒ¨å¯¼èˆªæ  + åº•éƒ¨é€‰é¡¹å¡ï¼‰ -->
  <div style="padding-top: 21px; padding-bottom: 40px; background: silver; min-height: 100%;">
    <div id="online-users" style="padding: 15px 0; font-size: 16px; color: #333;">
      <p id="room-status-title" style="margin-bottom: 10px; font-weight: 500;">å½“å‰æˆ¿é—´ç”¨æˆ·ï¼š</p>
      <ul id="users-list" style="list-style: none; padding: 0; margin: 0;">
        <!-- åŠ¨æ€æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ -->
      </ul>
    </div>
  </div>

  <!-- é€‰é¡¹å¡ç»å¯¹å®šä½åœ¨çˆ¶å®¹å™¨åº•éƒ¨ -->
	<div>
	  <button id="tab-user-list">ç”¨æˆ·</button>
	  <button id="tab-chat">èŠå¤©</button>
	</div>
</div>

  <script type="text/javascript">
    let currentWebSocket = null;
    let username;
    let userListPage, tabUserList, tabChat, usersList;
    let roomname;
    let isAtBottom = true;
    let lastSeenTimestamp = 0;
    let wroteWelcomeMessages = false;
    let onlineUsers = [];
	let sentImageMsgIds = new Set(); // âœ… å¿…åŠ 

    // DOM é€‰æ‹©å™¨
    const loginForm = document.querySelector("#login-form");
    const nameInput = document.querySelector("#name-input");
    const roomNameInput = document.querySelector("#room-name");
    const enterRoomButton = document.querySelector("#enter-room");
    const chatroom = document.querySelector("#chatroom");
    const chatlog = document.querySelector("#chatlog");
    const chatInput = document.querySelector("#chat-input");
    const sendBtn = document.querySelector("#send-btn");
    const backBtn = document.querySelector("#back-btn");
    const roomTitle = document.querySelector("#room-title");
    const copyLinkBtn = document.querySelector("#copy-link");
    const connectStatus = document.querySelector("#connect-status");
	// å›¾ç‰‡åŒº
	const imageUpload = document.querySelector("#image-upload");
	const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
	const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    // å›¾ç‰‡åŒº
    let hostname = window.location.host;
	
	// ========== è¾“å…¥æ¡†é«˜åº¦è°ƒæ•´ ==========
	function adjustInputHeight() {
	  // ç©ºå€¼å¼ºåˆ¶é‡ç½®æœ€å°é«˜åº¦ï¼Œä¿®å¤åˆ é™¤å†…å®¹ä¸ç¼©é«˜é—®é¢˜
	  if (chatInput.value.trim() === "") {
		chatInput.style.height = `${parseInt(getComputedStyle(chatInput).minHeight)}px`;
		return;
	  }

	  // ä¿ç•™åŸæœ‰é€»è¾‘
	  chatInput.style.height = `${parseInt(getComputedStyle(chatInput).minHeight)}px`;
	  setTimeout(() => {
		const contentHeight = chatInput.scrollHeight;
		const maxH = parseInt(getComputedStyle(chatInput).maxHeight);
		const minH = parseInt(getComputedStyle(chatInput).minHeight);
		const finalHeight = Math.min(Math.max(contentHeight, minH), maxH);
		chatInput.style.height = `${finalHeight}px`;
	  }, 0);
	}
	

// ä¼ å›¾å¼€å§‹
async function uploadToImageBed(file) {
  // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Cloudflare Workers ä»£ç†åŸŸå
  // æ ¼å¼ç¤ºä¾‹ï¼šhttps://ä½ çš„workeråç§°.ä½ çš„cloudflareç”¨æˆ·å.workers.dev/temp-upload
  const UPLOAD_URL = "https://image.lovefree.de5.net/temp-upload";

  // 1. æ ¡éªŒæ–‡ä»¶ç±»å‹
  if (!file.type.startsWith("image/")) {
    throw new Error("ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶ä¸Šä¼ ï¼");
  }

  // 2. é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆå»ºè®® 10MB å†…ï¼‰
  const MAX_SIZE = 10 * 1024 * 1024; // 10MB
  if (file.size > MAX_SIZE) {
    throw new Error(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡${MAX_SIZE / 1024 / 1024}MBï¼`);
  }

  try {
    // 3. æ„å»º FormDataï¼ˆä»…ä¿ç•™æ ¸å¿ƒ image å­—æ®µï¼‰
    const formData = new FormData();
    formData.append("image", file); // ä»…ä¼ è¿™ä¸ªå­—æ®µï¼Œå’ŒåŸç«™ä¸€è‡´

    // 4. å‘é€è¯·æ±‚åˆ° CF ä»£ç†ï¼ˆæ— éœ€åŠ ä»»ä½• Origin/Refererï¼Œä»£ç†ä¼šå¤„ç†ï¼‰
    const response = await fetch(UPLOAD_URL, {
      method: "POST",
      body: formData,          // ç›´æ¥ä¼  FormData
      credentials: "omit",     // åŒ¿åä¸Šä¼ 
      cache: "no-store",       // ç¦ç”¨ç¼“å­˜
      mode: "cors",            // è·¨åŸŸè¯·æ±‚ï¼ˆä»£ç†å·²é…ç½® CORSï¼‰
      timeout: 90000           // 30ç§’è¶…æ—¶
    });

    // 5. æ ¡éªŒå“åº”çŠ¶æ€
    if (!response.ok) {
      const errText = await response.text().catch(() => "æ— å…·ä½“é”™è¯¯ä¿¡æ¯");
      throw new Error(`ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}ï¼Œè¯¦æƒ…ï¼š${errText}`);
    }

    // 6. è§£æä»£ç†è¿”å›çš„ JSON å“åº”
    const result = await response.json();
    if (result.code === 200 && result.msg === "success" && result.data?.url) {
      // è¿”å›ä»£ç†è½¬å‘åæ‹¿åˆ°çš„æœ‰æ•ˆå›¾ç‰‡é“¾æ¥
      return result.data.url;
    } else {
      throw new Error(`å›¾åºŠè¿”å›å¼‚å¸¸ï¼š${result.msg || "æœªç”Ÿæˆæœ‰æ•ˆé“¾æ¥"}`);
    }
  } catch (err) {
    console.error("CFä»£ç†ä¸Šä¼ å¤±è´¥:", err);
    
    let errMsg = err.message;
    if (err.message.includes("NetworkError") || err.message.includes("Failed to fetch")) {
      errMsg = "ç½‘ç»œé”™è¯¯ï¼è¯·æ£€æŸ¥CFä»£ç†åŸŸåæ˜¯å¦æ­£ç¡®";
    } else if (err.message.includes("cors") || err.message.includes("è·¨åŸŸ")) {
      errMsg = "CFä»£ç†æœªæ­£ç¡®é…ç½®CORSï¼è¯·æ£€æŸ¥ä»£ç†ä»£ç ";
    }

    throw new Error(`ä¸Šä¼ å¤±è´¥ï¼š${errMsg}`);
  }
}
// ä¼ å›¾ç»“æŸ

	
// ========== å›¾ç‰‡é€‰æ‹©äº‹ä»¶ï¼šä¹è§‚æ¸²æŸ“å›ºå®šå°ºå¯¸å›¾ç‰‡ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰ ==========
	if (imageUpload) {
		let isUploading = false; // å¢åŠ ä¸Šä¼ é”ï¼Œé¿å…é‡å¤è§¦å‘
		imageUpload.addEventListener("change", async (e) => {
			// 1. æ ¡éªŒæ˜¯å¦æœ‰æ–‡ä»¶è¢«é€‰æ‹©
			const files = e.target.files;
			if (!files || files.length === 0) {
				console.log("æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ ");
				return;
			}
			const file = files[0];
			
			// 2. é˜²æ­¢é‡å¤ä¸Šä¼ 
			if (isUploading) return;
			isUploading = true;

			try {
				let fileType = file.type;
				if (!fileType && file.name) {
					const ext = file.name.split('.').pop().toLowerCase();
					fileType = `image/${ext === 'jpg' ? 'jpeg' : ext}`;
				}
				  
				if (!fileType.startsWith("image/")) {
					alert("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼ˆJPG/PNG/GIFç­‰ï¼‰ï¼");
					isUploading = false;
					imageUpload.value = ""; // æ¸…ç©ºé€‰æ‹©å™¨
					return;
				}

				// 3. ä¹è§‚æ¸²æŸ“å›¾ç‰‡æ¶ˆæ¯ï¼ˆå›ºå®šå°ºå¯¸æ— æ°”æ³¡ï¼‰
				const loadingMsgId = `img-loading-${Date.now()}`;
				addChatMessage("æˆ‘", "", false, true, true); // æœ€åä¸€ä¸ªå‚æ•°æ ‡è®°ä¸ºå›¾ç‰‡æ¶ˆæ¯
				
				// âœ… ä¿®å¤1ï¼šæå‡å˜é‡ä½œç”¨åŸŸ + ç«‹å³å°è¯•è·å–DOMï¼ˆä¸å†ä¾èµ–setTimeoutï¼‰
				let imgContent = chatlog.lastChild?.querySelector(".img-content");
				if (imgContent) {
					imgContent.dataset.msgId = loadingMsgId;
				} else {
					// ç«‹å³è·å–å¤±è´¥ï¼Œå»¶è¿Ÿé‡è¯•ï¼ˆå»¶é•¿åˆ°50msï¼Œç¡®ä¿DOMæ¸²æŸ“å®Œæˆï¼‰
					setTimeout(() => {
						const delayedImgContent = chatlog.lastChild?.querySelector(".img-content");
						if (delayedImgContent) {
							delayedImgContent.dataset.msgId = loadingMsgId;
						}
					}, 50);
				}

				try {
					// 4. ä¸Šä¼ å›¾ç‰‡
					const imageUrl = await uploadToImageBed(file);
					console.log("å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒURLï¼š", imageUrl);
					
					// 5. ä¸Šä¼ æˆåŠŸï¼šæ›´æ–°ä¸ºçœŸå®å›¾ç‰‡ï¼ˆä¼˜å…ˆç”¨msgIdæŸ¥æ‰¾ï¼Œæœ€ç¨³å®šï¼‰
					// âœ… ä¿®å¤2ï¼šä¼˜å…ˆé€šè¿‡msgIdæŸ¥æ‰¾DOMï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜
					const targetImgContent = document.querySelector(`.img-content[data-msg-id="${loadingMsgId}"]`) || imgContent;
					
					if (targetImgContent) {
						const img = new Image();
						// å¼€å¯è·¨åŸŸæ”¯æŒï¼ˆé¿å…éƒ¨åˆ†å›¾åºŠå›¾ç‰‡è·¨åŸŸæŠ¥é”™ï¼‰
						img.crossOrigin = "anonymous";
						img.onload = () => {
							targetImgContent.innerHTML = `<img src="${imageUrl}" onclick="window.open('${imageUrl}', '_blank')">`;
							console.log("å›¾ç‰‡æ¸²æŸ“æˆåŠŸ");
						};
						img.onerror = () => {
							console.error("å›¾ç‰‡åŠ è½½å¤±è´¥ï¼ŒURLï¼š", imageUrl);
							// åŠ è½½å¤±è´¥æ˜¾ç¤ºå ä½
							targetImgContent.innerHTML = `
								<div class="img-error">
									<svg viewBox="0 0 24 24">
										<path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
										<path d="M12 10l-2 2 2 2 2-2-2-2zm0-6v2h2V4h-2zm0 12v2h2v-2h-2z"/>
									</svg>
									<span>å›¾ç‰‡åŠ è½½å¤±è´¥</span>
								</div>
							`;
						};
						img.src = imageUrl;
					} else {
						console.error("æœªæ‰¾åˆ°å›¾ç‰‡å®¹å™¨ï¼ŒmsgIdï¼š", loadingMsgId);
						// å…œåº•ï¼šé‡æ–°æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
						addChatMessage("æˆ‘", imageUrl, false, true, true);
					}
					
					// 6. å‘é€å›¾ç‰‡é“¾æ¥åˆ°èŠå¤©å®¤
					if (currentWebSocket && currentWebSocket.readyState === WebSocket.OPEN) {
						sentImageMsgIds.add(loadingMsgId);
						currentWebSocket.send(JSON.stringify({
							message: imageUrl,
							name: username,
							isImage: true, // æ ‡è®°è¿™æ˜¯å›¾ç‰‡æ¶ˆæ¯
							msgId: loadingMsgId
						}));
					}
				} catch (err) {
					console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š", err);
					// 7. ä¸Šä¼ å¤±è´¥ï¼šæ›´æ–°ä¸ºé”™è¯¯æç¤º
					// âœ… ä¿®å¤3ï¼šä¸Šä¼ å¤±è´¥æ—¶ä¹Ÿç”¨msgIdæŸ¥æ‰¾DOM
					const targetImgContent = document.querySelector(`.img-content[data-msg-id="${loadingMsgId}"]`) || imgContent;
					if (targetImgContent) {
						targetImgContent.innerHTML = `
							<div class="img-error">
								<svg viewBox="0 0 24 24">
									<path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
									<path d="M12 10l-2 2 2 2 2-2-2-2zm0-6v2h2V4h-2zm0 12v2h2v-2h-2z"/>
								</svg>
								<span>${err.message}</span>
							</div>
						`;
					}
					sentImageMsgIds.delete(loadingMsgId);
				}
			} finally {
				// 8. é‡ç½®çŠ¶æ€å’Œæ–‡ä»¶é€‰æ‹©å™¨
				imageUpload.value = ""; 
				isUploading = false;
			}
		});
	}
	
	// ========== ç§»åŠ¨ç«¯å›¾ç‰‡æŒ‰é’®å…¼å®¹ ==========
	const imageUploadLabel = document.querySelector('label[for="image-upload"]');
	if (imageUploadLabel) {
	  const triggerFileInput = () => {
		// å…ˆæ¸…ç©ºæ–‡ä»¶é€‰æ‹©å™¨ï¼Œé¿å…æ®‹ç•™çŠ¶æ€
		imageUpload.value = "";
		// å»¶è¿Ÿè§¦å‘ï¼Œé€‚é…ç§»åŠ¨ç«¯äº‹ä»¶å¾ªç¯
		setTimeout(() => {
		  document.querySelector('#image-upload').click();
		}, 0);
	  };
	  
	  imageUploadLabel.addEventListener('click', (e) => {
		e.preventDefault();
		e.stopPropagation();
		triggerFileInput();
	  });
	  
	  if (isMobile) {
		imageUploadLabel.addEventListener('touchstart', (e) => {
		  e.preventDefault();
		  e.stopPropagation();
		  triggerFileInput();
		}, { passive: false }); // å¼ºåˆ¶è¢«åŠ¨ä¸ºfalseï¼Œç¡®ä¿èƒ½é˜»æ­¢é»˜è®¤è¡Œä¸º
		
		// å¢åŠ touchendäº‹ä»¶é˜²æŠ¤ï¼Œé¿å…é‡å¤è§¦å‘
		imageUploadLabel.addEventListener('touchend', (e) => {
		  e.preventDefault();
		  e.stopPropagation();
		}, { passive: false });
	  }
	}

    // ========== æ ¼å¼åŒ–æ¶ˆæ¯ï¼šä»…å¤„ç†æ–‡å­—é“¾æ¥ ==========
	function formatMessageText(text) {
	  // ç¬¬ä¸€æ­¥ï¼šå…ˆæ¸…ç†æ–‡æœ¬ä¸­çš„å¤šä½™å¼•å·ï¼ˆé¿å…å¹²æ‰°æ­£åˆ™ï¼‰
	  let formattedText = text.replace(/"/g, "").replace(/\n/g, "<br>");
	  // å¤„ç†æ™®é€šé“¾æ¥ï¼ˆæ’é™¤å·²è¢«å›¾ç‰‡å¤„ç†çš„é“¾æ¥ï¼‰
	  const urlRegex = /(https?:\/\/[^\s"'><]+)(?![^<]*>)/g;
	  formattedText = formattedText.replace(urlRegex, (url) => {
		return `<a href='${encodeURI(url)}' target='_blank' style='color: #0066cc; word-break: break-all;'>${url}</a>`;
	  });
	  return formattedText;
	}

    // ========== ç”¨æˆ·åˆ—è¡¨æ¸²æŸ“ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ å¤´åƒï¼‰ ==========
	function renderUserList() {
	  if (!usersList) return;
	  usersList.innerHTML = "";
	  
	  if (onlineUsers.length === 0) {
		// ä»…æ·»åŠ classï¼Œä¿ç•™å®Œæ•´å¤´åƒSVGï¼Œä¸åˆ é™¤ä»»ä½•å†…å®¹
		usersList.innerHTML = `<li class="empty-item">
		  <svg class='user-avatar' width='22' height='24' viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'>
			<path d='M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z'/>
			<path d='M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z'/>
		  </svg>å½“å‰æš‚æ— åœ¨çº¿ç”¨æˆ·</li>`;
		return;
	  }
	  
	  onlineUsers.forEach(user => {
		const li = document.createElement("li");
		// å®Œå…¨åˆ é™¤å†…è”style.cssTextï¼Œæ”¹ç”¨CSSç±»æ§åˆ¶
		// ä¿ç•™å®Œæ•´çš„å¤´åƒSVGç»“æ„ï¼Œä¸ä¿®æ”¹ä»»ä½•å¤´åƒä»£ç 
		li.innerHTML = `
		  <div style="display: flex; align-items: center;">
			<svg class="user-avatar" width="22" height="24" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
			  <path d="M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z"/>
			  <path d="M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z"/>
			</svg>
			<span>${user}</span>
		  </div>
		`;
		usersList.appendChild(li);
	  });
	  
	  // ä¿ç•™å®¹å™¨åŸºç¡€æ ·å¼ï¼ˆä»…å¿…è¦å±æ€§ï¼Œå…¶ä½™äº¤ç»™CSSï¼‰
	  usersList.style.cssText = `
		list-style: none; 
		padding: 0; 
		margin: 0;
		width: 100%;
	  `;
	}

    // ========== åˆå§‹åŒ–ç™»å½•è¡¨å• ==========
    function initLoginForm() {
      roomTitle.textContent = "cloudflare chatroom";
      backBtn.style.display = "none";
      copyLinkBtn.style.display = "none";

      if (window.location.hash) {
        const hashRoomName = window.location.hash.slice(1);
        if (hashRoomName) {
          roomNameInput.value = hashRoomName;
        }
      }

      enterRoomButton.addEventListener("click", () => {
        username = nameInput.value.trim();
        roomname = roomNameInput.value.trim();
        
        if (username.length === 0) {
          alert("è¯·è¾“å…¥æ˜µç§°");
          return;
        }
        if (roomname.length === 0) {
          alert("è¯·è¾“å…¥æˆ¿é—´åç§°");
          return;
        }
        
        startChat();
      });

      nameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      roomNameInput.addEventListener("input", event => {
        if (event.currentTarget.value.length > 32) {
          event.currentTarget.value = event.currentTarget.value.slice(0, 32);
        }
      });
      
      nameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const roomVal = roomNameInput.value.trim();
          if (roomVal) {
            enterRoomButton.click();
          } else {
            roomNameInput.focus();
          }
        }
      });

      roomNameInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          enterRoomButton.click();
        }
      });

      backBtn.addEventListener("click", () => {
	  if (chatroom.style.display === "block") {
		chatroom.style.display = "none";
		userListPage.style.display = "block";
		// tabUserList.classList.add("active");
		tabChat.classList.remove("active");
	  } else {
		if (currentWebSocket) {
			try {
			  currentWebSocket.send(JSON.stringify({ 
			  type: "quit", 
			  username: username
			}));
			} catch (e) {
				console.log("é€€å‡ºæ—¶é€šçŸ¥æœåŠ¡ç«¯å¤±è´¥:", e);
			}
			onlineUsers = onlineUsers.filter(u => u !== username);
			renderUserList();
			currentWebSocket.onclose = null;
			currentWebSocket.onerror = null;
			currentWebSocket.close();
			currentWebSocket = null;
		}
		
		if (username && onlineUsers.length > 0) {
		  onlineUsers = onlineUsers.filter(u => u !== username);
		  renderUserList();
		}
			
		connectStatus.style.display = "none";
		userListPage.style.display = "none";
		backBtn.style.display = "none";
		copyLinkBtn.style.display = "none";
		loginForm.style.display = "block";
		chatlog.innerHTML = "";
		wroteWelcomeMessages = false;
		lastSeenTimestamp = 0;
		username = "";
		roomname = "";
		
		const roomStatusTitle = document.querySelector("#room-status-title");
		if (roomStatusTitle) {
		  roomStatusTitle.textContent = "";
		}
		
		if (roomTitle) {
		  roomTitle.style.display = "block";
		  roomTitle.textContent = "cloudflare chatroom";
		}
		
		nameInput.value = "";
		if (window.location.hash) {
		  roomNameInput.value = window.location.hash.slice(1);
		} else {
		  roomNameInput.value = "";
		}
		adjustInputHeight();
		nameInput.focus();
	  }
	});

      chatInput.addEventListener("keydown", event => {
		  if (event.key === "Enter") {
			event.preventDefault(); 
			const start = chatInput.selectionStart;
			const end = chatInput.selectionEnd;
			chatInput.value = chatInput.value.substring(0, start) + "\n" + chatInput.value.substring(end);
			chatInput.selectionStart = chatInput.selectionEnd = start + 1;
			adjustInputHeight();
		  } 
		  else if (event.keyCode == 38) {
			chatlog.scrollBy(0, -50);
		  } else if (event.keyCode == 40) {
			chatlog.scrollBy(0, 50);
		  } else if (event.keyCode == 33) {
			chatlog.scrollBy(0, -chatlog.clientHeight + 50);
		  } else if (event.keyCode == 34) {
			chatlog.scrollBy(0, chatlog.clientHeight + 50);
		  }
		});
		
		chatInput.addEventListener("input", (e) => {
		  const lineCount = (chatInput.value.match(/\n/g) || []).length;
		  const isDelete = ["deleteContentBackward", "deleteContentForward", "backspace", "delete"].includes(e.inputType);
		  const isLineChange = lineCount !== chatInput.dataset.lastLineCount;
		  
		  if (isDelete || isLineChange) {
			adjustInputHeight();
		  }
		  chatInput.dataset.lastLineCount = lineCount;
		});
		
		chatInput.addEventListener("blur", adjustInputHeight);
	  
      sendBtn.addEventListener("click", () => {
        sendMessage();
      });

      chatlog.addEventListener("scroll", event => {
        isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 10;
      });

      copyLinkBtn.addEventListener("click", () => {
        const currentUrl = window.location.href;
        navigator.clipboard.writeText(currentUrl).then(() => {
          alert("æˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        }).catch(() => {
          window.prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š", currentUrl);
        });
      });

      // æ›¿æ¢åŸæœ‰é€‰é¡¹å¡ç‚¹å‡»äº‹ä»¶é€»è¾‘ï¼ˆinitLoginForm å‡½æ•°å†…ï¼‰
	if (tabUserList && tabChat && userListPage && chatroom) {
	  // é€šç”¨æ¿€æ´»/ç§»é™¤æ¿€æ´»å‡½æ•°
	  const toggleTabActive = (tab, isActive) => {
		if (isActive) {
		  tab.classList.add("active");
		} else {
		  // tab.classList.remove("active");
		  setTimeout(() => {
			tab.classList.remove("active");
		  }, 100);
		}
	  };

	  // ç”¨æˆ·é€‰é¡¹å¡ï¼šç‚¹å‡»æŒ‰ä¸‹æ¿€æ´»ï¼Œæ¾å¼€/ç¦»å¼€ç§»é™¤
	  tabUserList.addEventListener("mousedown", (e) => {
		e.preventDefault();
		toggleTabActive(tabUserList, true);
		// åˆ‡æ¢é¡µé¢é€»è¾‘
		userListPage.style.display = "block";
		chatroom.style.display = "none";
	  });
	  tabUserList.addEventListener("mouseup", () => toggleTabActive(tabUserList, false));
	  tabUserList.addEventListener("mouseleave", () => toggleTabActive(tabUserList, false));

	  // ç§»åŠ¨ç«¯å…¼å®¹ï¼štouch äº‹ä»¶
	  tabUserList.addEventListener("touchstart", (e) => {
		e.preventDefault();
		toggleTabActive(tabUserList, true);
		userListPage.style.display = "block";
		chatroom.style.display = "none";
	  });
	  tabUserList.addEventListener("touchend", () => toggleTabActive(tabUserList, false));
	  tabUserList.addEventListener("touchcancel", () => toggleTabActive(tabUserList, false));

	  // èŠå¤©é€‰é¡¹å¡ï¼šå’Œç”¨æˆ·é€‰é¡¹å¡é€»è¾‘å®Œå…¨ä¸€è‡´
	  tabChat.addEventListener("mousedown", (e) => {
		e.preventDefault();
		toggleTabActive(tabChat, true);
		// åˆ‡æ¢é¡µé¢é€»è¾‘
		userListPage.style.display = "none";
		chatroom.style.display = "block";
		chatlog.scrollBy(0, 1e8);
	  });
	  tabChat.addEventListener("mouseup", () => toggleTabActive(tabChat, false));
	  tabChat.addEventListener("mouseleave", () => toggleTabActive(tabChat, false));

	  // ç§»åŠ¨ç«¯å…¼å®¹ï¼štouch äº‹ä»¶
	  tabChat.addEventListener("touchstart", (e) => {
		e.preventDefault();
		toggleTabActive(tabChat, true);
		userListPage.style.display = "none";
		chatroom.style.display = "block";
		chatlog.scrollBy(0, 1e8);
	  });
	  tabChat.addEventListener("touchend", () => toggleTabActive(tabChat, false));
	  tabChat.addEventListener("touchcancel", () => toggleTabActive(tabChat, false));
	}
	  
	  chatInput.dataset.lastLineCount = (chatInput.value.match(/\n/g) || []).length;
      nameInput.focus();
	  
	  let scrollLock = false;
      chatInput.addEventListener("focus", () => {
        if (scrollLock) return;
        scrollLock = true;
        document.querySelector("#header").style.display = "block";
        window.scrollTo(0, 0);
        setTimeout(() => {
          scrollLock = false;
        }, 300);
      });
    }

    // ========== è¿›å…¥èŠå¤©å®¤ ==========
    function startChat() {
      loginForm.style.display = "none";
      if (userListPage) {
        userListPage.style.display = "block"; 
		//tabUserList.classList.add("active");
		//tabUserList.classList.remove("active"); 
		// tabChat.classList.remove("active");
      }
      chatroom.style.display = "none";
      backBtn.style.display = "block";
      copyLinkBtn.style.display = "block";
	  
	  adjustInputHeight();

      roomname = roomname
        .replace(/[^a-zA-Z0-9_-]/g, "")
        .replace(/_/g, "-")
        .toLowerCase()
        .substring(0, 32);
      
      console.log("å‰ç«¯æ ¼å¼åŒ–åæˆ¿é—´å:", roomname);
	  if (roomTitle) {
		roomTitle.style.display = "none";
	  }
	  
	  const roomStatusTitle = document.querySelector("#room-status-title");
	  if (roomStatusTitle) {
		roomStatusTitle.textContent = "";
	  }

      document.location.hash = "#" + roomname;
      chatInput.focus();
      join();
    }

    // ========== å‘é€æ¶ˆæ¯ï¼šç›´æ¥å‘é€è¾“å…¥æ¡†åŸå§‹æ–‡æœ¬ ==========
    function sendMessage() {
      // 1. è·å–è¾“å…¥æ¡†åŸå§‹æ–‡æœ¬
      const message = chatInput.value.trim();
	  
      // 2. æ ¡éªŒç©ºæ¶ˆæ¯
      if (!message || message === "undefined" || message === "null") {
		alert("è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼");
		return;
      }
      
      // 3. æ ¡éªŒè¿æ¥çŠ¶æ€
      if (!currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
        alert("è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°è¿›å…¥æˆ¿é—´ï¼");
        return;
      }
      
      // 4. ç¦ç”¨å‘é€æŒ‰é’®
      sendBtn.disabled = true;
      sendBtn.style.opacity = "0.6";
      
      // 5. ç›´æ¥å‘é€åŸå§‹æ¶ˆæ¯ï¼ˆä¸åšä»»ä½•å¤„ç†ï¼‰
      console.log("å‘é€åŸå§‹æ¶ˆæ¯:", message);
      currentWebSocket.send(JSON.stringify({
        message: message,
		name: username
      }));
      
      // 6. æ¸…ç©ºè¾“å…¥æ¡†å¹¶è°ƒæ•´é«˜åº¦
      chatInput.value = "";
	  adjustInputHeight();
      chatlog.scrollBy(0, 1e8);
      isAtBottom = true;

      // 7. æ¢å¤å‘é€æŒ‰é’®
      setTimeout(() => {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
      }, 100);
    }

    // ========== è¿æ¥WebSocket ==========
    function join() {
      if (currentWebSocket) {
        try {
          currentWebSocket.close();
        } catch (e) {}
        currentWebSocket = null;
      }

      chatlog.innerHTML = "";
      isAtBottom = true;
	  onlineUsers = []; // âœ… æ–°å¢ï¼šé‡è¿æ—¶æ¸…ç©ºç”¨æˆ·åˆ—è¡¨
	  renderUserList(); // âœ… æ–°å¢ï¼šé‡æ–°æ¸²æŸ“ç©ºåˆ—è¡¨
	  
	  const wssProtocol = document.location.protocol === "https:" ? "wss://" : "ws://";
	  const wsUrl = `${wssProtocol}${hostname}/api/room/${roomname}/websocket`;
	  console.log("å°è¯•è¿æ¥ WebSocket:", wsUrl);
      
      let ws;
      try {
        ws = new WebSocket(wsUrl);
        currentWebSocket = ws;
        
        ws.onopen = () => {
          console.log("WebSocket è¿æ¥å·²æ‰“å¼€");
          const initMsg = JSON.stringify({ name: username });
          console.log("å‘é€åˆå§‹åŒ–æ¶ˆæ¯:", initMsg);
          ws.send(initMsg);
        };
        
        ws.onmessage = (event) => {
          try {
            console.log("æ”¶åˆ°æ¶ˆæ¯:", event.data);
            const data = JSON.parse(event.data);
            
            if (data.error) {
              addChatMessage(null, "* Error: " + data.error, true);
              return;
            }
            
            if (data.joined) {
              if (!onlineUsers.includes(data.joined)) {
                onlineUsers.push(data.joined);
                renderUserList();
              }
              return;
            }
            
            if (data.quit) {
              onlineUsers = onlineUsers.filter(u => u !== data.quit);
              renderUserList();
              return;
            }
            
            if (data.ready) {
              wroteWelcomeMessages = true;
              return;
            }
            
            if (data.message && data.timestamp && typeof data.message === "string" && data.message.trim()) {
			  // ä¼˜åŒ–ï¼šå…ˆåˆ¤æ–­IDæ˜¯å¦åœ¨å·²å‘é€é›†åˆä¸­ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰
			  const isSelfImageMsg = data.isImage && data.name === username && data.msgId && sentImageMsgIds.has(data.msgId);
			  if (isSelfImageMsg) {
				sentImageMsgIds.delete(data.msgId); // æ¸…ç†å·²å¤„ç†çš„ID
				console.log("è·³è¿‡è‡ªå·±å‘é€çš„å›¾ç‰‡æ¶ˆæ¯ï¼Œé¿å…é‡å¤");
				return;
			  }
			  
			  
			  // åªè¦æ ‡è®° isImage:true å°±æ˜¯å›¾ç‰‡æ¶ˆæ¯ï¼Œæ— éœ€æ ¡éªŒåç¼€
			const isImageMsg = data.isImage || (data.message.startsWith("http") && 
			  (data.message.endsWith(".jpg") || data.message.endsWith(".png") || 
			   data.message.endsWith(".gif") || data.message.endsWith(".webp")));
			  
			  // æ­£å¸¸æ¸²æŸ“æ¶ˆæ¯
			  if (data.timestamp > lastSeenTimestamp) {
				const userName = data.name ? data.name : "æœªçŸ¥ç”¨æˆ·";
				const isSelf = userName === username;
				addChatMessage(
				  isSelf ? "æˆ‘" : userName,
				  data.message.trim(),
				  false,
				  isSelf,
				  isImageMsg // ä¼ é€’å›¾ç‰‡æ¶ˆæ¯æ ‡è®°
				);
				lastSeenTimestamp = data.timestamp;
			  }
			  return;
			}
						
            console.log("å¿½ç•¥éæ ¸å¿ƒæ¶ˆæ¯:", data);
            
          } catch (e) {
            console.error("è§£ææ¶ˆæ¯å¤±è´¥:", e, "åŸå§‹æ•°æ®:", event.data);
            addChatMessage(null, `âŒ æ¶ˆæ¯è§£æå¤±è´¥: ${e.message}`, true);
          }
        };
        
        ws.onclose = (event) => {
          console.log("WebSocket è¿æ¥å…³é—­:", event.code, event.reason);
          connectStatus.style.display = "none";
          currentWebSocket = null;
          
          if (event.code !== 1000) {
            addChatMessage(null, `âš ï¸ è¿æ¥å·²æ–­å¼€ï¼ˆ${event.code}ï¼‰ï¼Œæ­£åœ¨é‡è¿...`, true);
            setTimeout(() => join(), 3000);
          }
        };
        
        ws.onerror = (error) => {
          console.error("WebSocket é”™è¯¯:", error);
          connectStatus.style.display = "none";
          addChatMessage(null, "âš ï¸ è¿æ¥å‡ºé”™ï¼Œæ­£åœ¨é‡è¿...", true);
        };
        
      } catch (e) {
        console.error("åˆ›å»º WebSocket å¤±è´¥:", e);
        addChatMessage(null, `âŒ åˆ›å»ºè¿æ¥å¤±è´¥: ${e.message}`, true);
        setTimeout(() => join(), 3000);
        return;
      }
    }

    // ========== æ·»åŠ æ¶ˆæ¯ï¼šåŒºåˆ†æ–‡å­—/å›¾ç‰‡ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰ ==========
    function addChatMessage(name, text, isSystem = false, isSelf = false, isImage = false) {

	  // è¿‡æ»¤ç©º/æ— æ•ˆæ¶ˆæ¯ï¼šå›¾ç‰‡æ¶ˆæ¯å…è®¸ text ä¸ºç©ºï¼ˆä¹è§‚æ¸²æŸ“ï¼‰
		if (!isImage && (text === undefined || text === null || text.trim() === "")) {
		  console.log("å¿½ç•¥ç©º/undefinedæ–‡å­—æ¶ˆæ¯");
		  return;
		}
		if (typeof text === "string" && text.toLowerCase() === "undefined") {
		  console.log("å¿½ç•¥'undefined'å­—ç¬¦ä¸²æ¶ˆæ¯");
		  return;
		}
			  
      console.log("æ·»åŠ æ¶ˆæ¯:", { name, text, isSystem, isSelf, isImage });
      
      // ç³»ç»Ÿæ¶ˆæ¯ï¼šåŸæœ‰é€»è¾‘
      if (isSystem) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "system-msg";
        const span = document.createElement("span");
        span.textContent = text;
        msgDiv.appendChild(span);
        chatlog.appendChild(msgDiv);
      } 
      // å›¾ç‰‡æ¶ˆæ¯ï¼šæ— æ°”æ³¡ï¼Œå›ºå®šå°ºå¯¸
      else if (isImage) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg-img ${isSelf ? "right" : "left"}`;
	
		// new add
		const contentContainer = document.createElement("div");
		  contentContainer.className = "msg-content"; // å¤ç”¨æ–‡å­—æ¶ˆæ¯çš„å®¹å™¨ç±»ï¼Œä¿è¯å¯¹é½
		  contentContainer.style.display = "flex";
		  contentContainer.style.flexDirection = "column"; // å‚ç›´æ’åˆ—ï¼ˆæ˜µç§°åœ¨ä¸Šï¼Œå›¾ç‰‡åœ¨ä¸‹ï¼‰
		  contentContainer.style.alignItems = isSelf ? "flex-end" : "flex-start"; // è·Ÿéšå·¦å³å¯¹é½

		// new  add
		
        // éè‡ªå·±çš„æ¶ˆæ¯æ˜¾ç¤ºç”¨æˆ·å
        if (!isSelf && name) {
          const nameSpan = document.createElement("span");
          nameSpan.className = "img-username";
          nameSpan.textContent = name;
          // msgDiv.appendChild(nameSpan);
		  contentContainer.appendChild(nameSpan); // âœ… æ­£ç¡®ï¼šåŠ åˆ°contentContainerä¸­
        }

        // å›ºå®šå°ºå¯¸å›¾ç‰‡å®¹å™¨
        const contentDiv = document.createElement("div");
        contentDiv.className = "img-content";
        
        // ä¹è§‚æ¸²æŸ“åŠ è½½ä¸­
        contentDiv.innerHTML = `<div class="img-loading">å›¾ç‰‡åŠ è½½ä¸­...</div>`;
        
        // å¦‚æœæ˜¯å·²ä¸Šä¼ çš„å›¾ç‰‡ï¼Œç›´æ¥åŠ è½½
        if (text.startsWith("http")) {
          const img = new Image();
          img.onload = () => {
            contentDiv.innerHTML = `<img src="${text}" onclick="window.open('${text}', '_blank')">`;
          };
          img.onerror = () => {
            contentDiv.innerHTML = `
              <div class="img-error">
                <svg viewBox="0 0 24 24">
                  <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                  <path d="M12 10l-2 2 2 2 2-2-2-2zm0-6v2h2V4h-2zm0 12v2h2v-2h-2z"/>
                </svg>
                <span>å›¾ç‰‡åŠ è½½å¤±è´¥</span>
              </div>
            `;
          };
          img.src = text;
        }
		
		contentContainer.appendChild(contentDiv); // âœ… æ­£ç¡®ï¼šæ·»åŠ åˆ°contentContainer
		  // æŠŠcontentContaineræ·»åŠ åˆ°msgDiv
		  msgDiv.appendChild(contentContainer); // âœ… æœ€ç»ˆæ‹¼æ¥
		  chatlog.appendChild(msgDiv);
		
        // msgDiv.appendChild(contentDiv);
        // chatlog.appendChild(msgDiv);
		
      }
      // æ–‡å­—æ¶ˆæ¯ï¼šä¿ç•™åŸæœ‰æ°”æ³¡
      else {
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${isSelf ? "right" : "left"}`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "msg-content";

        if (!isSelf && name) {
          const nameSpan = document.createElement("span");
          nameSpan.className = "username";
          nameSpan.textContent = name;
          contentDiv.appendChild(nameSpan);
        }

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = "bubble";
        bubbleDiv.innerHTML = formatMessageText(text);
        contentDiv.appendChild(bubbleDiv);
        msgDiv.appendChild(contentDiv);
        chatlog.appendChild(msgDiv);
      }

      // æ»šåŠ¨åˆ°åº•éƒ¨
      if (isAtBottom) {
        chatlog.scrollBy(0, 1e8);
      }
    }

    // ========== é¡µé¢åŠ è½½åˆå§‹åŒ– ==========
    window.addEventListener("load", () => {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ç™»å½•è¡¨å•");
      userListPage = document.querySelector("#user-list-page");
      tabUserList = document.querySelector("#tab-user-list");
      tabChat = document.querySelector("#tab-chat");
      usersList = document.querySelector("#users-list");
      initLoginForm();
	  adjustInputHeight();
    });
	
    // ========== é¡µé¢å…³é—­æ¸…ç†è¿æ¥ ==========
    window.addEventListener("beforeunload", () => {
	  if (currentWebSocket) {
		try {
		  currentWebSocket.send(JSON.stringify({ type: "quit", username: username }));
		} catch (e) {}
		currentWebSocket.close(1000, "é¡µé¢å…³é—­");
		currentWebSocket = null;
	  }
	});
  </script>
</body>
</html>