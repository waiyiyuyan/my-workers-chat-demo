<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>微信聊天室</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,"Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
  background:#dbdbdb;                     /* 微信2.0经典灰底 */
  height:100vh;overflow:hidden;
  -webkit-text-size-adjust:none;
}

/* ==================== 顶部栏 ==================== */
#topbar{
  position:fixed;top:0;left:0;right:0;height:64px;
  background:linear-gradient(#a5a39a,#8e8c84);
  box-shadow:0 1px 4px rgba(0,0,0,0.4);
  color:#fff;text-align:center;line-height:64px;
  font-size:18px;font-weight:bold;text-shadow:0 -1px 0 rgba(0,0,0,0.6);
  z-index:100;display:none;
}
#back-btn{
  position:absolute;left:12px;top:0;bottom:0;margin:auto;
  height:44px;line-height:44px;font-size:16px;color:#fff;opacity:0.9;cursor:pointer;
}

/* ==================== 聊天区域 ==================== */
#chatlog{
  position:fixed;top:64px;bottom:54px;left:0;right:0;
  overflow-y:auto;padding:10px 8px 0;
  background:#dbdbdb;
  -webkit-overflow-scrolling:touch;
}

/* 别人消息（左边灰白） */
.msg.left{clear:both;float:left;margin:8px 10px 8px 10px;max-width:72%;}
.msg.left .bubble{
  background:#ffffff;border:1px solid #c8c7cc;border-radius:10px;
  padding:9px 13px;font-size:17px;line-height:1.45;color:#000;
  position:relative;box-shadow:0 1px 2px rgba(0,0,0,0.15);
}
.msg.left .bubble::before{
  content:"";position:absolute;left:-6px;top:10px;
  border:6px solid transparent;border-right-color:#fff;
}

/* 自己消息（右边经典绿） */
.msg.right{clear:both;float:right;margin:8px 10px 8px 10px;max-width:72%;}
.msg.right .bubble{
  background:#9fe15a;border-radius:10px;
  padding:9px 13px;font-size:17px;line-height:1.45;color:#000;
  position:relative;box-shadow:0 1px 2px rgba(0,0,0,0.15);
}
.msg.right .bubble::before{
  content:"";position:absolute;right:-6px;top:10px;
  border:6px solid transparent;border-left-color:#9fe15a;
}

/* 时间标签（可选） */
.msg .header{font-size:12px;color:#888;margin-bottom:4px;padding:0 8px;}
.msg.right .header{text-align:right;}

/* ==================== 输入栏（2012经典深灰） ==================== */
#input-bar{
  position:fixed;bottom:0;left:0;right:0;height:54px;
  background:#c9c9c9;border-top:1px solid #a0a0a0;
  display:flex;align-items:center;padding:0 8px;
}
#chat-input{
  flex:1;height:36px;background:#fff;border:1px solid #9f9f9f;
  border-radius:6px;padding:0 10px;font-size:17px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.3);margin-right:8px;
}
#send-btn{
  width:64px;height:36px;
  background:linear-gradient(#8cc44a,#6f9f2b);border:1px solid #5d801e;
  border-radius:6px;color:#fff;font-weight:bold;font-size:16px;
  box-shadow:0 1px 3px rgba(0,0,0,0.4);
}

/* ==================== 登录页（2011微信风格） ==================== */
#start-form{
  position:fixed;inset:0;
  background:#c9c9c9;                         /* 深灰底，和输入栏一致 */
  display:flex;justify-content:center;align-items:center;
  z-index:10;
}
#start-box{
  width:90%;max-width:320px;
  background:#f1f1f1;
  border:1px solid #b0b0b0;
  border-radius:8px;
  padding:30px 20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.4);
  text-align:center;
}
#start-box h2{
  font-size:20px;color:#000;margin-bottom:25px;
  font-weight:normal;
}
#start-box input{
  width:100%;padding:12px 10px;margin:10px 0;
  border:1px solid #a0a0a0;border-radius:6px;
  background:#fff;font-size:17px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,0.2);
}
#start-box button{
  width:100%;padding:13px;margin:10px 0;
  border-radius:6px;border:1px solid #5d801e;
  font-size:17px;font-weight:bold;color:#fff;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
}
#join-public{background:linear-gradient(#8cc44a,#6f9f2b);}
#create-private{background:linear-gradient(#8cc44a,#6f9f2b);}
#rejoin-last-btn{
  background:linear-gradient(#ff9a00,#ff7300);
  border:1px solid #d85400;
}
#start-box p{
  margin-top:20px;color:#666;font-size:13px;
}
</style>
</head>
<body>

<div id="topbar">
  <div id="back-btn" onclick="backToLogin()">返回</div>
  <span id="room-title">聊天室</span>
</div>

<div id="start-form">
  <div id="start-box">
    <h2>微信聊天室</h2>
    <input id="name-input" placeholder="你的名字（必填）" maxlength="20">
    <input id="room-input" placeholder="房间名（可选）" maxlength="30">
    <button type="button" id="join-public">加入公共房间</button>
    <button type="button" id="create-private">创建私人房间</button>
    <button type="button" id="rejoin-last-btn" style="display:none;">重新进入上一个私人房间</button>
    <p style="margin-top:25px;color:#888;font-size:13px">微信 2.0 复古风 · 2025 复刻版</p>
  </div>
</div>

<div id="chatroom" style="display:none">
  <div id="chatlog"></div>
  <div id="input-bar">
    <input id="chat-input" placeholder="说点什么...">
    <button id="send-btn" onclick="sendMessage()">发送</button>
  </div>
</div>

<script>
// 防重名 + 记住上一个私人房间
// 首次打开网页时清空上次残留的房间记录（这样就不会出现“重新进入”按钮）
if (!sessionStorage.getItem("hasVisited")) {
  localStorage.removeItem("lastPrivateRoom");
  sessionStorage.setItem("hasVisited", "true");
}
let realName = "";
// let uniqueId = "";
let uniqueId = localStorage.getItem("myUniqueId") || generateId();
if (!uniqueId) {
  uniqueId = generateId();
  localStorage.setItem("myUniqueId", uniqueId);
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 8);
}

const chatlog = document.getElementById("chatlog");
const chatInput = document.getElementById("chat-input");
const startForm = document.getElementById("start-form");
const chatroom = document.getElementById("chatroom");
const topbar = document.getElementById("topbar");
let username = "", roomname = "", ws = null;
const hostname = location.host.includes('localhost') ? 'localhost:8788' : 'edge-chat-demo.cloudflareworkers.com';
let isAtBottom = true;
let welcomeDone = false;

function backToLogin() {
  if (ws) ws.close();
  chatroom.style.display = "none";
  topbar.style.display = "none";
  startForm.style.display = "flex";
  chatlog.innerHTML = "";
  welcomeDone = false;
  location.hash = "";

  // 恢复按钮
  const createBtn = document.getElementById("create-private");
  createBtn.disabled = false;
  createBtn.textContent = "创建私人房间";

  // 把上一个私人房间填回去 + 显示“重新进入”按钮
  const lastRoom = localStorage.getItem("lastPrivateRoom");
  if (lastRoom && lastRoom !== "default-room") {
    document.getElementById("room-input").value = lastRoom;
  }
  checkRejoinButton();
}

function getTimeStr() {
  const h = new Date().getHours();
  const m = new Date().getMinutes().toString().padStart(2,'0');
  return (h < 12 ? "上午 " : "下午 ") + ((h+11)%12+1) + ":" + m;
}

function addMessage(name, text, type = "normal") {
  const displayName = name?.includes("##") ? name.split("##")[0] : name || "匿名";
  const isMe = name === username;

  const div = document.createElement("div");
  if (type === "system") {
    div.className = "msg system";
    div.innerHTML = `<div class="bubble">${text}</div>`;
  } else {
    div.className = `msg ${isMe ? "right" : "left"}`;
    const header = document.createElement("div");
    header.className = "header";
    header.textContent = `${displayName}  ${getTimeStr()}`;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;
    div.appendChild(header);
    div.appendChild(bubble);
  }
  chatlog.appendChild(div);
  if (isAtBottom) chatlog.scrollTop = chatlog.scrollHeight;
}

chatlog.addEventListener("scroll", () => {
  isAtBottom = chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 50;
});

function startChat() {
  // 记住当前房间（关键！）
  localStorage.setItem("lastPrivateRoom", roomname);

  roomname = (roomname || document.getElementById("room-input").value.trim() || "default-room")
    .replace(/[^a-zA-Z0-9_-]/g,"").toLowerCase() || "default-room";
  location.hash = roomname;
  document.getElementById("room-title").textContent = roomname === "default-room" ? "公共聊天室" : "私密房间";
  startForm.style.display = "none";
  chatroom.style.display = "block";
  topbar.style.display = "block";
  chatInput.focus();
  connectWebSocket();
}

// 加入公共房间
document.getElementById("join-public").onclick = () => {
  realName = document.getElementById("name-input").value.trim();
  if (!realName) return alert("请填写昵称！");
  // uniqueId = generateId();
  username = `${realName}##${uniqueId}`;
  roomname = document.getElementById("room-input").value.trim();
  startChat();
};

// 创建私人房间
document.getElementById("create-private").onclick = async () => {
  realName = document.getElementById("name-input").value.trim();
  if (!realName) return alert("请填写昵称！");
  const btn = document.getElementById("create-private");
  btn.disabled = true;
  btn.textContent = "创建中…";
  // uniqueId = generateId();
  username = `${realName}##${uniqueId}`;
  try {
    const res = await fetch(`https://${hostname}/api/room`, {method:"POST"});
    roomname = await res.text();
    startChat();
  } catch {
    alert("创建失败，请重试");
    btn.disabled = false;
    btn.textContent = "创建私人房间";
  }
};

// 一键重新进入上一个私人房间
function checkRejoinButton() {
  const lastRoom = localStorage.getItem("lastPrivateRoom");
  const btn = document.getElementById("rejoin-last-btn");
  if (lastRoom && lastRoom !== "default-room") {
    btn.style.display = "block";
    btn.onclick = () => {
      document.getElementById("room-input").value = lastRoom;
      document.getElementById("join-public").click();
    };
  } else {
    btn.style.display = "none";
  }
}

// 页面加载时检查
window.addEventListener("load", () => {
  const hashRoom = location.hash.substring(1);
  if (hashRoom) document.getElementById("room-input").value = hashRoom;
  checkRejoinButton();
});

function connectWebSocket() {
  if (ws) ws.close();
  welcomeDone = false;
  const protocol = location.protocol === "https:" ? "wss://" : "ws://";
  ws = new WebSocket(`${protocol}${hostname}/api/room/${roomname}/websocket`);

  ws.onopen = () => ws.send(JSON.stringify({name: username}));
  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.error) addMessage("系统", "错误 " + d.error, "system");
    else if (d.ready && !welcomeDone) welcomeDone = true;
    else if (d.message) addMessage(d.name || "匿名", d.message);
  };
  ws.onclose = ws.onerror = () => {
    addMessage("系统", "连接断开，3秒后重连…", "system");
    setTimeout(connectWebSocket, 3000);
  };
}

function sendMessage() {
  const msg = chatInput.value.trim();
  if (msg && ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({message: msg}));
    chatInput.value = "";
  }
}

chatInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>