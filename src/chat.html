<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <title>CF Chat</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIuMDAwMSAxNC41TDcuNTAwMSAxMEMxMi41MDAxIDEwIDEyLjUwMDEgMTAgMTcuNTAwMSAxMCIgc3Ryb2tlPSIjNzdjYzAwIiBzdHJva2Utd2lkdGg9IjIuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+" type="image/svg+xml">
  <style>
    /* å…¨å±€é‡ç½® & iOSå­—ä½“ + å¾®ä¿¡é£æ ¼åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      background-color: #EDEDED;
      color: #333;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    /* å·¥å…·ç±» */
    .hide { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .flex-1 { flex: 1; }
    .text-center { text-align: center; }
    .text-green { color: #07C160 !important; }
    .bg-white { background-color: #fff; }
    .rounded-full { border-radius: 50%; }
    .clickable {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s ease;
    }
    .clickable:active { opacity: 0.8; }

    /* é¡¶éƒ¨å¯¼èˆªæ ï¼ˆå¾®ä¿¡é£æ ¼ï¼šç™½è‰²èƒŒæ™¯ + åº•éƒ¨é»‘çº¿ï¼‰ */
    .header {
	  position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  height: 50px; /* å’Œåº•éƒ¨é€‰é¡¹å¡é«˜åº¦ä¸€è‡´ */
	  background-color: #fff; /* ä¸åº•éƒ¨é€‰é¡¹å¡èƒŒæ™¯ä¸€è‡´ */
	  border-bottom: 1px solid #E5E5E5; /* ä¸åº•éƒ¨é€‰é¡¹å¡é¡¶éƒ¨è¾¹æ¡†ä¸€è‡´ */
	  display: flex; /* å¤ç”¨åº•éƒ¨é€‰é¡¹å¡å¸ƒå±€æ–¹å¼ */
	  z-index: 100;
	  /* æ— å†…è¾¹è·ï¼ŒæŒ‰é’®ç›´æ¥å¡«å…… */
	  padding: 0;
	}
    	
    /* å¯¼èˆªæ æŒ‰é’®ï¼šæ”¹ä¸ºåº•éƒ¨é€‰é¡¹å¡.tab-itemåŒæ¬¾æ ·å¼ */
	.header-tab-item {
	  /* ä¸åº•éƒ¨é€‰é¡¹å¡å®Œå…¨ä¸€è‡´çš„å®½åº¦è®¾ç½® */
	  flex: 0 0 50%;
	  max-width: 50%;
	  height: 100%;
	  display: flex;
	  align-items: center; /* å‚ç›´å±…ä¸­ */
	  justify-content: center; /* æ°´å¹³å±…ä¸­ï¼ˆæ–‡å­—å±…ä¸­ï¼Œä¸åº•éƒ¨ä¸€è‡´ï¼‰ */
	  font-size: 16px; /* ä¸åº•éƒ¨é€‰é¡¹å¡å­—ä½“å¤§å°ä¸€è‡´ */
	  color: #000 !important; /* ä¸åº•éƒ¨é€‰é¡¹å¡æ–‡å­—é¢œè‰²ä¸€è‡´ */
	  font-weight: 500; /* ä¸åº•éƒ¨é€‰é¡¹å¡å­—ä½“ç²—ç»†ä¸€è‡´ */
	  position: relative;
	  cursor: pointer;
	  -webkit-tap-highlight-color: transparent;
	  transition: all 0.1s ease;
	  -webkit-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}

	/* è¿”å›æŒ‰é’®å·¦ä¾§åˆ†éš”çº¿ï¼ˆå’Œåº•éƒ¨é€‰é¡¹å¡.decorative-tabä¸€è‡´ï¼‰ */
	.header-tab-item.decorative-tab::after,
	.tab-item.decorative-tab::after {
	  content: "";
	  position: absolute;
	  right: 0; /* å¡åœ¨ä¸¤ä¸ªæŒ‰é’®ä¸­é—´ï¼Œä¸åº•éƒ¨åˆ†éš”çº¿å¯¹é½ */
	  top: 0;
	  bottom: 0;
	  width: 2px; /* ä¸åº•éƒ¨åˆ†éš”çº¿å®½åº¦ä¸€è‡´ */
	  background-color: #E5E5E5; /* ä¸åº•éƒ¨åˆ†éš”çº¿é¢œè‰²ä¸€è‡´ */
	  height: 100%; /* è´¯ç©¿æ•´ä¸ªé«˜åº¦ï¼Œä¸åº•éƒ¨ä¸€è‡´ */
	}

	/* æŒ‰é’®ç‚¹å‡»æ•ˆæœï¼ˆå’Œåº•éƒ¨é€‰é¡¹å¡ä¸€è‡´ï¼‰ */
	.header-tab-item:active,
	.tab-item:active {
	  opacity: 0.8;
	  background-color: #f5f5f5;
	  border-radius: 4px;
	}

	/* ä¿ç•™åŸæœ‰header-btnç±»çš„å…¼å®¹æ€§ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰ */
	.header-btn {
	  border: none;
	  background: transparent;
	  outline: none;
	}

	/* è°ƒæ•´è¿”å›æŒ‰é’®å›¾æ ‡å‚ç›´å±…ä¸­ */
	.back-btn svg {
	  vertical-align: middle;
	}
    /* ç§»é™¤è¿æ¥çŠ¶æ€æ˜¾ç¤º */
    .connect-status { display: none !important; }

    /* ç™»å½•é¡µé¢ï¼ˆå¾®ä¿¡ç™»å½•é£æ ¼ï¼‰ */
    .login-page {
      position: fixed;
	  top: 0;
	  left: 0;
	  right: 0;
	  bottom: 0;
	  background-color: #EDEDED;
	  padding-top: 0; /* æŠŠä¹‹å‰çš„80pxæ”¹æˆ0 */
	  z-index: 110;
    }
    
    .login-container {
      width: 90%;
      max-width: 400px;
      margin: 0 auto;
	  height: calc(100vh - 120px); /* å æ»¡ç™»å½•é¡µå‰©ä½™é«˜åº¦ */
	  display: flex;
	  flex-direction: column;
	  justify-content: center; /* å‚ç›´å±…ä¸­ */
    }
    
    .input-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .input-underline {
      display: block;
      width: 100%;
      height: 45px;
      padding: 8px 0;
      border: none;
      border-bottom: 1px solid #D9D9D9;
      background-color: transparent;
      font-size: 16px;
      color: #333;
      outline: none;
    }
    
    .input-underline::placeholder {
      color: #999;
      font-size: 15px;
    }
    
    .input-underline:focus {
      border-bottom-color: #77cc00;
    }
    
    .enter-btn {
      display: block;
      width: 100%;
      height: 48px;
      line-height: 48px;
      background-color: #77cc00;
      color: #fff;
      text-align: center;
      font-size: 16px;
      font-weight: 500;
      border-radius: 2px;
      margin: 30px 0;
      box-shadow: 0 2px 8px rgba(7, 193, 96, 0.3);
      text-decoration: none;
	  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
    }
    
    .login-footer {
      position: fixed;
	  top: auto; /* è·ç¦»é¡¶éƒ¨70%é«˜åº¦ä½ç½®ï¼Œå¯æ”¹å…·ä½“åƒç´ å¦‚400px */
	  left: 0;
	  right: 0;
	  text-align: center;
	  font-size: 14px;
	  color: #999;
	  bottom: 40px; /* è¦†ç›–åŸæœ‰bottomå€¼ */
    }
    
    .login-footer a {
      color: #77cc00;
      text-decoration: none;
    }

    /* èŠå¤©é¡µé¢ */
	.chat-page {
	  position: fixed;
	  top: 50px;
	  left: 0;
	  right: 0;
	  bottom: 50px; /* ä¸è¾“å…¥æ æœ€å°é«˜åº¦ä¸€è‡´ */
	  background-color: #EDEDED;
	  z-index: 80;
	}
    
    .chatlog {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      padding: 10px 15px;
      -webkit-overflow-scrolling: touch;
    }
    
    .chatlog::-webkit-scrollbar {
      width: 0;
    }

    /* æ¶ˆæ¯æ ·å¼ï¼ˆå¾®ä¿¡ç»å…¸æ°”æ³¡ï¼šç§»é™¤å¤´åƒ + æ˜µç§°ä¸Šä¸‹ç»“æ„ï¼‰ */
    .msg {
      display: flex;
      margin-bottom: 12px;
      max-width: 100%;
      flex-direction: column; /* çºµå‘æ’åˆ—æ˜µç§°å’Œæ°”æ³¡ */
    }
    
    .msg-left { align-items: flex-start; margin-right: 20%; }
    .msg-right { align-items: flex-end; margin-left: 20%; }
    
    /* ç§»é™¤å¤´åƒæ ·å¼ */
    .msg-avatar { display: none !important; }
    
    .msg-content {
      max-width: 80%;
    }
    
    /* æ˜µç§°æ ·å¼ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¾ç¤ºæ˜µç§°ï¼ˆä¸Šä¸‹ç»“æ„ï¼‰ */
    .msg-name {
      font-size: 12px;
      color: #999;
      margin-bottom: 4px;
      padding-left: 2px;
	  display: none !important;
    }
    
    .msg-bubble {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 15px;
      line-height: 1.6;
      word-wrap: break-word;
      position: relative;
    }
    
    .msg-left .msg-bubble {
      background-color: #fff;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .msg-right .msg-bubble {
      background-color: #77cc00;
      color: #000 !important;
      border-bottom-right-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .msg-bubble a {
      color: #007AFF;
      text-decoration: underline;
      word-break: break-all;
    }
    
    .msg-right .msg-bubble a { color: blue !important }
    
    /* éšè—ç³»ç»Ÿæ¶ˆæ¯ï¼ˆè°åŠ å…¥/ç¦»å¼€æˆ¿é—´ï¼‰ */
    .system-msg { display: none !important; }

    /* æ¶ˆæ¯çŠ¶æ€æ ·å¼ï¼šå‘é€ä¸­/å¤±è´¥ */
	.msg-status-wrapper {
	  text-align: right;
	  margin-top: 4px;
	  font-size: 12px;
	}
	.msg-status {
	  color: #999;
	}
	.msg-status.sending { color: #999; }
	.msg-status.success { color: #07C160; }
	.msg-status.fail { color: #d32f2f; }
    
    /* åº•éƒ¨è¾“å…¥æ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰ */
	.input-bar {
	  position: fixed;
	  bottom: 0; /* æ”¹å›0ï¼Œé¿å…1pxé—´éš™ */
	  left: 0;
	  right: 0;
	  height: auto;
	  min-height: 50px;
	  background-color: #fff;
	  border-top: 1px solid #E5E5E5;
	  padding: 7px 15px;
	  display: flex;
	  align-items: flex-end; /* æ‰€æœ‰å­å…ƒç´ åº•éƒ¨å¯¹é½ */
	  justify-content: flex-start; /* å·¦å¯¹é½ */
	  z-index: 90;
	  /* æ–°å¢ï¼šè°ƒæ•´å†…è¾¹è·ï¼Œé€‚é…ä¸‹åˆ’çº¿è¾“å…¥æ¡† */
	  padding-left: 12px;
	  padding-right: 12px;
	}
    
    
.input-tools {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px; /* ä¸å‘é€æŒ‰é’®/è¾“å…¥æ¡†åŒé«˜ */
  margin-right: 10px;
  flex-shrink: 0;
}
    
	.tool-btn {
	  width: 100%;
	  height: 100%;
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  color: #07C160;
	  font-size: 28px;
	  border-radius: 2px;
	  -webkit-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	  background-color: #fff; /* ä¸è¾“å…¥æ¡†èƒŒæ™¯ä¸€è‡´ */
	  
	}
    
    .tool-btn:active {
      background-color: #E5E5E5;
    }
    
	.chat-input {
	  flex: 1;
	  height: 36px; /* ä¸ min-height ä¸€è‡´ï¼Œå›ºå®šåˆå§‹é«˜åº¦ */
	  min-height: 36px;
	  max-height: 120px;
	  padding: 8px 0;
	  background-color: transparent;
	  border: none;
	  border-bottom: 1px solid #D9D9D9;
	  border-radius: 0;
	  outline: none;
	  font-size: 15px;
	  line-height: 22px;
	  white-space: pre-wrap;
	  word-wrap: break-word;
	  overflow-y: auto; /* ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
	  scrollbar-width: none; /* å…³é”®1ï¼šFirefox - éšè—æ»šåŠ¨æ¡ä¸”ä¸å ä½ */
	  -ms-overflow-style: none; /* å…³é”®2ï¼šIE/Edge - éšè—æ»šåŠ¨æ¡ä¸”ä¸å ä½ */
	  display: flex;
	  flex-direction: column;
	  justify-content: flex-start;
	  align-self: flex-end;
	  vertical-align: top;
	  text-align: left;
	  box-sizing: border-box;
	}
	
	.chat-input::-webkit-scrollbar {
	  display: none !important; /* æ›¿ä»£åŸæœ‰ width: 4px; å½»åº•éšè— */
	}
.chat-input br {
  display: block;
}
.chat-input:not(:empty) br {
  display: block;
  content: "";
  
}
.chat-input:empty:before {
  content: attr(placeholder);
  color: #999;
  position: absolute;
  top: 8px;
  left: 12px;
  pointer-events: none;
  content: "" !important; /* å½»åº•æ¸…ç©ºæç¤ºæ–‡æœ¬ */
  
}

.chat-input::-webkit-scrollbar {
  width: 4px;
}
    
.chat-input:focus {
  border-bottom-color: #77cc00 !important;
  box-shadow: none !important; /* ç§»é™¤é»˜è®¤èšç„¦é˜´å½±ï¼Œä¿æŒç®€æ´ */
}
	.send-btn {
	  width: 60px;
	  height: 36px; /* ä¸è¾“å…¥æ¡†ç­‰é«˜ */
	  line-height: 36px;
	  text-align: center;
	  background-color: #77cc00;
	  color: #000 !important;
	  border-radius: 2px;
	  font-size: 15px;
	  font-weight: 500;
	  margin-left: 10px;
	  flex-shrink: 0; /* ä¸å‹ç¼© */
	  align-self: flex-end; /* ä¸è¾“å…¥æ¡†åº•éƒ¨å¯¹é½ */
	  -webkit-user-select: none;
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}
    
    .send-btn.disabled {
      background-color: #999;
      pointer-events: none;
      opacity: 0.5;
    }

    /* ç”¨æˆ·åˆ—è¡¨é¡µé¢ */
    .user-list-page {
	  position: fixed;
	  top: 50px; /* å¯¼èˆªæ é«˜åº¦æ˜¯44pxï¼Œè¿™ä¸ªå€¼å¿…é¡»å’Œå¯¼èˆªæ é«˜åº¦ä¸€è‡´ï¼Œç´§è´´å¯¼èˆªæ åº•éƒ¨ */
	  left: 0;
	  right: 0;
	  bottom: 0;
	  background-color: #EDEDED;
	  z-index: 85;
	  /* ç§»é™¤å¯èƒ½å¯¼è‡´é—´è·çš„æ ·å¼ï¼ˆå…³é”®ï¼‰ */
	  margin-top: 0;
	  padding-top: 0;
	}
    
    /* éšè—ç”¨æˆ·åˆ—è¡¨é¡¶éƒ¨çš„æˆ¿é—´ä¿¡æ¯ */
    .user-list-header { display: none !important; }
    
    .user-list {
      list-style: none;
      background-color: #fff;
    }
    
    .user-item {
	  display: flex;
	  align-items: center; /* å‚ç›´å±…ä¸­ */
	  padding: 12px 15px;
	  border-bottom: 1px solid #E5E5E5;
	  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
	  -moz-user-select: none;
	  -ms-user-select: none;
	  user-select: none;
	}

    
    .user-item:active {
      background-color: #E5E5E5;
    }
    
    /* ç§»é™¤ç”¨æˆ·åˆ—è¡¨å¤´åƒ */
    .user-avatar {
	  width: 36px;
	  height: 36px;
	  border-radius: 50%;
	  overflow: hidden;
	  position: relative;
	  margin-right: 12px;
	}
	.user-avatar svg {
	  width: 100%;
	  height: 150%; /* æ‹‰ä¼¸é«˜åº¦ */
	  position: absolute;
	  top: -25%; /* å‘ä¸Šåç§»ï¼Œéšè—é¡¶éƒ¨åœ†å½¢ */
	  left: 0;
	  fill: #07C160; /* äººå½¢é¢œè‰² */
	}
	.user-avatar svg path {
	  fill: black; /* æˆ– #000ã€#333ï¼ˆæ·±ç°ï¼‰ç­‰ */
	}
    .user-name {
      font-size: 16px;
      color: #333;
      
    }
    
    /* åº•éƒ¨é€‰é¡¹å¡ï¼ˆå¾®ä¿¡é£æ ¼ï¼šé»‘è‰²æ–‡å­— + é—´éš™åˆ†éš”ï¼‰ */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 50px;
  background-color: #fff;
  border-top: 1px solid #E5E5E5;
  display: flex;
  z-index: 95;
}
    
.tab-item {
  /* æ›¿æ¢åŸæœ‰çš„ flex: 1; ä¸ºä»¥ä¸‹ä¸¤è¡Œ */
  flex: 0 0 50%; /* å›ºå®š50%å®½åº¦ï¼Œä¸æ‹‰ä¼¸/å‹ç¼© */
  max-width: 50%; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æº¢å‡º */
  
  /* ä»¥ä¸‹åŸæœ‰æ ·å¼å…¨éƒ¨ä¿ç•™ */
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center; /* æ–‡å­—æ°´å¹³å±…ä¸­ */
  font-size: 16px;
  color: #000 !important; /* ç»Ÿä¸€çº¯é»‘ */
  font-weight: 500;
  position: relative;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  transition: all 0.1s ease;
  -webkit-user-select: none;  /* ç¦æ­¢æ–‡å­—é€‰ä¸­ */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.tab-item:active {
  opacity: 0.8;
  background-color: #f5f5f5;
  border-radius: 4px;
}

.decorative-tab:active {
  opacity: 0.8;
  background-color: #f5f5f5;
  border-radius: 4px;
}
.tab-divider { display: none !important; }


    /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 480px) {
	  .chat-input {
		min-height: 34px;
		padding: 6px 10px;
		line-height: 20px;
		justify-content: flex-start !important;
	  }
	  .tab-item {
		font-size: 14px;	
	  }
	  /* ç§»åŠ¨ç«¯å›¾ç‰‡æŒ‰é’®é€‚é… */
	   .input-tools {
			width: 55px; /* æ”¹ä¸ºç§»åŠ¨ç«¯å‘é€æŒ‰é’®åŒæ¬¾å®½åº¦ï¼ˆåŸ55pxï¼Œæ— éœ€æ”¹ï¼Œç¡®è®¤å³å¯ï¼‰ */
			height: 34px; /* ä¿æŒå’Œç§»åŠ¨ç«¯å‘é€æŒ‰é’®åŒæ¬¾é«˜åº¦ */
		  }
		  /* ç§»åŠ¨ç«¯å›¾ç‰‡æŒ‰é’®ï¼šåŒæ­¥æ”¾å¤§å›¾æ ‡ */
		  .tool-btn {
			font-size: 26px; /* ç§»åŠ¨ç«¯å›¾æ ‡ç¨å°ä¸€ç‚¹ï¼Œé€‚é…55pxÃ—34pxå®¹å™¨ */
		  }
	  .send-btn { 
		width: 55px; 
		height: 34px; 
		line-height: 34px; 
		font-size: 14px; 
		color: #000 !important; /* ç§»åŠ¨ç«¯æ–‡å­—ä¹Ÿä¸ºé»‘è‰² */
	  }
    }
	
.tab-item.has-unread::after {
  content: attr(data-unread); /* åŠ¨æ€æ˜¾ç¤ºæœªè¯»æ•°å­— */
  position: absolute;
  top: 5px; /* çº¢ç‚¹å‚ç›´ä½ç½®ï¼šé é€‰é¡¹å¡é¡¶éƒ¨ */
  right: 20%; /* çº¢ç‚¹æ°´å¹³ä½ç½®ï¼šåå³ï¼Œä¸é®æŒ¡ã€ŒèŠå¤©ã€æ–‡å­— */
  min-width: 16px; /* çº¢ç‚¹æœ€å°å®½åº¦ï¼Œä¿è¯å•ä¸ªæ•°å­—å±…ä¸­ */
  height: 16px; /* çº¢ç‚¹é«˜åº¦ */
  line-height: 16px; /* æ•°å­—å‚ç›´å±…ä¸­ */
  padding: 0 4px; /* å·¦å³å†…è¾¹è·ï¼Œé€‚é…å¤šæ•°å­—/99+ */
  background-color: #ff3b30; /* å¾®ä¿¡ç»å…¸çº¢è‰²ï¼Œé†’ç›®ä¸çªå…€ */
  color: #ffffff; /* æ•°å­—é¢œè‰²ï¼šç™½è‰² */
  font-size: 12px; /* æ•°å­—å­—ä½“å¤§å° */
  font-weight: 500; /* æ•°å­—åŠ ç²— */
  border-radius: 8px; /* åœ†è§’çŸ©å½¢ï¼Œæ›´ç¾è§‚ï¼ˆæƒ³è¦åœ†å½¢å°±æ”¹50%ï¼‰ */
  text-align: center; /* æ•°å­—æ°´å¹³å±…ä¸­ */
  z-index: 10; /* ç¡®ä¿çº¢ç‚¹åœ¨æ–‡å­—ä¸Šæ–¹æ˜¾ç¤º */
  display: block;
}

/* æ— æœªè¯»æ¶ˆæ¯æ—¶ï¼Œéšè—çº¢ç‚¹ */
.tab-item:not(.has-unread)::after {
  display: none;
}
/* ========== çº¢ç‚¹æ ·å¼ç»“æŸ ========== */
  </style>
</head>
<body>
<!-- é¡¶éƒ¨å¯¼èˆªï¼šæ”¹ä¸ºé€‰é¡¹å¡åŒæ¬¾å¼¹æ€§å¸ƒå±€ -->
	<div class="header">
	  <!-- å·¦ä¾§ï¼šè¿”å›æŒ‰é’®ï¼ˆå’Œåº•éƒ¨é€‰é¡¹å¡æ ·å¼ç»Ÿä¸€ï¼‰ -->
	  
	  <div class="header-tab-item header-btn back-btn clickable hide">
		è¿”å›ä¸Šä¸€é¡µ
	  </div>
	  <!-- å³ä¾§ï¼šåˆ†äº«æŒ‰é’®ï¼ˆå’Œåº•éƒ¨é€‰é¡¹å¡æ ·å¼ç»Ÿä¸€ï¼‰ -->
	  <div class="header-tab-item header-btn share-btn clickable hide">åˆ†äº«èŠå¤©å®¤</div>
	</div>

  <!-- ç™»å½•é¡µé¢ -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
		<div class="login-logo" style="text-align: center; margin-bottom: 30px;">
		<svg width="196" height="40" viewBox="0 0 196 40" fill="none" xmlns="http://www.w3.org/2000/svg">
		  <text x="98" y="28" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif; font-size: 24px; font-weight: 600; text-anchor: middle;">
			<tspan fill="#77cc00">CF</tspan>
			<tspan fill="#333333" dx="4">Chat</tspan> <!-- ä»…ä¿ç•™dxé—´è·ï¼Œç§»é™¤xå’Œdy -->
		  </text>
		</svg>
	  </div>
      <div class="input-item">
        <input type="text" id="nameInput" class="input-underline" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" autocomplete="off">
      </div>
	  
	  <a href="javascript:void(0)" class="enter-btn clickable" id="enterBtn">è¿›å…¥æˆ¿é—´</a>
    </div>
    <div class="login-footer">
      åŸºäº Cloudflare Workers æ„å»º<br>
      <a href="https://blog.cloudflare.com/introducing-workers-durable-objects" target="_blank">äº†è§£æ›´å¤š</a>
    </div>
  </div>

  <!-- èŠå¤©é¡µé¢ -->
  <div class="chat-page hide" id="chatPage">
    <div class="chatlog" id="chatlog"></div>
    <div class="input-bar">
      <div class="input-tools">
        <label for="imageUpload" class="tool-btn clickable">ğŸ“·</label>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
      </div>
      <div id="chatInput" class="chat-input" contenteditable="true"></div>
      <div class="send-btn clickable" id="sendBtn">å‘é€</div>
    </div>
  </div>

  <!-- ç”¨æˆ·åˆ—è¡¨é¡µé¢ -->
  <div class="user-list-page hide" id="userListPage">
    <div class="user-list-header" id="roomStatus">å½“å‰æˆ¿é—´ï¼šæš‚æ— ç”¨æˆ·</div>
    <ul class="user-list" id="userList"></ul>
    <div class="tab-bar">
	  <div class="tab-item" id="tabUser">
        ç”¨æˆ·
      </div>
      <div class="tab-item clickable" id="tabChat">
        èŠå¤©
      </div>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒé…ç½®
    const CONFIG = {
      MAX_RECONNECT: 5, // å¢åŠ é‡è¿æ¬¡æ•°
      RECONNECT_INTERVAL: 3000,
      HEARTBEAT_INTERVAL: 60000,
      IMGBB_API_KEY: "151fe87bf32e4e7837d1d4174d36b164",
      MAX_IMG_SIZE: 10 * 1024 * 1024, // 10MB
      MAX_MSG_RETRY: 3, // å•æ¡æ¶ˆæ¯æœ€å¤§é‡è¯•æ¬¡æ•°
      QUEUE_CLEANUP_INTERVAL: 60000 // é˜Ÿåˆ—æ¸…ç†é—´éš”
    };

    // å…¨å±€çŠ¶æ€ï¼ˆç®€åŒ–ç‰ˆï¼‰
    const state = {
      ws: null,
      username: "",
      roomname: "",
      onlineUsers: [],
      isReconnecting: false,
      reconnectCount: 0,
      heartbeatTimer: null,
      reconnectTimer: null,
      isAtBottom: true,
      renderedMessages: new Map(),
      clientId: Math.random().toString(36).slice(2, 15) + Date.now(),
      messageQueue: [],
      isSending: false,
      currentPage: "login",
	  
      unreadCount: parseInt(sessionStorage.getItem('chatUnreadCount')) || 0, // ä»æœ¬åœ°ç¼“å­˜è¯»å–
	  hasUnread: sessionStorage.getItem('chatHasUnread') === 'true' || false, // ä»æœ¬åœ°ç¼“å­˜è¯»å–
	  
      wsStatus: "disconnected", // WebSocketçŠ¶æ€ï¼šdisconnected/connecting/connected
      messageStatus: new Map(), // æ¶ˆæ¯å‘é€çŠ¶æ€ï¼šmsgId -> {status: sending/success/fail, retry: 0}
      queueCleanupTimer: null, // é˜Ÿåˆ—æ¸…ç†å®šæ—¶å™¨æ ‡è¯†ï¼ˆæ–°å¢ï¼‰
      isQueuePaused: false // é˜Ÿåˆ—æ˜¯å¦æš‚åœï¼ˆæ–°å¢ï¼Œæ ‡ç­¾é¡µåå°æ—¶æš‚åœï¼‰
    };

    // DOM å…ƒç´ 
    const els = {
      loginPage: document.getElementById('loginPage'),
      chatPage: document.getElementById('chatPage'),
      userListPage: document.getElementById('userListPage'),
      nameInput: document.getElementById('nameInput'),
      enterBtn: document.getElementById('enterBtn'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      chatlog: document.getElementById('chatlog'),
      imageUpload: document.getElementById('imageUpload'),
      userList: document.getElementById('userList'),
      roomStatus: document.getElementById('roomStatus'),
      backBtn: document.querySelector('.header-tab-item.back-btn'),
      shareBtn: document.querySelector('.header-tab-item.share-btn'),
      tabUser: document.getElementById('tabUser'),
      tabChat: document.getElementById('tabChat'),
      tabItems: document.querySelectorAll('.tab-item')
    };
	
    // æ ¼å¼åŒ–æ¶ˆæ¯ï¼ˆURLè½¬é“¾æ¥ï¼‰
    function formatMessage(text) {
      if (!text) return '';
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text
        .replace(/\n/g, '<br>')
        .replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
    }
	
	// ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯IDï¼ˆæ–°å¢ï¼šç»Ÿä¸€IDç”Ÿæˆè§„åˆ™ï¼‰
	function generateUniqueMsgId() {
	  return `${state.clientId}_${Date.now()}_${Math.random().toString(36).slice(2, 12)}`;
	}
	
	function getUniqueMsgId(msg) {
	  const safeMsg = msg || {};
	  // ç›´æ¥è¿”å›æ¶ˆæ¯è‡ªå¸¦çš„messageIdï¼ˆå‰ç«¯å‘é€æ—¶ç”Ÿæˆçš„ï¼‰
	  return safeMsg.messageId || generateUniqueMsgId();
	}
		
    // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    function adjustHeight() {
	  // å…ˆè®°å½•å½“å‰é«˜åº¦ï¼Œé¿å…é‡å¤è®¡ç®—
	  const currentHeight = els.chatInput.offsetHeight;
	  els.chatInput.style.height = 'auto';
	  
	  // è®¡ç®—å®é™…å†…å®¹é«˜åº¦ï¼Œé™åˆ¶æœ€å¤§é«˜åº¦
	  const contentHeight = els.chatInput.scrollHeight;
	  const maxHeight = 120;
	  const targetHeight = Math.min(contentHeight, maxHeight);
	  
	  // ä»…å½“ç›®æ ‡é«˜åº¦ä¸å½“å‰é«˜åº¦å·®å¼‚å¤§äº1pxæ—¶ï¼Œæ‰æ›´æ–°é«˜åº¦ï¼ˆæ¶ˆé™¤å¾®å°æ³¢åŠ¨ï¼‰
	  if (Math.abs(targetHeight - currentHeight) > 1) {
		els.chatInput.style.height = `${targetHeight}px`;
	  }
	  
	  // å†…å®¹æº¢å‡ºæ—¶ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¿ç•™å…‰æ ‡å¯è§ï¼‰
	  if (els.chatInput.scrollHeight > els.chatInput.clientHeight) {
		els.chatInput.scrollTop = els.chatInput.scrollHeight;
	  }
	}

	// åˆ›å»ºä¸Šä¼ ä¸­ä¸´æ—¶æ°”æ³¡ï¼ˆä¿®å¤ï¼šç¡®ä¿msgIdç»‘å®šå’Œå›¾ç‰‡æ ‡è¯†ï¼‰
	function createUploadingMsgBubble() {
	  // ä»…ç”Ÿæˆä¸€ä¸ªmsgIdï¼Œä½œä¸ºæ¶ˆæ¯å”¯ä¸€æ ‡è¯†
	  const msgId = generateUniqueMsgId();
	  console.log("ä¸Šä¼ ä¸­msgIdï¼š", msgId);
	  
	  // å¤ç”¨æ–‡å­—æ¶ˆæ¯é€»è¾‘åˆ›å»ºæ°”æ³¡ï¼Œä»…ç»‘å®šmsgId
	  addTextMessage(
		state.username,
		"å›¾ç‰‡æ­£åœ¨ä¸Šä¼ ä¸­â€¦â€¦",
		true, // è‡ªå·±çš„æ¶ˆæ¯
		true, // è·³è¿‡æ ¼å¼åŒ–
		msgId // ä»…ç»‘å®šmsgId
	  );
	  
	  // å¼ºåˆ¶æŸ¥æ‰¾å¹¶æ·»åŠ å›¾ç‰‡æ ‡è¯†ï¼ˆé¿å…åç»­æŸ¥æ‰¾ä¸åˆ°ï¼‰
	  const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
	  if (msgDiv) {
		msgDiv.dataset.isImageMsg = "true";
		// å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨
		els.chatlog.scrollTop = els.chatlog.scrollHeight;
	  }
	  
	  return msgId; // ä»…è¿”å›msgId
	}

    // æ›´æ–°æ¶ˆæ¯å‘é€çŠ¶æ€æ˜¾ç¤º
    function updateMessageStatusDisplay(msgId, status) {
	  const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
	  if (!msgDiv) return;
	  
	  // æŸ¥æ‰¾çŠ¶æ€å…ƒç´ ï¼ˆè‡ªå·±çš„æ¶ˆæ¯ç”¨.msg-status-wrapperï¼‰
	  let statusDiv = msgDiv.querySelector('.msg-status');
	  if (!statusDiv) {
		const statusWrapper = msgDiv.querySelector('.msg-status-wrapper');
		if (statusWrapper) {
		  statusDiv = statusWrapper.querySelector('.msg-status');
		}
	  }
	  
	  if (!statusDiv) return;
	  
	  // é‡ç½®çŠ¶æ€æ ·å¼
	  statusDiv.classList.remove('sending', 'success', 'fail');
	  switch(status) {
		case "sending":
		  statusDiv.className = 'msg-status sending';
		  statusDiv.textContent = "å‘é€ä¸­";
		  break;
		case "success":
		  statusDiv.className = 'msg-status success';
		  statusDiv.textContent = "å·²å‘é€";
		  break;
		case "fail":
		  statusDiv.className = 'msg-status fail';
		  statusDiv.textContent = "å‘é€å¤±è´¥ï¼ˆç‚¹å‡»é‡å‘ï¼‰";
		  statusDiv.onclick = () => retryFailedMessage(msgId);
		  break;
	  }
	  
	  scrollToBottom();
	}

    // é‡è¯•å¤±è´¥æ¶ˆæ¯
    function retryFailedMessage(msgId) {
      // æŸ¥æ‰¾æ¶ˆæ¯
      const targetIndex = state.messageQueue.findIndex(msg => {
        const currentMsgId = getUniqueMsgId(msg);
        return currentMsgId === msgId;
      });
      
      if (targetIndex === -1) return;
      
      // é‡ç½®é‡è¯•æ¬¡æ•°
      const msgStatus = state.messageStatus.get(msgId) || { retry: 0, status: "fail" };
      msgStatus.retry = 0;
      msgStatus.status = "sending";
      state.messageStatus.set(msgId, msgStatus);
      
      // æ›´æ–°æ˜¾ç¤º
      updateMessageStatusDisplay(msgId, "sending");
      
      // ä¼˜å…ˆå¤„ç†è¯¥æ¶ˆæ¯
      const targetMsg = state.messageQueue.splice(targetIndex, 1)[0];
      state.messageQueue.unshift(targetMsg);
      
      // è§¦å‘é˜Ÿåˆ—å¤„ç†
      processMessageQueue();
    }

    // æ˜¾ç¤º/éšè—å…ƒç´ 
    function toggleElement(el, show) {
      el.classList[show ? 'remove' : 'add']('hide');
    }

    // åˆ‡æ¢é€‰é¡¹å¡
    function activateTab(tab) {
      els.tabItems.forEach(item => item.classList.remove('active'));
      tab.classList.add('active');
    }

    // æ·»åŠ æ–‡å­—/å›¾ç‰‡æ¶ˆæ¯ï¼ˆæ”¯æŒè·³è¿‡æ ¼å¼åŒ–ï¼‰
    function addTextMessage(name, content, isSelf, skipFormat = false, msgId) {
	  if (!content || content.trim() === '') return;
	  const msgDiv = document.createElement('div');
	  msgDiv.className = `msg ${isSelf ? 'msg-right' : 'msg-left'}`;
	  if (msgId) {
		msgDiv.dataset.msgId = msgId;
	  }
	  
	  const contentDiv = document.createElement('div');
	  contentDiv.className = 'msg-content';
	  
	  const bubble = document.createElement('div');
	  bubble.className = 'msg-bubble';
	  bubble.innerHTML = skipFormat 
		? `${name}ï¼š${content}` 
		: `${name}ï¼š${formatMessage(content)}`; 
	  
	  let statusDiv = null;
	  if (isSelf && msgId) {
		statusDiv = document.createElement('div');
		statusDiv.className = 'msg-status-wrapper';
		const statusText = document.createElement('div');
		statusText.className = 'msg-status sending';
		statusText.textContent = "å‘é€ä¸­";
		statusDiv.appendChild(statusText);
	  }
	  
	  contentDiv.appendChild(bubble);
	  if (statusDiv) {
		contentDiv.appendChild(statusDiv);
	  }
	  msgDiv.appendChild(contentDiv);
	  els.chatlog.appendChild(msgDiv);
	  
	  if (isSelf && msgId) {
		state.messageStatus.set(msgId, {
		  status: "sending",
		  retry: 0
		});
	  }
	  
	  scrollToBottom();
	}

    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
      if (state.isAtBottom) {
        els.chatlog.scrollTop = els.chatlog.scrollHeight;
      }
    }

    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    function updateUserList() {
      els.userList.innerHTML = '';
      
      if (state.onlineUsers.length === 0) {
        const emptyItem = document.createElement('li');
        emptyItem.className = 'user-item';
        emptyItem.innerHTML = `
          <div class="user-avatar">
            <svg width="512px" height="512px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <title>ionicons-v5-j</title>
              <path d="M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z"/>
              <path d="M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z" fill="black"/>
            </svg>
          </div>
          <div class="user-name">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
        `;
        els.userList.appendChild(emptyItem);
        return;
      }
      
      state.onlineUsers.forEach(user => {
        const item = document.createElement('li');
        item.className = 'user-item';
        item.innerHTML = `
          <div class="user-avatar">
            <svg width="512px" height="512px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <title>ionicons-v5-j</title>
              <path d="M332.64,64.58C313.18,43.57,286,32,256,32c-30.16,0-57.43,11.5-76.8,32.38-19.58,21.11-29.12,49.8-26.88,80.78C156.76,206.28,203.27,256,256,256s99.16-49.71,103.67-110.82C361.94,114.48,352.34,85.85,332.64,64.58Z"/>
              <path d="M432,480H80A31,31,0,0,1,55.8,468.87c-6.5-7.77-9.12-18.38-7.18-29.11C57.06,392.94,83.4,353.61,124.8,326c36.78-24.51,83.37-38,131.2-38s94.42,13.5,131.2,38c41.4,27.6,67.74,66.93,76.18,113.75,1.94,10.73-.68,21.34-7.18,29.11A31,31,0,0,1,432,480Z" fill="black"/>
            </svg>
          </div>
          <div class="user-name">${user}</div>
        `;
        els.userList.appendChild(item);
      });
    }

    // ä¸Šä¼ å›¾ç‰‡åˆ°ImgBB
    async function uploadImage(file) {
      if (!file.type.startsWith('image/')) {
        throw new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
      }
      
      if (file.size > CONFIG.MAX_IMG_SIZE) {
        throw new Error(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡${CONFIG.MAX_IMG_SIZE/1024/1024}MB`);
      }
      
      const formData = new FormData();
      formData.append('image', file);
      formData.append('expiration', '86400'); // 24å°æ—¶è¿‡æœŸ
      
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.IMGBB_API_KEY}`, {
        method: 'POST',
        body: formData,
        timeout: 30000
      });
      
      if (!response.ok) {
        throw new Error(`ä¸Šä¼ å¤±è´¥ï¼š${response.status}`);
      }
      
      const data = await response.json();
      if (data.success && data.data?.url) {
        return data.data.url;
      }
      
      throw new Error(data.error?.message || 'ä¸Šä¼ å¤±è´¥');
    }

    // æ ¡éªŒæ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜Ÿåˆ—å»é‡ï¼‰
    function isMsgInQueue(msg) {
      const targetMsgId = getUniqueMsgId(msg);
      return state.messageQueue.some(item => {
        return getUniqueMsgId(item) === targetMsgId;
      });
    }

    // æ¸…ç†æ— æ•ˆæ¶ˆæ¯é˜Ÿåˆ—
    function cleanupMessageQueue() {
      const now = Date.now();
      const validQueue = state.messageQueue.filter(msg => {
        const msgId = getUniqueMsgId(msg);
        const msgStatus = state.messageStatus.get(msgId) || { retry: 0, status: "sending" };
        
        // è¿‡æ»¤è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ä¸”çŠ¶æ€ä¸ºå¤±è´¥çš„æ¶ˆæ¯
        if (msgStatus.status === "fail" && msgStatus.retry >= CONFIG.MAX_MSG_RETRY) {
          state.messageStatus.delete(msgId);
          return false;
        }
        
        // è¿‡æ»¤è¶…è¿‡5åˆ†é’Ÿçš„æ¶ˆæ¯
        const msgTime = msg.timestamp || now;
        if (now - msgTime > 300000) {
          state.messageStatus.delete(msgId);
          return false;
        }
        
        return true;
      });
      
      state.messageQueue = validQueue;
    }

    // å»ºç«‹WebSocketè¿æ¥
    function connectWS() {
      if (state.currentPage === "login") {
        return;
      }
      
      // æ›´æ–°WebSocketçŠ¶æ€
      state.wsStatus = "connecting";
      if (state.ws) {
        try { 
          state.ws.close(1000, "Reconnecting"); 
        } catch (e) {}
        state.ws = null;
      }
      
      const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = `${protocol}${location.host}/api/room/${state.roomname}/websocket`;
      
      try {
        const ws = new WebSocket(wsUrl);
        state.ws = ws;
        
        ws.onopen = () => {
          state.isReconnecting = false;
          state.reconnectCount = 0;
          state.wsStatus = "connected";
          
          // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
          toggleSendBtnStatus();
          
          ws.send(JSON.stringify({
            type: 'join',
            name: state.username
          }));
          
          setTimeout(() => {
            ws.send(JSON.stringify({ type: 'getUsers' }));
          }, 500);
          
          startHeartbeat();
          
          setTimeout(() => {
            // ä¼˜åŒ–ï¼šè·å–å†å²æ¶ˆæ¯æ—¶æºå¸¦å·²æ¸²æŸ“çš„msgIdåˆ—è¡¨
            ws.send(JSON.stringify({ 
              type: 'getHistory',
              renderedMsgIds: Array.from(state.renderedMessages.keys())
            }));
          }, 1000);
          
          // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
          processMessageQueue();
          
          // ä¿®å¤ï¼šå…ˆæ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œå†å¯åŠ¨æ–°å®šæ—¶å™¨
          if (state.queueCleanupTimer) {
            clearInterval(state.queueCleanupTimer);
          }
          state.queueCleanupTimer = setInterval(cleanupMessageQueue, CONFIG.QUEUE_CLEANUP_INTERVAL);
        };
        
        ws.onmessage = (e) => {
          resetHeartbeat();
          handleMessage(e.data);
        };
        
        ws.onclose = (e) => {
          stopHeartbeat();
          state.wsStatus = "disconnected";
          
          // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
          toggleSendBtnStatus();
          
          // æ¸…é™¤é˜Ÿåˆ—æ¸…ç†å®šæ—¶å™¨
          if (state.queueCleanupTimer) {
            clearInterval(state.queueCleanupTimer);
            state.queueCleanupTimer = null;
          }
          
          if (![1000, 1001, 1005].includes(e.code) && !state.isReconnecting) {
            state.isReconnecting = true;
            state.reconnectCount++;
            
            if (state.reconnectCount > CONFIG.MAX_RECONNECT) {
              state.isReconnecting = false;
              // æ›´æ–°æ‰€æœ‰æœªå‘é€æˆåŠŸçš„æ¶ˆæ¯çŠ¶æ€ä¸ºå¤±è´¥
				state.messageQueue.forEach(msg => {
				  const msgId = getUniqueMsgId(msg);
				  const msgStatus = state.messageStatus.get(msgId) || { retry: 0, status: "sending" };
				  if (msgStatus.status === "sending") {
					msgStatus.status = "fail";
					state.messageStatus.set(msgId, msgStatus);
					updateMessageStatusDisplay(msgId, "fail");
				  }
				});
              return;
            }
            
            state.reconnectTimer = setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
          }
        };
        
        ws.onerror = (e) => {
          stopHeartbeat();
          state.wsStatus = "disconnected";
          
          // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
          toggleSendBtnStatus();
          
          if (!state.isReconnecting) {
            setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
          }
        };
        
      } catch (e) {
        state.wsStatus = "disconnected";
        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        toggleSendBtnStatus();
        
        if (!state.isReconnecting) {
          setTimeout(connectWS, CONFIG.RECONNECT_INTERVAL);
        }
      }
    }

    // åˆ‡æ¢å‘é€æŒ‰é’®çŠ¶æ€
    function toggleSendBtnStatus() {
      if (state.wsStatus === "connected" && els.chatInput.innerText.trim()) {
        els.sendBtn.classList.remove('disabled');
      } else {
        els.sendBtn.classList.add('disabled');
      }
    }

	// å¤„ç†WebSocketæ¶ˆæ¯ï¼ˆä¿®å¤ï¼šç¡®ä¿å›¾ç‰‡æ°”æ³¡æ›´æ–°ï¼‰
	function handleMessage(rawData) {
	  try {
		const data = JSON.parse(rawData);
		console.log('æ”¶åˆ°æœåŠ¡ç«¯æ¶ˆæ¯:', data);

		switch(data.type) {
		  case 'heartbeat':
			return;
		  case 'system':
			if (data.onlineUsers) {
			  state.onlineUsers = Array.isArray(data.onlineUsers) ? data.onlineUsers.filter(u => !!u) : [];
			  updateUserList();
			}
			return;
		  case 'error':
			console.error('æœåŠ¡ç«¯é”™è¯¯:', data.message);
			if (data.msgId) {
			  const msgStatus = state.messageStatus.get(data.msgId) || { retry: 0, status: "sending" };
			  msgStatus.status = "fail";
			  state.messageStatus.set(data.msgId, msgStatus);
			  updateMessageStatusDisplay(data.msgId, "fail");
			}
			return;
		  case 'msgAck':
			if (data.msgId) {
			  console.log("æ”¶åˆ°msgAckï¼ŒmsgId:", data.msgId);
			  let msgStatus = state.messageStatus.get(data.msgId);
			  if (!msgStatus) return;
			  
			  msgStatus.status = "success";
			  state.messageStatus.set(data.msgId, msgStatus);

			  // ç»Ÿä¸€è°ƒç”¨æ–‡å­—æ¶ˆæ¯çš„çŠ¶æ€æ›´æ–°å‡½æ•°
			  updateMessageStatusDisplay(data.msgId, "success");
			  
			  // å»¶è¿Ÿåˆ é™¤çŠ¶æ€ï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
			  setTimeout(() => {
				state.messageStatus.delete(data.msgId);
			  }, 10000);
			}
			return;
		  case 'history':
			if (data.history && Array.isArray(data.history)) {
			  data.history.forEach(msg => {
				const safeMsg = {
				  name: msg.name || "æœªçŸ¥ç”¨æˆ·",
				  message: msg.message || "",
				  timestamp: msg.timestamp || Date.now(),
				  isImage: !!msg.isImage,
				  clientId: msg.clientId || "",
				  messageId: msg.messageId || ""
				};

				if (!safeMsg.message.trim()) return;
				const msgId = getUniqueMsgId(safeMsg);
				// æ–°å¢ï¼šæ ‡è®°å†å²æ¶ˆæ¯ä¸ºå·²æ¸²æŸ“ï¼Œé¿å…é‡å¤æ˜¾ç¤º
				if (!state.renderedMessages.has(msgId)) {
				  state.renderedMessages.set(msgId, safeMsg.clientId);
				  const isSelf = safeMsg.clientId === state.clientId;
				  if (safeMsg.isImage) {
					const imageLink = `<a href="${safeMsg.message}" target="_blank">å›¾ç‰‡</a>`;
					addTextMessage(safeMsg.name, imageLink, isSelf, true);
				  } else {
					addTextMessage(safeMsg.name, safeMsg.message, isSelf);
				  }
				}
			  });
			}
			return;
		  case 'chat':
			break;
		  default:
			return;
		}

		const safeData = {
		  name: data.name || "æœªçŸ¥ç”¨æˆ·",
		  message: data.message || "",
		  timestamp: data.timestamp || Date.now(),
		  isImage: !!data.isImage,
		  clientId: data.clientId || "",
		  messageId: data.messageId || ""
		};

		if (!safeData.message.trim()) return;
		const msgId = getUniqueMsgId(safeData);
		console.log("æœåŠ¡ç«¯å¹¿æ’­msgIdï¼š", msgId);
		
		// æ ¸å¿ƒå¢å¼ºï¼šä¼˜å…ˆå…¨å±€å»é‡ï¼Œæ— è®ºæ˜¯å¦æ˜¯è‡ªå·±çš„æ¶ˆæ¯
		if (state.renderedMessages.has(msgId)) {
		  // è‹¥æ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œä»…æ›´æ–°çŠ¶æ€ï¼Œä¸é‡å¤æ¸²æŸ“
		  if (safeData.clientId === state.clientId) {
			const msgStatus = state.messageStatus.get(msgId);
			if (msgStatus && msgStatus.status === "sending") {
			  msgStatus.status = "success";
			  state.messageStatus.set(msgId, msgStatus);
			  updateMessageStatusDisplay(msgId, "success");
			}
			
			// ========== ä¿®å¤ï¼šè‡ªå·±çš„æ¶ˆæ¯ - å¼ºåˆ¶æ›´æ–°å›¾ç‰‡æ°”æ³¡å†…å®¹ ==========
			if (safeData.isImage) {
			  const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
			  if (msgDiv) {
				const bubble = msgDiv.querySelector('.msg-bubble');
				if (bubble) {
				  bubble.textContent = ""; // å¼ºåˆ¶æ¸…ç©º
				  const imageLink = `<a href="${safeData.message}" target="_blank" style="color: blue !important; text-decoration: underline !important;">å›¾ç‰‡</a>`;
				  bubble.innerHTML = `${safeData.name}ï¼š${imageLink}`;
				  bubble.style.color = "";
				}
			  }
			}
			// ===========================================================
		  }
		  return; // å·²æ¸²æŸ“è¿‡ï¼Œç›´æ¥è¿”å›
		}

		const isSelf = safeData.clientId === state.clientId;
		// å›¾ç‰‡æ¶ˆæ¯é¢å¤–åˆ¤é‡ï¼ˆå…œåº•ï¼‰
		const existingImgBubble = els.chatlog.querySelector(`[data-msg-id="${msgId}"][data-isImageMsg="true"]`);
		if (isSelf || existingImgBubble) {
		  const msgStatus = state.messageStatus.get(msgId);
		  if (msgStatus && msgStatus.status === "sending") {
			msgStatus.status = "success";
			state.messageStatus.set(msgId, msgStatus);
			updateMessageStatusDisplay(msgId, "success");
		  }
		  
		  // ========== ä¿®å¤ï¼šè‡ªå·±çš„æ¶ˆæ¯/å›¾ç‰‡æ¶ˆæ¯ - å¼ºåˆ¶æ›´æ–°æ°”æ³¡å†…å®¹ ==========
		  if (isSelf && safeData.isImage) {
			const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
			if (msgDiv) {
			  const bubble = msgDiv.querySelector('.msg-bubble');
			  if (bubble) {
				bubble.textContent = ""; // å¼ºåˆ¶æ¸…ç©º
				const imageLink = `<a href="${safeData.message}" target="_blank" style="color: blue !important; text-decoration: underline !important;">å›¾ç‰‡</a>`;
				bubble.innerHTML = `${safeData.name}ï¼š${imageLink}`;
				bubble.style.color = "";
			  }
			}
		  }
		  // ===========================================================
		  
		  state.renderedMessages.set(msgId, safeData.clientId); // æ ‡è®°ä¸ºå·²æ¸²æŸ“
		  return;
		}

		state.renderedMessages.set(msgId, safeData.clientId);
		
		// æœªè¯»æ¶ˆæ¯åˆ¤æ–­
		if (state.currentPage !== "chat") {
		  state.unreadCount++;
		  state.hasUnread = true;
		  sessionStorage.setItem('chatUnreadCount', state.unreadCount);
		  sessionStorage.setItem('chatHasUnread', 'true');
		  const showUnreadCount = state.unreadCount > 99 ? "99+" : state.unreadCount;
		  els.tabChat.dataset.unread = showUnreadCount;
		  els.tabChat.classList.add("has-unread");
		}
		
		// ä»…æ¸²æŸ“å¯¹æ–¹çš„æ¶ˆæ¯
		if (safeData.isImage) {
		  const imageLink = `<a href="${safeData.message}" target="_blank">å›¾ç‰‡</a>`;
		  addTextMessage(safeData.name, imageLink, isSelf, true);
		} else {
		  addTextMessage(safeData.name, safeData.message, isSelf);
		}

	  } catch (e) {
		console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e, rawData);
	  }
	}

    // å¯åŠ¨å¿ƒè·³
    function startHeartbeat() {
      stopHeartbeat();
      state.heartbeatTimer = setInterval(() => {
        if (state.ws && state.ws.readyState === WebSocket.OPEN) {
          state.ws.send(JSON.stringify({ type: 'heartbeat', time: Date.now() }));
        }
      }, CONFIG.HEARTBEAT_INTERVAL);
    }

    // åœæ­¢å¿ƒè·³
    function stopHeartbeat() {
      if (state.heartbeatTimer) {
        clearInterval(state.heartbeatTimer);
        state.heartbeatTimer = null;
      }
    }

    // é‡ç½®å¿ƒè·³
    function resetHeartbeat() {
      stopHeartbeat();
      startHeartbeat();
    }

    // å‘é€æ¶ˆæ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function sendMessage() {
	  
	  const content = els.chatInput.innerText.trim();
	  if (!content || state.wsStatus !== "connected") {
		return;
	  }

	  const messageId = generateUniqueMsgId();
	  const now = Date.now();
	  
	  const msgData = {
		message: content,
		name: state.username,
		timestamp: now,
		clientId: state.clientId,
		messageId: messageId,
		type: 'chat'
	  };
	  
	  const msgId = getUniqueMsgId(msgData);
	  
	  if (isMsgInQueue(msgData) || state.renderedMessages.has(msgId)) {
		console.warn("æ¶ˆæ¯å·²å­˜åœ¨ï¼Œé¿å…é‡å¤å‘é€:", msgId);
		return;
	  }
	  
	  state.renderedMessages.set(msgId, state.clientId);
	  state.messageStatus.set(msgId, {
		status: "sending",
		retry: 0
	  });
	  
	  state.messageQueue.push(msgData);
	  addTextMessage(state.username, content, true, false, msgId);
	  processMessageQueue();
	  els.chatInput.innerText = '';

	  adjustHeight();
	  toggleSendBtnStatus();
	}

    // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä¼˜åŒ–ç‰ˆï¼šæ·»åŠ æš‚åœåˆ¤æ–­ï¼‰
	function processMessageQueue() {
	  // æ ¡éªŒæ¡ä»¶ï¼šWebSocketå·²è¿æ¥ + ä¸åœ¨å‘é€ä¸­ + é˜Ÿåˆ—æœ‰æ¶ˆæ¯ + é˜Ÿåˆ—æœªæš‚åœ
	  if (state.wsStatus !== "connected" || state.isSending || state.messageQueue.length === 0 || state.isQueuePaused) {
		state.isSending = false;
		return;
	  }

	  state.isSending = true;
	  // å–å‡ºé˜Ÿé¦–æ¶ˆæ¯
	  const currentMsg = state.messageQueue[0];
	  const msgId = getUniqueMsgId(currentMsg);
	  const msgStatus = state.messageStatus.get(msgId) || { retry: 0, status: "sending" };

	  // æ ¡éªŒé‡è¯•æ¬¡æ•°
	  if (msgStatus.retry >= CONFIG.MAX_MSG_RETRY) {
		msgStatus.status = "fail";
		state.messageStatus.set(msgId, msgStatus);
		updateMessageStatusDisplay(msgId, "fail");
		
		// ç§»é™¤å¤±è´¥æ¶ˆæ¯
		state.messageQueue.shift();
		state.isSending = false;
		setTimeout(processMessageQueue, 100);
		return;
	  }

	  try {
		console.log('å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯:', currentMsg);
		state.ws.send(JSON.stringify(currentMsg));

		const checkSendStatus = () => {
		  if (!state.ws || state.ws.readyState !== WebSocket.OPEN) {
			// WebSocketå¼‚å¸¸ï¼šç´¯è®¡é‡è¯•æ¬¡æ•°ï¼Œä¿æŒåœ¨é˜Ÿé¦–
			msgStatus.retry++;
			state.messageStatus.set(msgId, msgStatus);
			updateMessageStatusDisplay(msgId, "sending");
			state.isSending = false;
			setTimeout(processMessageQueue, 2000);
			return;
		  }

		  if (state.ws.bufferedAmount === 0) {
			// æ¶ˆæ¯å·²å†™å…¥ç¼“å†²åŒºï¼šç§»é™¤é˜Ÿåˆ—ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ¡
			state.messageQueue.shift();
			state.isSending = false;
			setTimeout(processMessageQueue, 100);
		  } else {
			// ç»§ç»­ç­‰å¾…ç¼“å†²åŒºæ¸…ç©º
			setTimeout(checkSendStatus, 50);
		  }
		};
		checkSendStatus();

	  } catch (e) {
		console.error('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œç¨åé‡è¯•:', e);
		// å‘é€å¼‚å¸¸ï¼šç´¯è®¡é‡è¯•æ¬¡æ•°
		msgStatus.retry++;
		state.messageStatus.set(msgId, msgStatus);
		updateMessageStatusDisplay(msgId, "sending");
		state.isSending = false;
		setTimeout(processMessageQueue, 6000);
	  }
	}

	// å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆä¿®å¤ï¼šç¡®ä¿ä¸Šä¼ æˆåŠŸåæ›´æ–°æ°”æ³¡ï¼‰
	async function handleImageUpload(e) {
	  const file = e.target.files[0];
	  if (!file) return;
	  
	  // 1. åˆ›å»ºä¸Šä¼ æ°”æ³¡ï¼Œä»…è·å–msgIdï¼ˆå–æ¶ˆtempMsgIdï¼‰
	  const msgId = createUploadingMsgBubble();

	  try {
		if (!file.type.startsWith('image/')) {
		  throw new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
		}
		
		if (file.size > CONFIG.MAX_IMG_SIZE) {
		  throw new Error(`å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡${CONFIG.MAX_IMG_SIZE/1024/1024}MB`);
		}
		
		// 2. ä¸Šä¼ å›¾ç‰‡
		const imgUrl = await uploadImage(file);
		console.log("ä¸Šä¼ æˆåŠŸmsgIdï¼š", msgId, "å›¾ç‰‡é“¾æ¥ï¼š", imgUrl);
		
		// 3. ç›´æ¥é€šè¿‡msgIdæ›´æ–°æ°”æ³¡ï¼ˆä¿®å¤ï¼šç®€åŒ–é€‰æ‹©å™¨ï¼Œå¼ºåˆ¶è¦†ç›–å†…å®¹ï¼‰
		const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
		if (msgDiv) {
		  msgDiv.dataset.isImageMsg = "true"; // å¼ºåˆ¶æ·»åŠ æ ‡è¯†
		  const bubble = msgDiv.querySelector('.msg-bubble');
		  if (bubble) {
			bubble.textContent = ""; // å¼ºåˆ¶æ¸…ç©ºåŸæœ‰å†…å®¹
			const imageLink = `<a href="${imgUrl}" target="_blank" style="color: blue !important; text-decoration: underline !important;">å›¾ç‰‡</a>`;
			bubble.innerHTML = `${state.username}ï¼š${imageLink}`;
			bubble.style.color = ""; // é‡ç½®é¢œè‰²
		  }
		  // ç›´æ¥æ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸ºâ€œå‘é€ä¸­â€ï¼ˆç­‰å¾…æœåŠ¡ç«¯ç¡®è®¤ï¼‰
		  updateMessageStatusDisplay(msgId, "sending");
		}
		
		// 4. æ„é€ å›¾ç‰‡æ¶ˆæ¯ï¼Œä½¿ç”¨ç»Ÿä¸€çš„msgId
		const now = Date.now();
		const imgMsgData = {
		  messageId: msgId, // ç»Ÿä¸€ä½¿ç”¨msgIdä½œä¸ºæ¶ˆæ¯å”¯ä¸€æ ‡è¯†
		  message: imgUrl,
		  name: state.username,
		  isImage: true,
		  timestamp: now,
		  clientId: state.clientId,
		  type: 'chat'
		};
		
		const imgMsgUniqueId = getUniqueMsgId(imgMsgData); 
		
		// é˜Ÿåˆ—å»é‡
		if (isMsgInQueue(imgMsgData)) {
		  updateMessageStatusDisplay(msgId, "success");
		  return;
		}
		
		// ä¸æå‰åŠ å…¥renderedMessagesï¼Œé¿å…æœåŠ¡ç«¯å¹¿æ’­è¢«æ‹¦æˆª
		// state.renderedMessages.set(imgMsgUniqueId, state.clientId);
		
		// æ¶ˆæ¯çŠ¶æ€ç›´æ¥ç»‘å®šmsgId
		state.messageStatus.set(imgMsgUniqueId, {
		  status: "sending",
		  retry: 0
		});
		state.messageQueue.push(imgMsgData);
		
		// 5. å¤„ç†é˜Ÿåˆ—
		processMessageQueue();
		
		// æ¸…ç©ºè¾“å…¥æ¡†
		els.chatInput.innerText = '';
		adjustHeight();
		
	  } catch (e) {
		const errorText = `å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š${e.message}`;
		// é€šè¿‡msgIdæ›´æ–°å¤±è´¥çŠ¶æ€
		const msgDiv = els.chatlog.querySelector(`[data-msg-id="${msgId}"]`);
		if (msgDiv) {
		  const bubble = msgDiv.querySelector('.msg-bubble');
		  if (bubble) {
			bubble.innerHTML = `${state.username}ï¼š${errorText}`;
			bubble.style.color = "#d32f2f";
		  }
		  updateMessageStatusDisplay(msgId, "fail");
		}
		console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', e);
	  } finally {
		els.imageUpload.value = '';
	  }
	}

    // è¿›å…¥æˆ¿é—´ï¼ˆç®€åŒ–ç‰ˆï¼‰
    async function enterRoom() {
      const username = els.nameInput.value.trim();
      
      if (!username) {
        els.nameInput.focus();
        return;
      }
      
      let targetRoomId = '';
      if (location.hash) {
        targetRoomId = location.hash.slice(1).trim();
        if (targetRoomId.length === 64 && /^[a-f0-9]+$/i.test(targetRoomId)) {
          joinExistingRoom(username, targetRoomId);
          return;
        }
      }

      try {
        els.enterBtn.textContent = "åŠ è½½ä¸­...";
        els.enterBtn.style.pointerEvents = "none";
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        const response = await fetch(`${location.protocol}//${location.host}/api/room`, {
          method: "POST",
          signal: controller.signal,
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`åˆ›å»ºå¤±è´¥ï¼š${response.status}`);
        }

        const privateRoomId = await response.text();
        if (!privateRoomId || privateRoomId.length !== 64) {
          throw new Error("ç§äººæˆ¿é—´IDç”Ÿæˆå¤±è´¥");
        }
        
        joinExistingRoom(username, privateRoomId);

      } catch (e) {
        alert(`è¿›å…¥æˆ¿é—´å¤±è´¥ï¼š${e.message}`);
        console.error("ç§äººæˆ¿é—´åˆ›å»ºå¤±è´¥ï¼š", e);
        els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
        els.enterBtn.style.pointerEvents = "auto";
      }
    }

    // åŠ å…¥å·²æœ‰æˆ¿é—´
    function joinExistingRoom(username, roomId) {
      state.renderedMessages.clear();
      state.messageQueue = [];
      state.messageStatus.clear();
      
      state.username = username;
      state.roomname = roomId;
      state.currentPage = "userList";

      toggleElement(els.loginPage, false);
      toggleElement(els.userListPage, true);
      toggleElement(els.chatPage, false);
      toggleElement(els.backBtn, true);
      toggleElement(els.shareBtn, true);
      
      location.hash = roomId;
      connectWS();
      els.chatInput.blur();

      els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
      els.enterBtn.style.pointerEvents = "auto";
    }

    // è¿”å›æŒ‰é’®é€»è¾‘
    function goBack() {
      if (!els.chatPage.classList.contains('hide')) {
        toggleElement(els.chatPage, false);
        toggleElement(els.userListPage, true);
        activateTab(els.tabUser);
        state.currentPage = "userList";
        return;
      }
      
      if (!els.userListPage.classList.contains('hide')) {
        if (state.ws) {
          try {
            state.ws.send(JSON.stringify({ type: 'quit', name: state.username }));
            state.ws.close(1000, "User quit");
          } catch (e) {}
          state.ws = null;
        }
        
        stopHeartbeat();
        if (state.reconnectTimer) clearTimeout(state.reconnectTimer);
        if (state.queueCleanupTimer) {
          clearInterval(state.queueCleanupTimer);
          state.queueCleanupTimer = null;
        }
        
        state.username = '';
        state.roomname = '';
        state.onlineUsers = [];
        state.renderedMessages.clear();
        state.messageQueue = [];
        state.messageStatus.clear();
        state.clientId = Math.random().toString(36).slice(2, 15) + Date.now();
        state.currentPage = "login";
        state.wsStatus = "disconnected";
        state.unreadCount = 0;
        state.hasUnread = false;
        
        els.enterBtn.textContent = "è¿›å…¥æˆ¿é—´";
        els.enterBtn.style.pointerEvents = "auto";
        
        toggleElement(els.userListPage, false);
        toggleElement(els.loginPage, true);
        toggleElement(els.backBtn, false);
        toggleElement(els.shareBtn, false);
        els.chatlog.innerHTML = '';
        els.chatInput.innerText = '';
        adjustHeight();
        els.nameInput.focus();
        
        // æ¸…ç©ºæœªè¯»çº¢ç‚¹
        els.tabChat.dataset.unread = "";
        els.tabChat.classList.remove("has-unread");
      }
    }

    // åˆå§‹åŒ–
    function init() {
      els.enterBtn.addEventListener('click', enterRoom);
      els.backBtn.addEventListener('click', goBack);
      
      // åˆ†äº«æŒ‰é’®
      els.shareBtn.addEventListener('click', async () => {
        const roomUrl = `${location.origin}${location.pathname}#${state.roomname}`;
        const shareTitle = 'Cloudflare ç§äººèŠå¤©å®¤';
        const shareText = 'é‚€è¯·ä½ åŠ å…¥æˆ‘çš„ç§äººèŠå¤©å®¤ï¼Œç‚¹å‡»é“¾æ¥å³å¯è¿›å…¥';

        try {
          await navigator.share({
            title: shareTitle,
            text: shareText,
            url: roomUrl
          });
          console.log('åˆ†äº«æˆåŠŸ');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.log('Web Share API ä¸æ”¯æŒï¼Œé™çº§ä¸ºå¤åˆ¶é“¾æ¥', err);
            try {
              await navigator.clipboard.writeText(roomUrl);
              alert('ç§äººæˆ¿é—´é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œä½ å¯ä»¥æ‰‹åŠ¨åˆ†äº«ï½');
            } catch (clipboardErr) {
              prompt('å¤åˆ¶ç§äººæˆ¿é—´é“¾æ¥ï¼ˆè¯·æ‰‹åŠ¨å¤åˆ¶ï¼‰', roomUrl);
            }
          } else {
            console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ†äº«');
          }
        }
      });

      els.sendBtn.addEventListener('click', sendMessage);
      
      // è¾“å…¥æ¡†äº‹ä»¶
     els.chatInput.addEventListener('focus', () => {
	  if (els.chatInput.innerHTML.trim() === '') {
		els.chatInput.innerHTML = '';
	  }

	  const sel = window.getSelection();
	  const range = document.createRange();
	  
	  // ç¡®ä¿å…‰æ ‡å®šä½åœ¨æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„æœ«å°¾
	  const lastChild = els.chatInput.lastChild;
	  if (lastChild && lastChild.nodeType === Node.ELEMENT_NODE) {
		range.selectNodeContents(lastChild);
		range.collapse(false);
	  } else if (lastChild && lastChild.nodeType === Node.TEXT_NODE) {
		range.setStart(lastChild, lastChild.textContent.length);
		range.collapse(true);
	  } else {
		range.selectNodeContents(els.chatInput);
		range.collapse(false);
	  }
	  
	  sel.removeAllRanges();
	  sel.addRange(range);
	  
	  // è®°å½•å½“å‰æ˜¯å¦åœ¨åº•éƒ¨
	  state.isAtBottom = Math.abs(els.chatlog.scrollHeight - els.chatlog.scrollTop - els.chatlog.clientHeight) < 10;
	});

	// è¾“å…¥æ¡†å†…å®¹å˜åŒ–äº‹ä»¶
	els.chatInput.addEventListener('input', () => {
	  adjustHeight();
	  toggleSendBtnStatus();
	});

	// è¾“å…¥æ¡†å¤±ç„¦äº‹ä»¶
	els.chatInput.addEventListener('blur', () => {
	  scrollToBottom();
	});

	// å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
	els.imageUpload.addEventListener('change', handleImageUpload);

	// èŠå¤©è®°å½•æ»šåŠ¨äº‹ä»¶
	els.chatlog.addEventListener('scroll', () => {
	  state.isAtBottom = Math.abs(els.chatlog.scrollHeight - els.chatlog.scrollTop - els.chatlog.clientHeight) < 10;
	});

	// é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
	els.tabChat.addEventListener('click', () => {
	  toggleElement(els.userListPage, false);
	  toggleElement(els.chatPage, true);
	  activateTab(els.tabChat);
	  state.currentPage = "chat";
	  
	  // æ¸…ç©ºæœªè¯»æ¶ˆæ¯
	  state.unreadCount = 0;
	  state.hasUnread = false;
	  sessionStorage.setItem('chatUnreadCount', '0');
	  sessionStorage.setItem('chatHasUnread', 'false');
	  els.tabChat.dataset.unread = "";
	  els.tabChat.classList.remove("has-unread");
	  
	  scrollToBottom();
	});

	els.tabUser.addEventListener('click', () => {
	  toggleElement(els.chatPage, false);
	  toggleElement(els.userListPage, true);
	  activateTab(els.tabUser);
	  state.currentPage = "userList";
	});

	// æ ‡ç­¾é¡µå¯è§æ€§å˜åŒ–äº‹ä»¶ï¼ˆä¼˜åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
	document.addEventListener('visibilitychange', () => {
	  if (document.hidden) {
		state.isQueuePaused = true;
	  } else {
		state.isQueuePaused = false;
		// æ¢å¤åç«‹å³å¤„ç†é˜Ÿåˆ—
		setTimeout(processMessageQueue, 100);
		
		// åˆ‡æ¢åˆ°èŠå¤©é¡µæ—¶æ¸…ç©ºæœªè¯»
		if (state.currentPage === "chat") {
		  state.unreadCount = 0;
		  state.hasUnread = false;
		  sessionStorage.setItem('chatUnreadCount', '0');
		  sessionStorage.setItem('chatHasUnread', 'false');
		  els.tabChat.dataset.unread = "";
		  els.tabChat.classList.remove("has-unread");
		}
	  }
	});

	// é¡µé¢å¸è½½äº‹ä»¶
	window.addEventListener('beforeunload', () => {
	  if (state.ws) {
		try {
		  state.ws.send(JSON.stringify({ type: 'quit', name: state.username }));
		  state.ws.close(1000, "Page unload");
		} catch (e) {}
	  }
	  stopHeartbeat();
	  if (state.reconnectTimer) clearTimeout(state.reconnectTimer);
	  if (state.queueCleanupTimer) clearInterval(state.queueCleanupTimer);
	});

	// åˆå§‹åŒ–è¾“å…¥æ¡†é«˜åº¦
	adjustHeight();
	
	// åˆå§‹åŒ–æœªè¯»çº¢ç‚¹
	if (state.hasUnread) {
	  const showUnreadCount = state.unreadCount > 99 ? "99+" : state.unreadCount;
	  els.tabChat.dataset.unread = showUnreadCount;
	  els.tabChat.classList.add("has-unread");
	}
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>