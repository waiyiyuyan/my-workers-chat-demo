<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>微信聊天室 · 2.0 风格（修复版）</title>
<style>
/* Reset & base */
* { margin:0; padding:0; box-sizing:border-box; }
html,body { height:100%; }
body{
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
  background:#e9ebee;
  color:#222;
  -webkit-text-size-adjust:none;
  height:100vh;
  overflow:hidden;
}

/* Top bar (hidden on login) */
#topbar {
  display:none;
  position:fixed; top:0; left:0; right:0; height:56px;
  background: linear-gradient(#bdbbb3,#9b9990);
  color:#fff; text-align:center; line-height:56px;
  font-size:18px; font-weight:600;
  box-shadow:0 1px 4px rgba(0,0,0,0.12);
  z-index:20;
}
#back-btn {
  position:absolute; left:12px; top:0; bottom:0; margin:auto;
  height:44px; line-height:44px; font-size:15px; color:#fff; cursor:pointer;
  opacity:.95;
}

/* Chat area */
#chatroom { position:fixed; inset:56px 0 64px 0; }
#chatlog {
  position:absolute; inset:0 0 0 0; overflow-y:auto; padding:16px; -webkit-overflow-scrolling:touch;
}

/* Message row: outer container */
.msg {
  display: flex;
  margin: 8px 0;
  width: 100%;
  align-items: flex-start;
  flex-wrap: wrap;   /* 必须加这一句 */
}

/* msg-content holds header + bubble, use column layout */
.msg-content {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  max-width: 88%;   /* 改成 85%~90% 任意值 */
  box-sizing: border-box;
}

/* for right-side messages align items to end */
.msg.right .msg-content { align-items:flex-end; text-align:right; }

/* Header */
.header { font-size:12px; color:#7f7f7f; margin-bottom:6px; }

/* ----------- Bubble: robust, no per-letter breaks ----------- */
/* baseline */
.msg .bubble {
  position: relative;
  display: inline-block;
  padding: 10px 14px;
  font-size: 16px;
  line-height: 1.5;
  border-radius: 14px;
  white-space: normal;
  word-break: keep-all;
  overflow-wrap: break-word;
  
  max-width: 100%;
}


/* left (other) */
.msg.left { justify-content:flex-start; }
.msg.left .msg-content { text-align:left; }
.msg.left .bubble {
  /* 基础样式 */
  background:#fff;
  border:1px solid rgba(0,0,0,0.06);
  color:#111;
  box-shadow:0 1px 2px rgba(0,0,0,0.04);
  max-width:100%; /* 保持 100%，让 msg-content 限制最大宽度 */
  
  /* 修复圆角：左上和左下更小，右上和右下更大 */
  border-radius: 4px 14px 14px 4px; /* 左上 右上 右下 左下 */
  /* 确保 tail 不会被覆盖 */
  padding-left: 14px; 
}
/* left tail — absolute, 定位到底部附近 */
.msg.left .bubble::after{
  content:"";
  position:absolute;
  left:-7px; /* 调整为 -7px */
  /* 关键修复：定位到底部，而不是垂直居中 */
  bottom: 8px; /* 距离气泡底部的距离 */
  transform:none;
  width:0;height:0;
  border-top:7px solid transparent;
  border-bottom:7px solid transparent;
  border-right:7px solid #fff;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.02));
  pointer-events:none;
}
/* 修复左侧气泡文本，强制对齐 */
.msg.left .bubble { text-align: left; }


/* right (me) */
.msg.right { justify-content:flex-end; }
.msg.right .bubble {
  /* 关键修复：使用更自然的微信绿渐变 */
  background:linear-gradient(#b0e87d,#8fd046); 
  color:#000;
  box-shadow:0 1px 2px rgba(0,0,0,0.06);
  max-width:100%; /* 保持 100%，让 msg-content 限制最大宽度 */
  
  /* 修复圆角：右上和右下更小，左上和左下更大 */
  border-radius: 14px 4px 4px 14px; /* 左上 右上 右下 左下 */
  /* 确保 tail 不会被覆盖 */
  padding-right: 14px; 
}
.msg.right .bubble::after {
  content:"";
  position:absolute;
  right:-7px; /* 调整为 -7px */
  /* 关键修复：定位到底部，而不是垂直居中 */
  bottom: 8px; /* 距离气泡底部的距离 */
  transform:none;
  width:0;height:0;
  border-top:7px solid transparent;
  border-bottom:7px solid transparent;
  /* 使用渐变色 #8fd046 作为尾巴颜色 */
  border-left:7px solid #8fd046; 
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.02));
  pointer-events:none;
}
/* 修复右侧气泡文本，强制对齐 */
.msg.right .bubble { text-align: left; }

/* System messages */
.msg.system { justify-content:center; margin:14px 0; }
.msg.system .bubble {
  display:inline-block; padding:8px 22px; background:#f0f0f0; color:#666;
  font-size:13px; border-radius:6px; max-width:88%; word-break:break-word; text-align:center;
}
.msg.system .bubble.error { background:#fff6f6; color:#c43a3a; border-left:4px solid #e96b6b; padding-left:18px; }

/* Input bar */
#input-bar { position:fixed; left:0; right:0; bottom:0; height:64px; background:linear-gradient(#cfcfcf,#b9b9b9); border-top:1px solid rgba(0,0,0,0.06); display:flex; align-items:center; padding:8px 12px; z-index:15; }
#chat-input { flex:1; height:44px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); padding:8px 12px; font-size:16px; background:#fff; margin-right:10px; outline:none; }
#send-btn { height:44px; min-width:68px; padding:0 14px; border-radius:8px; background:linear-gradient(#83c03a,#69a92b); color:#fff; border:none; font-weight:600; cursor:pointer; transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease; }
#send-btn.sending, 
#join-public.sending,
#create-private.sending { 
  transform: translateY(-3px) scale(0.98); 
  box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
  opacity: 0.98; 
}
@keyframes sendPulse { 0%{transform:translateY(0) scale(1);}50%{transform:translateY(-3px) scale(0.985);}100%{transform:translateY(0) scale(1);} }
#send-btn.pulse,
#join-public.pulse,
#create-private.pulse { 
  animation: sendPulse 320ms ease; 
}

/* Login overlay */
#start-form { position:fixed; inset:56px 0 64px 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.05); z-index:30; }
#start-box { width:92%; max-width:360px; background:#f8f8f8; border-radius:10px; padding:28px 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.12); border:1px solid rgba(0,0,0,0.06); }
#start-box h2 { font-size:20px; color:#111; margin-bottom:18px; font-weight:600; text-align:center; }
#start-box input { width:100%; padding:12px 10px; margin:8px 0; border-radius:8px; border:1px solid #d9d9d9; font-size:16px; }
#start-box .row { display:flex; gap:8px; margin-top:10px; }

#start-box button { 
  flex:1; padding:12px; border-radius:8px; border:none; cursor:pointer; color:#fff; font-weight:600; 
  /* 新增：使动画平滑 */
  transition: transform 160ms ease, box-shadow 160ms ease, opacity 160ms ease; 
}
#join-public { background:linear-gradient(#6fbf3c,#5fa72b); }
#create-private { background:linear-gradient(#5aa7f7,#3b8de6); }


/* Responsive */
@media (max-width:480px) { .msg-content { max-width:78%; } #start-box { padding:20px; } #chat-input { font-size:15px; } }
</style>
</head>
<body>

<div id="topbar"><div id="back-btn" onclick="backToLogin()">返回</div><span id="room-title">聊天室</span></div>

<div id="start-form">
  <div id="start-box" role="dialog" aria-labelledby="start-title">
    <h2 id="start-title">微信聊天室</h2>
    <input id="name-input" placeholder="你的名字（必填）" maxlength="32" autocomplete="off" />
    <input id="room-input" placeholder="房间名（可选）" maxlength="32" autocomplete="off" />
    <div class="row">
      <button id="join-public">加入公共房间</button>
      <button id="create-private">创建私人房间</button>
    </div>
    
    <p style="margin-top:14px;color:#888;font-size:13px;text-align:center;">微信 2.0 · 复刻版</p>
  </div>
</div>

<div id="chatroom" style="display:none">
  <div id="chatlog" aria-live="polite"></div>
  <div id="input-bar">
    <input id="chat-input" placeholder="说点什么..." maxlength="4096" autocomplete="off" />
    <button id="send-btn" onclick="onSendBtnClick()">发送</button>
  </div>
</div>

<script>
if (!sessionStorage.getItem("hasVisited")) { sessionStorage.setItem("hasVisited","true"); }
// 关键修改：使用 sessionStorage 来存储 uniqueId，这样每个新的浏览器会话（标签页或窗口）都会获得一个新的 ID
let uniqueId = sessionStorage.getItem("myUniqueId") || (Date.now().toString(36) + Math.random().toString(36).slice(2,10));
sessionStorage.setItem("myUniqueId", uniqueId);

const chatlog = document.getElementById("chatlog");
const chatInput = document.getElementById("chat-input");
const startForm = document.getElementById("start-form");
const chatroom = document.getElementById("chatroom");
const topbar = document.getElementById("topbar");
const sendBtn = document.getElementById("send-btn");

let username = ""; let usernameDisplay = ""; let roomname = ""; let ws = null;
let isAtBottom = true; let welcomeDone = false;
const hostname = location.host.includes('localhost') ? 'localhost:8788' : 'edge-chat-demo.cloudflareworkers.com';

function getTimeStr(){ const n=new Date(),h=n.getHours(),m=String(n.getMinutes()).padStart(2,'0'); return (h<12?'上午 ':'下午 ')+(((h+11)%12)+1)+':'+m; }


function addMessage(name,text,type="normal",isError=false){
  // ⭐ 修正 1：使用完整的、带 Unique ID 的用户名 (name) 与当前客户端的完整身份 (username) 进行比较
  // 确保只有当接收到的完整身份字符串完全匹配时，isMe 才为 true。
  const isMe = (type!=="system" && name === username);
  
  // ⭐ 修正 2：从完整的身份字符串中提取干净的昵称，用于显示在消息头部
  const displayForHeader = (typeof name==='string' && name.includes("##")) ? name.split("##")[0] : (name||"匿名");

  const row = document.createElement("div");
  // 根据修正后的 isMe 标志位，正确设置 left/right 样式
  row.className = "msg " + (type==="system" ? "system" : (isMe ? "right" : "left"));
  
  if(type==="system"){
    const bubble=document.createElement("div"); bubble.className="bubble"+(isError?" error":""); bubble.textContent=text; row.appendChild(bubble);
  } else {
    const content=document.createElement("div"); content.className="msg-content";
    const header=document.createElement("div"); header.className="header"; 
    // ⭐ 修正 3：使用 displayForHeader 变量来显示昵称
    header.textContent=`${displayForHeader}  ${getTimeStr()}`; 
    const bubble=document.createElement("div"); bubble.className="bubble"; bubble.textContent=text;
    content.appendChild(header); content.appendChild(bubble); row.appendChild(content);
  }
  chatlog.appendChild(row);
  if(isAtBottom) chatlog.scrollTop = chatlog.scrollHeight;
}

chatlog.addEventListener("scroll", ()=>{ isAtBottom = (chatlog.scrollTop + chatlog.clientHeight >= chatlog.scrollHeight - 60); });
/*
function connectWebSocket(){
  if(ws) ws.close();
  welcomeDone=false;
  const proto = location.protocol === "https:" ? "wss://" : "ws://";
  ws = new WebSocket(`${proto}${hostname}/api/room/${roomname || "default-room"}/websocket`);
  ws.onopen = ()=>{ if(username) ws.send(JSON.stringify({name:username})); };
  ws.onmessage = (e)=>{
    let d;
    try{ d=JSON.parse(e.data); }catch{ addMessage("系统","收到异常数据","system",true); return; }
    if(d.error){ addMessage("系统",d.error,"system",true); return; }
    if(d.ready && !welcomeDone){ welcomeDone=true; return; }
    if(d.joined) addMessage("系统",`${d.joined} 加入了聊天室`,"system",false);
    else if(d.quit) addMessage("系统",`${d.quit} 已离开聊天室`,"system",false);
    else if(d.message) addMessage(d.name||"匿名", d.message);
  };
  ws.onclose = ws.onerror = ()=>{ addMessage("系统","连接断开，3秒后重连…","system",false); setTimeout(connectWebSocket,3000); };
}
*/
function connectWebSocket(){
  if(ws) ws.close();
  welcomeDone=false;
  shouldAttemptReconnect = true; // 新增：开始连接时，允许重连
  const proto = location.protocol === "https:" ? "wss://" : "ws://";
  ws = new WebSocket(`${proto}${hostname}/api/room/${roomname || "default-room"}/websocket`);
  ws.onopen = ()=>{ if(username) ws.send(JSON.stringify({name:username})); };
  ws.onmessage = (e)=>{
    let d;
    try{ d=JSON.parse(e.data); }catch{ addMessage("系统","收到异常数据","system",true); return; }
    if(d.error){ addMessage("系统",d.error,"system",true); return; }
    if(d.ready && !welcomeDone){ welcomeDone=true; return; }
    if(d.joined) addMessage("系统",`${d.joined} 加入了聊天室`,"system",false);
    else if(d.quit) addMessage("系统",`${d.quit} 已离开聊天室`,"system",false);
    else if(d.message) addMessage(d.name||"匿名", d.message);
  };
  ws.onclose = ws.onerror = ()=>{ 
    if(shouldAttemptReconnect) { // 关键检查：只有当标志位为 true 时才重连
      addMessage("系统","连接断开，3秒后重连…","system",false); 
      setTimeout(connectWebSocket,3000); 
    }
  };
}

/*
function backToLogin(){
  try{ if(ws) ws.close(); }catch(e){}
  startForm.style.display="flex";
  chatroom.style.display="none";
  topbar.style.display="none";
  welcomeDone=false;
  chatlog.innerHTML="";
  const createBtn=document.getElementById("create-private"); if(createBtn){ createBtn.disabled=false; createBtn.textContent="创建私人房间"; }
  const last=localStorage.getItem("lastPrivateRoom"); if(last&&last!=="default-room") document.getElementById("room-input").value=last;
  try{ history.replaceState(null,"",location.pathname); }catch(e){}
  checkRejoinButton();
}
*/
function backToLogin(){
  try{ 
    if(ws) { 
      // 【Bug 修复】在关闭前清除 onclose/onerror 处理器，彻底阻止重连循环
      ws.onclose = null; 
      ws.onerror = null; 
      ws.close(); 
      ws = null; // 清除全局引用
    } 
  }catch(e){}
  
  startForm.style.display="flex";
  chatroom.style.display="none";
  topbar.style.display="none";
  welcomeDone=false;
  chatlog.innerHTML="";
  const createBtn=document.getElementById("create-private"); if(createBtn){ createBtn.disabled=false; createBtn.textContent="创建私人房间"; }
  // 已删除：const last=localStorage.getItem("lastPrivateRoom"); if(last&&last!=="default-room") document.getElementById("room-input").value=last;
  try{ history.replaceState(null,"",location.pathname); }catch(e){}
  // 已删除：checkRejoinButton();
}

function startChatUI() {
    // 1. 隐藏登录界面
    startForm.style.display = "none";
    // 2. 显示聊天室界面和顶部栏
    chatroom.style.display = "block";
    topbar.style.display = "block";
    
    // 3. 设置房间标题
    document.getElementById("room-title").textContent = `#${roomname}`;
    
    // 4. 存储房间名到 URL 锚点 (可选，如果您不想暴露房间名可以跳过)
    // try{ history.replaceState(null,"",location.pathname + "#" + roomname); }catch(e){}
    
    // 5. 启动 WebSocket 连接
    connectWebSocket();
    
    // 6. 清除创建私人房间按钮的禁用状态（以防创建失败后再次尝试）
    const createBtn = document.getElementById("create-private");
    if (createBtn) { 
        createBtn.disabled = false; 
        createBtn.textContent = "创建私人房间"; 
    }
    
    chatInput.focus(); // 自动聚焦输入框
}

document.getElementById("join-public").addEventListener("click", (e)=>{
  const display=document.getElementById("name-input").value.trim(); 
  if(!display) return alert("请填写昵称！"); // <-- 先检查

  // ⭐ 移动到这里：只有通过检查才执行动画
  animateButton(e.currentTarget); 

  usernameDisplay=display; username=`${display}##${uniqueId}`;
  roomname=(document.getElementById("room-input").value.trim()||"default-room").replace(/[^a-zA-Z0-9_-]/g,"").toLowerCase();
  
  // 延迟启动 UI，确保动画有足够时间显示
  setTimeout(startChatUI, 100); // 增加 100ms 延迟
});

document.getElementById("create-private").addEventListener("click", async (e)=>{
  const display=document.getElementById("name-input").value.trim(); 
  if(!display) return alert("请填写昵称！"); // <-- 先检查

  // ⭐ 移动到这里：只有通过检查才执行动画
  animateButton(e.currentTarget); 
  
  const btn=document.getElementById("create-private"); btn.disabled=true; btn.textContent="创建中…";
  usernameDisplay=display; username=`${display}##${uniqueId}`;
  
  try {
    const base = `${location.protocol}//${hostname}`;
    const res = await fetch(`${base}/api/room`, {method:"POST"});
    roomname = await res.text();
    startChatUI();
  } catch (e) {
    alert("创建失败，请重试"); btn.disabled=false; btn.textContent="创建私人房间";
  }
});

window.addEventListener("load", ()=>{ 
  // 仅保留检查按钮状态的调用，如果 checkRejoinButton 确实是您要删除的功能，也应删除此行
});

// 通用动画函数，接受一个元素作为参数
function animateButton(btnElement){ 
  btnElement.classList.add('sending','pulse'); 
  setTimeout(()=>{ btnElement.classList.remove('sending'); },300); 
  setTimeout(()=>{ btnElement.classList.remove('pulse'); },350); 
}
function onSendBtnClick(){ animateButton(sendBtn); setTimeout(()=>{ sendMessage(); },70); }

function sendMessage(){
  const msg=chatInput.value.trim(); if(!msg) return;
  const CHAR_LIMIT=256, BYTE_LIMIT=48*1024; const bytes=new TextEncoder().encode(msg).length;
  if(msg.length>CHAR_LIMIT){ addMessage("系统",`消息超过 ${CHAR_LIMIT} 字符限制，未发送`,"system",true); chatInput.value=""; return; }
  if(bytes>BYTE_LIMIT){ addMessage("系统","消息过长（超过 48KB），未发送","system",true); chatInput.value=""; return; }
  if(!ws || ws.readyState!==WebSocket.OPEN){ addMessage("系统","尚未连接，消息未发送","system",true); return; }
  try{ 
    ws.send(JSON.stringify({message:msg})); 
    chatInput.value=""; 
    chatInput.focus(); // ⬅️ 新增：重新将焦点设置回输入框
  }catch(e){ 
    addMessage("系统","发送失败，请重试","system",true); 
  }
}
chatInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); onSendBtnClick(); } });

window.joinAs=(display,room)=>{ document.getElementById("name-input").value=display||""; document.getElementById("room-input").value=room||""; document.getElementById("join-public").click(); };
</script>
</body>
</html>